<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>リベ大総合クリニック 患者分析システム</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background-color: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .upload-area {
            background-color: #fff;
            border: 2px dashed #3498db;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .upload-area:hover {
            border-color: #2980b9;
            background-color: #f8f9fa;
        }
        
        .upload-area.dragover {
            background-color: #e3f2fd;
            border-color: #1976d2;
        }
        
        .controls {
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: none;
        }
        
        .date-selector {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .date-selector label {
            font-weight: bold;
            color: #555;
        }
        
        .date-selector input[type="month"] {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            display: none;
        }
        
        .summary-card {
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .summary-card h3 {
            color: #555;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .summary-card .value {
            font-size: 32px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .summary-card .sub-value {
            font-size: 14px;
            color: #7f8c8d;
            margin-top: 5px;
        }
        
        .summary-card.pure {
            border-left: 4px solid #3498db;
        }
        
        .summary-card.re {
            border-left: 4px solid #2ecc71;
        }
        
        .summary-card.total {
            border-left: 4px solid #e74c3c;
        }
        
        .summary-card.rate {
            border-left: 4px solid #f39c12;
        }
        
        .chart-container {
            background-color: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: none;
            position: relative;
        }
        
        .chart-container h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 20px;
        }
        
        .chart-wrapper {
            position: relative;
            height: 400px;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #ecf0f1;
            display: none;
        }
        
        .period-comparison-container {
            display: none;
            background-color: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .period-selector {
            display: flex;
            gap: 30px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .period-input {
            flex: 1;
            min-width: 250px;
        }
        
        .period-input h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .period-input select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .period-month-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .comparison-results {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .comparison-card {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        
        .comparison-card h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .comparison-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #ecf0f1;
        }
        
        .comparison-row:last-child {
            border-bottom: none;
        }
        
        .comparison-label {
            color: #555;
        }
        
        .comparison-value {
            font-weight: bold;
            color: #2c3e50;
        }
        
        .tab {
            padding: 10px 20px;
            background-color: transparent;
            border: none;
            font-size: 16px;
            cursor: pointer;
            color: #7f8c8d;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        
        .tab:hover {
            color: #2c3e50;
        }
        
        .tab.active {
            color: #3498db;
            border-bottom-color: #3498db;
        }
        
        .regional-table {
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: none;
            overflow-x: auto;
        }
        
        .regional-table table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .regional-table th,
        .regional-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
        }
        
        .regional-table th {
            background-color: #f8f9fa;
            font-weight: bold;
            color: #2c3e50;
            position: sticky;
            top: 0;
        }
        
        .regional-table tr:hover {
            background-color: #f8f9fa;
        }
        
        .increase {
            color: #2ecc71;
            font-weight: bold;
        }
        
        .decrease {
            color: #e74c3c;
            font-weight: bold;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            background-color: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }
        
        #fileInput {
            display: none;
        }
        
        .export-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: flex-end;
        }
        
        .export-button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .export-pdf {
            background-color: #e74c3c;
            color: white;
        }
        
        .export-pdf:hover {
            background-color: #c0392b;
        }
        
        .export-excel {
            background-color: #27ae60;
            color: white;
        }
        
        .export-excel:hover {
            background-color: #229954;
        }
        
        .threshold-settings {
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: none;
        }
        
        .threshold-input {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        
        .threshold-input input {
            width: 80px;
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .warning-indicator {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 5px;
        }
        
        .warning-low {
            background-color: #fee;
            color: #c33;
            border: 1px solid #fcc;
        }
        
        .warning-medium {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>リベ大総合クリニック 患者分析システム</h1>
            <p>CSVファイルをドラッグ&ドロップまたはクリックして選択してください</p>
        </div>
        
        <div class="error-message" id="errorMessage"></div>
        
        <div class="upload-area" id="uploadArea">
            <p>📁 CSVファイルをここにドロップ</p>
            <p style="margin-top: 10px; font-size: 14px; color: #7f8c8d;">または クリックしてファイルを選択</p>
        </div>
        
        <input type="file" id="fileInput" accept=".csv">
        
        <div id="dataInfo" style="display: none; background-color: #fff; padding: 15px; border-radius: 5px; margin: 20px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <p style="margin: 0; color: #2c3e50;">現在のデータ: <span id="dataCount" style="font-weight: bold;">0</span>件</p>
            <button onclick="clearData()" style="margin-top: 10px; padding: 5px 15px; background-color: #e74c3c; color: white; border: none; border-radius: 3px; cursor: pointer;">データをクリア</button>
        </div>
        
        <div class="controls" id="controls">
            <div class="date-selector">
                <label for="startMonth">開始月：</label>
                <input type="month" id="startMonth" min="2023-04">
                
                <label for="endMonth">終了月：</label>
                <input type="month" id="endMonth">
                
                <button onclick="updateAnalysis()" style="padding: 8px 20px; background-color: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer;">期間を更新</button>
                
                <div style="margin-top: 10px;">
                    <span style="margin-right: 10px;">クイック選択：</span>
                    <button onclick="selectLastMonth()" style="padding: 5px 10px; margin-right: 5px; background-color: #95a5a6; color: white; border: none; border-radius: 3px; cursor: pointer;">先月</button>
                    <button onclick="selectThisYear()" style="padding: 5px 10px; margin-right: 5px; background-color: #95a5a6; color: white; border: none; border-radius: 3px; cursor: pointer;">今年</button>
                    <button onclick="selectLastYear()" style="padding: 5px 10px; margin-right: 5px; background-color: #95a5a6; color: white; border: none; border-radius: 3px; cursor: pointer;">昨年</button>
                    <button onclick="selectLast3Months()" style="padding: 5px 10px; margin-right: 5px; background-color: #95a5a6; color: white; border: none; border-radius: 3px; cursor: pointer;">過去3ヶ月</button>
                    <button onclick="selectLast6Months()" style="padding: 5px 10px; margin-right: 5px; background-color: #95a5a6; color: white; border: none; border-radius: 3px; cursor: pointer;">過去6ヶ月</button>
                    <button onclick="selectAll()" style="padding: 5px 10px; background-color: #95a5a6; color: white; border: none; border-radius: 3px; cursor: pointer;">全期間</button>
                </div>
            </div>
            <div class="export-buttons">
                <button class="export-button export-pdf" onclick="exportToPDF()">PDFで出力</button>
                <button class="export-button export-excel" onclick="exportToExcel()">Excelで出力</button>
                <button class="export-button" onclick="generateSummaryReport()" style="background-color: #8e44ad; color: white;">サマリーレポート生成</button>
            </div>
        </div>
        
        <div class="loading" id="loading">
            <div class="loading-spinner"></div>
            <p style="margin-top: 20px;">データを分析中...</p>
        </div>
        
        <div class="summary-cards" id="summaryCards">
            <div class="period-info" style="grid-column: 1 / -1; background-color: #2c3e50; color: white; padding: 20px; border-radius: 10px; text-align: center; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                <h2 style="margin: 0; font-size: 24px; font-weight: bold;" id="currentPeriodDisplay">データを読み込んでください</h2>
                <p style="margin: 5px 0 0 0; font-size: 14px; opacity: 0.8;">選択期間の最終月のデータを表示しています</p>
            </div>
            
            <div class="summary-card pure">
                <h3>純初診（新規患者）</h3>
                <div class="value" id="pureFirstValue">-</div>
                <div class="sub-value" id="pureFirstChange">-</div>
            </div>
            
            <div class="summary-card re">
                <h3>再初診（既存患者の新症状）</h3>
                <div class="value" id="reFirstValue">-</div>
                <div class="sub-value" id="reFirstChange">-</div>
            </div>
            
            <div class="summary-card total">
                <h3>初診合計</h3>
                <div class="value" id="totalFirstValue">-</div>
                <div class="sub-value" id="totalFirstChange">-</div>
            </div>
            
            <div class="summary-card rate">
                <h3>純初診率</h3>
                <div class="value" id="pureRateValue">-</div>
                <div class="sub-value" id="pureRateChange">-</div>
            </div>
            
            <div class="summary-card rate" style="border-left-color: #9b59b6;">
                <h3>再初診率</h3>
                <div class="value" id="reRateValue">-</div>
                <div class="sub-value" id="reRateChange">-</div>
            </div>
            
            <div class="summary-card return" style="border-left-color: #e74c3c;">
                <h3>再診</h3>
                <div class="value" id="returnValue">-</div>
                <div class="sub-value" id="returnChange">-</div>
            </div>
            
            <div class="summary-card total-all" style="border-left-color: #34495e;">
                <h3>全患者数</h3>
                <div class="value" id="totalAllValue">-</div>
                <div class="sub-value" id="totalAllChange">-</div>
            </div>
            
            <div class="summary-card rate" style="border-left-color: #e74c3c;">
                <h3>再診率</h3>
                <div class="value" id="returnRateValue">-</div>
                <div class="sub-value" id="returnRateChange">-</div>
            </div>
        </div>
        
        <div class="tabs" id="tabs">
            <button class="tab active" onclick="switchTab('monthly')">月別推移</button>
            <button class="tab" onclick="switchTab('regional')">地域別分析</button>
            <button class="tab" onclick="switchTab('comparison')">前年・前月比較</button>
            <button class="tab" onclick="switchTab('ward')">大阪市区別詳細</button>
            <button class="tab" onclick="switchTab('periodComparison')">期間比較</button>
        </div>
        
        <div class="threshold-settings" id="thresholdSettings">
            <h3>純初診率警告閾値設定</h3>
            <div class="threshold-input">
                <label>低警告（赤）：</label>
                <input type="number" id="lowThreshold" value="40" min="0" max="100" step="1">
                <span>%以下</span>
                <label style="margin-left: 20px;">中警告（黄）：</label>
                <input type="number" id="mediumThreshold" value="50" min="0" max="100" step="1">
                <span>%以下</span>
                <button onclick="updateThresholds()" style="margin-left: 20px; padding: 5px 15px; background-color: #3498db; color: white; border: none; border-radius: 3px; cursor: pointer;">適用</button>
            </div>
        </div>
        
        <div class="chart-container" id="monthlyChart">
            <h2>月別 純初診・再初診推移</h2>
            <div style="display: flex; justify-content: space-between; align-items: center; margin: 10px 0;">
                <p style="font-size: 14px; color: #666; margin: 0;">
                    マウスホイールでズーム、ドラッグでパン操作が可能です。特定期間の詳細を分析できます。
                </p>
                <button onclick="resetZoom()" style="padding: 5px 15px; background-color: #95a5a6; color: white; border: none; border-radius: 3px; cursor: pointer;">ズームリセット</button>
            </div>
            <div class="chart-wrapper">
                <canvas id="monthlyCanvas"></canvas>
            </div>
        </div>
        
        <div class="chart-container" id="regionalChart" style="display: none;">
            <h2>地域別 患者分布</h2>
            <div style="text-align: right; margin-bottom: 10px;">
                <button id="regionalBarBtn" onclick="switchRegionalChart('bar')" style="padding: 5px 15px; margin-right: 5px; background-color: #3498db; color: white; border: none; border-radius: 3px; cursor: pointer;">棒グラフ</button>
                <button id="regionalPieBtn" onclick="switchRegionalChart('pie')" style="padding: 5px 15px; background-color: #ecf0f1; color: #333; border: none; border-radius: 3px; cursor: pointer;">円グラフ</button>
            </div>
            <div class="chart-wrapper">
                <canvas id="regionalCanvas"></canvas>
            </div>
        </div>
        
        <div class="chart-container" id="comparisonChart" style="display: none;">
            <h2>前年・前月比較</h2>
            <div class="chart-wrapper">
                <canvas id="comparisonCanvas"></canvas>
            </div>
        </div>
        
        <div class="chart-container" id="wardChart" style="display: none;">
            <h2>大阪市区別 純初診数推移</h2>
            <div class="chart-wrapper">
                <canvas id="wardCanvas"></canvas>
            </div>
        </div>
        
        <div class="period-comparison-container" id="periodComparisonContainer">
            <h2>期間比較分析</h2>
            <div class="period-selector">
                <div class="period-input">
                    <h3>期間1</h3>
                    <label>開始月：</label>
                    <input type="month" id="period1Start" class="period-month-input">
                    <label>終了月：</label>
                    <input type="month" id="period1End" class="period-month-input">
                </div>
                <div class="period-input">
                    <h3>期間2</h3>
                    <label>開始月：</label>
                    <input type="month" id="period2Start" class="period-month-input">
                    <label>終了月：</label>
                    <input type="month" id="period2End" class="period-month-input">
                </div>
            </div>
            <button onclick="comparePeriods()" style="padding: 10px 24px; background-color: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; margin-bottom: 20px;">期間を比較</button>
            
            <div class="comparison-results" id="comparisonResults">
                <!-- 動的に結果が挿入される -->
            </div>
        </div>
        
        <div class="regional-table" id="regionalTable">
            <h2>地域別詳細データ</h2>
            <table id="regionalTableContent">
                <thead>
                    <tr>
                        <th>地域</th>
                        <th>純初診</th>
                        <th>再初診</th>
                        <th>合計</th>
                        <th>純初診率</th>
                        <th>前月比</th>
                    </tr>
                </thead>
                <tbody id="regionalTableBody">
                </tbody>
            </table>
        </div>
    </div>
    
    <script>
        // グローバル変数
        let allData = [];
        let monthlyData = {};
        let currentChart = null;
        let regionalChartInstance = null;
        let comparisonChartInstance = null;
        let wardChartInstance = null;
        
        // 大阪市の区リスト
        const osakaWards = [
            '北区', '都島区', '福島区', '此花区', '中央区', '西区', '港区', '大正区',
            '天王寺区', '浪速区', '西淀川区', '淀川区', '東淀川区', '東成区', '生野区',
            '旭区', '城東区', '鶴見区', '阿倍野区', '住之江区', '住吉区', '東住吉区',
            '平野区', '西成区'
        ];
        
        // 大阪府内の主要都市
        const osakaCities = [
            '堺市', '東大阪市', '枚方市', '豊中市', '吹田市', '高槻市', '茨木市', '八尾市',
            '寝屋川市', '岸和田市', '和泉市', '守口市', '門真市', '松原市', '大東市',
            '箕面市', '羽曳野市', '摂津市', '富田林市', '河内長野市', '池田市', '泉大津市',
            '泉佐野市', '貝塚市', '藤井寺市', '泉南市', '柏原市', '交野市', '大阪狭山市', '阪南市'
        ];
        
        // ファイルアップロード処理
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        
        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });
        
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });
        
        // ファイル処理
        function handleFile(file) {
            if (!file.name.endsWith('.csv')) {
                showError('CSVファイルを選択してください');
                return;
            }
            
            showLoading(true);
            
            // グラフインスタンスをクリア
            if (currentChart) {
                currentChart.destroy();
                currentChart = null;
            }
            if (regionalChartInstance) {
                regionalChartInstance.destroy();
                regionalChartInstance = null;
            }
            if (comparisonChartInstance) {
                comparisonChartInstance.destroy();
                comparisonChartInstance = null;
            }
            if (wardChartInstance) {
                wardChartInstance.destroy();
                wardChartInstance = null;
            }
            
            Papa.parse(file, {
                header: true,
                encoding: 'Shift-JIS',
                dynamicTyping: true,
                skipEmptyLines: true,
                complete: function(results) {
                    try {
                        processData(results.data);
                    } catch (error) {
                        showError('データの処理中にエラーが発生しました: ' + error.message);
                        showLoading(false);
                    }
                },
                error: function(error) {
                    showError('ファイルの読み込みに失敗しました: ' + error.message);
                    showLoading(false);
                }
            });
        }
        
        // データ処理
        function processData(data) {
            // 既存データに新しいデータを追加（重複を避けるため）
            const existingKeys = new Set(allData.map(row => `${row['日付']}_${row['患者番号']}`));
            const newData = data.filter(row => !existingKeys.has(`${row['日付']}_${row['患者番号']}`));
            allData = [...allData, ...newData];
            
            // データ情報を更新
            document.getElementById('dataInfo').style.display = 'block';
            document.getElementById('dataCount').textContent = allData.length;
            
            // データ分析を実行
            analyzeData();
            
            // 日付範囲を設定（データ分析後に実行）
            setDateRange();
            
            // 処理が完了してからUIを表示（100ms遅延）
            setTimeout(() => {
                showLoading(false);
                
                // UIを表示
                document.getElementById('controls').style.display = 'block';
                document.getElementById('summaryCards').style.display = 'grid';
                document.getElementById('tabs').style.display = 'flex';
                document.getElementById('monthlyChart').style.display = 'block';
                document.getElementById('regionalTable').style.display = 'block';
                document.getElementById('thresholdSettings').style.display = 'block';
                
                // 表示を更新
                updateDisplay();
            }, 100);
        }
        
        // データ分析
        function analyzeData() {
            monthlyData = {};
            
            // 月ごとにグループ化
            allData.forEach(row => {
                if (!row['日付'] || !row['初診・再診']) return;
                
                // Parse date string (handle both YYYY/MM/DD and YYYY-MM-DD formats)
                const dateStr = row['日付'];
                let monthKey;
                
                if (dateStr.includes('/')) {
                    const parts = dateStr.split('/');
                    if (parts.length >= 2) {
                        monthKey = `${parts[0]}-${parts[1].padStart(2, '0')}`;
                    }
                } else if (dateStr.includes('-')) {
                    const parts = dateStr.split('-');
                    if (parts.length >= 2) {
                        monthKey = `${parts[0]}-${parts[1].padStart(2, '0')}`;
                    }
                } else {
                    // Fallback to Date constructor
                    const date = new Date(dateStr);
                    monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                }
                
                if (!monthKey || monthKey.includes('NaN')) return;
                
                if (!monthlyData[monthKey]) {
                    monthlyData[monthKey] = {
                        allRecords: [],
                        firstVisits: [],
                        returnVisits: [],
                        maxPatientNumber: 0
                    };
                }
                
                monthlyData[monthKey].allRecords.push(row);
                
                if (row['初診・再診'] === '初診') {
                    monthlyData[monthKey].firstVisits.push(row);
                } else if (row['初診・再診'] === '再診') {
                    monthlyData[monthKey].returnVisits.push(row);
                }
                
                if (row['患者番号'] > monthlyData[monthKey].maxPatientNumber) {
                    monthlyData[monthKey].maxPatientNumber = row['患者番号'];
                }
            });
            
            // 各月の境界番号を計算（前月の最大番号 + 1）
            const sortedMonths = Object.keys(monthlyData).sort();
            // 最初の月の最小患者番号-1を初期値とする
            let previousMax = 0;
            if (sortedMonths.length > 0) {
                const firstMonthData = monthlyData[sortedMonths[0]];
                let minPatientNumber = Number.MAX_SAFE_INTEGER;
                firstMonthData.allRecords.forEach(record => {
                    if (record['患者番号'] && record['患者番号'] < minPatientNumber) {
                        minPatientNumber = record['患者番号'];
                    }
                });
                previousMax = minPatientNumber > 1 ? minPatientNumber - 1 : 0;
            }
            
            sortedMonths.forEach((month, idx) => {
                // 通常の境界計算（前月の最大番号 + 1）
                monthlyData[month].boundary = previousMax + 1;
                
                // デバッグ用ログ
                if (month === '2024-08') {
                    console.log(`${month}: 境界=${monthlyData[month].boundary}, 前月最大=${previousMax}`);
                    console.log(`初診数: ${monthlyData[month].firstVisits.length}`);
                }
                
                previousMax = monthlyData[month].maxPatientNumber;
                
                // 純初診と再初診を分類
                const boundary = monthlyData[month].boundary;
                monthlyData[month].pureFirst = [];
                monthlyData[month].reFirst = [];
                
                // ユニーク患者で集計
                const processedPatients = new Set();
                
                monthlyData[month].firstVisits.forEach(record => {
                    const patientId = record['患者番号'];
                    if (!processedPatients.has(patientId)) {
                        processedPatients.add(patientId);
                        
                        if (patientId >= boundary) {
                            monthlyData[month].pureFirst.push(record);
                        } else {
                            monthlyData[month].reFirst.push(record);
                        }
                    }
                });
                
                // デバッグ用ログ（8月の純初診数）
                if (month === '2024-08') {
                    console.log(`純初診数: ${monthlyData[month].pureFirst.length}`);
                    console.log(`再初診数: ${monthlyData[month].reFirst.length}`);
                }
                
                // 地域別集計
                monthlyData[month].regional = analyzeRegional(monthlyData[month].pureFirst, monthlyData[month].reFirst);
            });
            
            updateDisplay();
        }
        
        // 地域分析
        function analyzeRegional(pureFirst, reFirst) {
            const regional = {
                pure: {},
                re: {}
            };
            
            // 大阪市各区の初期化
            osakaWards.forEach(ward => {
                regional.pure[ward] = 0;
                regional.re[ward] = 0;
            });
            
            // 大阪府内各市の初期化
            regional.pure['大阪府内その他'] = 0;
            regional.re['大阪府内その他'] = 0;
            
            // 純初診の地域別集計
            pureFirst.forEach(record => {
                const address = record['患者住所'] || '';
                const region = classifyAddress(address);
                
                if (!regional.pure[region]) {
                    regional.pure[region] = 0;
                }
                regional.pure[region]++;
            });
            
            // 再初診の地域別集計
            reFirst.forEach(record => {
                const address = record['患者住所'] || '';
                const region = classifyAddress(address);
                
                if (!regional.re[region]) {
                    regional.re[region] = 0;
                }
                regional.re[region]++;
            });
            
            return regional;
        }
        
        // 住所から地域を分類
        function classifyAddress(address) {
            if (!address) return 'その他';
            
            // 大阪市の区を判定
            for (const ward of osakaWards) {
                if (address.includes(`大阪市${ward}`)) {
                    return ward;
                }
            }
            
            // 大阪府内の市を判定
            for (const city of osakaCities) {
                if (address.includes(city)) {
                    return city;
                }
            }
            
            // 他府県
            const prefectures = {
                '兵庫県': ['兵庫県', '神戸市', '尼崎市', '西宮市', '芦屋市', '伊丹市', '宝塚市'],
                '京都府': ['京都府', '京都市', '宇治市', '亀岡市'],
                '東京都': ['東京都', '千代田区', '中央区', '港区', '新宿区', '文京区', '台東区', '墨田区', '江東区', '品川区', '目黒区', '大田区', '世田谷区', '渋谷区', '中野区', '杉並区', '豊島区', '北区', '荒川区', '板橋区', '練馬区', '足立区', '葛飾区', '江戸川区'],
                '奈良県': ['奈良県', '奈良市', '大和高田市', '大和郡山市'],
                '和歌山県': ['和歌山県', '和歌山市'],
                '滋賀県': ['滋賀県', '大津市', '草津市']
            };
            
            for (const [pref, keywords] of Object.entries(prefectures)) {
                for (const keyword of keywords) {
                    if (address.includes(keyword)) {
                        return pref;
                    }
                }
            }
            
            // 大阪府内のその他
            if (address.includes('大阪府') || address.includes('府')) {
                return '大阪府内その他';
            }
            
            return 'その他';
        }
        
        // 日付範囲を設定
        function setDateRange() {
            const months = Object.keys(monthlyData).sort();
            if (months.length > 0) {
                document.getElementById('startMonth').value = months[0];
                document.getElementById('endMonth').value = months[months.length - 1];
            }
        }
        
        // 表示更新
        function updateDisplay() {
            let startMonth = document.getElementById('startMonth').value;
            let endMonth = document.getElementById('endMonth').value;
            
            // 期間が設定されていない場合は、自動的に設定
            if (!startMonth || !endMonth) {
                setDateRange();
                startMonth = document.getElementById('startMonth').value;
                endMonth = document.getElementById('endMonth').value;
                
                if (!startMonth || !endMonth) {
                    showError('期間を設定してください');
                    return;
                }
            }
            
            const filteredMonths = Object.keys(monthlyData)
                .filter(month => month >= startMonth && month <= endMonth)
                .sort();
            
            if (filteredMonths.length === 0) {
                showError('選択された期間にデータがありません');
                return;
            }
            
            // サマリーカードを更新
            updateSummaryCards(filteredMonths);
            
            // グラフを更新
            updateMonthlyChart(filteredMonths);
            
            // 地域別テーブルを更新
            updateRegionalTable(filteredMonths);
        }
        
        // サマリーカード更新
        function updateSummaryCards(months) {
            const lastMonth = months[months.length - 1];
            const prevMonth = months.length > 1 ? months[months.length - 2] : null;
            const lastYearMonth = getLastYearMonth(lastMonth);
            
            // 表示月を更新
            const [year, mon] = lastMonth.split('-');
            document.getElementById('currentPeriodDisplay').textContent = `${year}年${parseInt(mon)}月のデータ`;
            
            const lastData = monthlyData[lastMonth];
            const pureCount = lastData.pureFirst.length;
            const reFirstCount = lastData.reFirst.length;
            const returnCount = lastData.returnVisits.length;
            const totalFirstVisits = pureCount + reFirstCount;
            const totalAllVisits = pureCount + reFirstCount + returnCount;
            
            // 全患者に対する割合
            const pureRateAll = totalAllVisits > 0 ? (pureCount / totalAllVisits * 100).toFixed(1) : 0;
            const reFirstRateAll = totalAllVisits > 0 ? (reFirstCount / totalAllVisits * 100).toFixed(1) : 0;
            const returnRateAll = totalAllVisits > 0 ? (returnCount / totalAllVisits * 100).toFixed(1) : 0;
            
            document.getElementById('pureFirstValue').textContent = pureCount.toLocaleString() + '人';
            document.getElementById('reFirstValue').textContent = reFirstCount.toLocaleString() + '人';
            document.getElementById('totalFirstValue').textContent = totalFirstVisits.toLocaleString() + '人';
            document.getElementById('pureRateValue').textContent = pureRateAll + '%';
            document.getElementById('reRateValue').textContent = reFirstRateAll + '%';
            document.getElementById('returnValue').textContent = returnCount.toLocaleString() + '人';
            document.getElementById('totalAllValue').textContent = totalAllVisits.toLocaleString() + '人';
            document.getElementById('returnRateValue').textContent = returnRateAll + '%';
            
            // 前月比・前年比を計算
            if (prevMonth && monthlyData[prevMonth]) {
                const prevData = monthlyData[prevMonth];
                const prevPure = prevData.pureFirst.length;
                const prevReFirst = prevData.reFirst.length;
                const prevReturn = prevData.returnVisits.length;
                const prevTotalFirst = prevPure + prevReFirst;
                const prevTotalAll = prevPure + prevReFirst + prevReturn;
                
                const [prevYear, prevMon] = prevMonth.split('-');
                const prevMonthLabel = `${prevYear}年${parseInt(prevMon)}月比`;
                
                document.getElementById('pureFirstChange').innerHTML = getChangeText(pureCount, prevPure, prevMonthLabel);
                document.getElementById('reFirstChange').innerHTML = getChangeText(reFirstCount, prevReFirst, prevMonthLabel);
                document.getElementById('totalFirstChange').innerHTML = getChangeText(totalFirstVisits, prevTotalFirst, prevMonthLabel);
                document.getElementById('returnChange').innerHTML = getChangeText(returnCount, prevReturn, prevMonthLabel);
                document.getElementById('totalAllChange').innerHTML = getChangeText(totalAllVisits, prevTotalAll, prevMonthLabel);
            } else {
                document.getElementById('pureFirstChange').textContent = '前月データなし';
                document.getElementById('reFirstChange').textContent = '前月データなし';
                document.getElementById('totalFirstChange').textContent = '前月データなし';
                document.getElementById('returnChange').textContent = '前月データなし';
                document.getElementById('totalAllChange').textContent = '前月データなし';
            }
            
            if (monthlyData[lastYearMonth]) {
                const lastYearData = monthlyData[lastYearMonth];
                const lastYearPure = lastYearData.pureFirst.length;
                const lastYearReFirst = lastYearData.reFirst.length;
                const lastYearReturn = lastYearData.returnVisits.length;
                const lastYearTotalAll = lastYearPure + lastYearReFirst + lastYearReturn;
                
                if (lastYearTotalAll > 0) {
                    const lastYearPureRate = (lastYearPure / lastYearTotalAll * 100).toFixed(1);
                    const lastYearReRate = (lastYearReFirst / lastYearTotalAll * 100).toFixed(1);
                    const lastYearReturnRate = (lastYearReturn / lastYearTotalAll * 100).toFixed(1);
                    
                    const pureRateChange = (parseFloat(pureRateAll) - parseFloat(lastYearPureRate)).toFixed(1);
                    const reRateChange = (parseFloat(reFirstRateAll) - parseFloat(lastYearReRate)).toFixed(1);
                    const returnRateChange = (parseFloat(returnRateAll) - parseFloat(lastYearReturnRate)).toFixed(1);
                    
                    const [lyYear, lyMon] = lastYearMonth.split('-');
                    const pureChangeClass = pureRateChange > 0 ? 'increase' : 'decrease';
                    const reChangeClass = reRateChange > 0 ? 'increase' : 'decrease';
                    const returnChangeClass = returnRateChange > 0 ? 'increase' : 'decrease';
                    
                    document.getElementById('pureRateChange').innerHTML = 
                        `${lyYear}年${parseInt(lyMon)}月比: <span class="${pureChangeClass}">${pureRateChange > 0 ? '+' : ''}${pureRateChange}pt</span>`;
                    document.getElementById('reRateChange').innerHTML = 
                        `${lyYear}年${parseInt(lyMon)}月比: <span class="${reChangeClass}">${reRateChange > 0 ? '+' : ''}${reRateChange}pt</span>`;
                    document.getElementById('returnRateChange').innerHTML = 
                        `${lyYear}年${parseInt(lyMon)}月比: <span class="${returnChangeClass}">${returnRateChange > 0 ? '+' : ''}${returnRateChange}pt</span>`;
                }
            } else {
                document.getElementById('pureRateChange').textContent = '前年同月データなし';
                document.getElementById('reRateChange').textContent = '前年同月データなし';
                document.getElementById('returnRateChange').textContent = '前年同月データなし';
            }
        }
        
        // 月別グラフ更新
        function updateMonthlyChart(months) {
            const ctx = document.getElementById('monthlyCanvas').getContext('2d');
            
            const labels = months.map(month => {
                const [year, mon] = month.split('-');
                return `${year}年${parseInt(mon)}月`;
            });
            
            const pureData = months.map(month => monthlyData[month].pureFirst.length);
            const reData = months.map(month => monthlyData[month].reFirst.length);
            const rateData = months.map(month => {
                const pure = monthlyData[month].pureFirst.length;
                const re = monthlyData[month].reFirst.length;
                const total = pure + re;
                return total > 0 ? (pure / total * 100).toFixed(1) : 0;
            });
            
            // 閾値を取得
            const lowThreshold = parseFloat(document.getElementById('lowThreshold').value);
            const mediumThreshold = parseFloat(document.getElementById('mediumThreshold').value);
            
            // 警告色の設定
            const lineColors = rateData.map(rate => {
                const rateValue = parseFloat(rate);
                if (rateValue <= lowThreshold) return '#e74c3c';
                if (rateValue <= mediumThreshold) return '#f39c12';
                return '#27ae60';
            });
            
            if (currentChart) {
                currentChart.destroy();
            }
            
            currentChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '純初診',
                            data: pureData,
                            backgroundColor: '#3498db',
                            yAxisID: 'y'
                        },
                        {
                            label: '再初診',
                            data: reData,
                            backgroundColor: '#2ecc71',
                            yAxisID: 'y'
                        },
                        {
                            label: '純初診率',
                            data: rateData,
                            type: 'line',
                            borderColor: lineColors,
                            backgroundColor: 'transparent',
                            yAxisID: 'y1',
                            borderWidth: 3,
                            tension: 0.1,
                            segment: {
                                borderColor: ctx => {
                                    const index = ctx.p0DataIndex;
                                    return lineColors[index];
                                }
                            }
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    aspectRatio: 2,
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: '患者数（人）'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            min: 0,
                            max: 100,
                            title: {
                                display: true,
                                text: '純初診率（%）'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.dataset.label === '純初診率') {
                                        label += context.parsed.y + '%';
                                    } else {
                                        label += context.parsed.y + '人';
                                    }
                                    return label;
                                }
                            }
                        },
                        zoom: {
                            zoom: {
                                wheel: {
                                    enabled: true,
                                },
                                pinch: {
                                    enabled: true
                                },
                                mode: 'x',
                            },
                            pan: {
                                enabled: true,
                                mode: 'x',
                            }
                        },
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            formatter: (value, ctx) => {
                                if (ctx.dataset.type === 'line') {
                                    const rate = parseFloat(value);
                                    if (rate <= lowThreshold) return value + '%⚠';
                                    if (rate <= mediumThreshold) return value + '%!';
                                    return value + '%';
                                }
                                return value;
                            },
                            color: (ctx) => {
                                if (ctx.dataset.type === 'line') {
                                    const value = parseFloat(ctx.dataset.data[ctx.dataIndex]);
                                    if (value <= lowThreshold) return '#e74c3c';
                                    if (value <= mediumThreshold) return '#f39c12';
                                    return '#27ae60';
                                }
                                return '#666';
                            },
                            font: {
                                weight: 'bold',
                                size: 10
                            }
                        }
                    }
                }
            });
        }
        
        // 地域別テーブル更新
        function updateRegionalTable(months) {
            const lastMonth = months[months.length - 1];
            const prevMonth = months.length > 1 ? months[months.length - 2] : null;
            
            const lastData = monthlyData[lastMonth].regional;
            const tbody = document.getElementById('regionalTableBody');
            tbody.innerHTML = '';
            
            // 全地域を集計
            const allRegions = new Set();
            Object.keys(lastData.pure).forEach(region => allRegions.add(region));
            Object.keys(lastData.re).forEach(region => allRegions.add(region));
            
            // 地域をソート（西区を最初に、その他の区、府内市町村、他府県の順）
            const sortedRegions = Array.from(allRegions).sort((a, b) => {
                if (a === '西区') return -1;
                if (b === '西区') return 1;
                if (osakaWards.includes(a) && !osakaWards.includes(b)) return -1;
                if (!osakaWards.includes(a) && osakaWards.includes(b)) return 1;
                return a.localeCompare(b);
            });
            
            sortedRegions.forEach(region => {
                const pure = lastData.pure[region] || 0;
                const re = lastData.re[region] || 0;
                const total = pure + re;
                
                if (total === 0) return; // データがない地域は表示しない
                
                const rate = total > 0 ? (pure / total * 100).toFixed(1) : 0;
                
                let prevChange = '-';
                if (prevMonth && monthlyData[prevMonth].regional) {
                    const prevPure = monthlyData[prevMonth].regional.pure[region] || 0;
                    const prevRe = monthlyData[prevMonth].regional.re[region] || 0;
                    const prevTotal = prevPure + prevRe;
                    
                    if (prevTotal > 0) {
                        const change = ((total - prevTotal) / prevTotal * 100).toFixed(1);
                        const changeClass = change > 0 ? 'increase' : 'decrease';
                        prevChange = `<span class="${changeClass}">${change > 0 ? '+' : ''}${change}%</span>`;
                    }
                }
                
                const row = `
                    <tr>
                        <td>${region}</td>
                        <td>${pure}</td>
                        <td>${re}</td>
                        <td>${total}</td>
                        <td>${rate}%</td>
                        <td>${prevChange}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }
        
        // タブ切り替え
        function switchTab(tabName) {
            // タブのアクティブ状態を更新
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // チャートの表示切り替え
            document.getElementById('monthlyChart').style.display = 'none';
            document.getElementById('regionalChart').style.display = 'none';
            document.getElementById('comparisonChart').style.display = 'none';
            document.getElementById('wardChart').style.display = 'none';
            document.getElementById('periodComparisonContainer').style.display = 'none';
            
            switch(tabName) {
                case 'monthly':
                    document.getElementById('monthlyChart').style.display = 'block';
                    break;
                case 'regional':
                    document.getElementById('regionalChart').style.display = 'block';
                    updateRegionalChart();
                    break;
                case 'comparison':
                    document.getElementById('comparisonChart').style.display = 'block';
                    updateComparisonChart();
                    break;
                case 'ward':
                    document.getElementById('wardChart').style.display = 'block';
                    updateWardChart();
                    break;
                case 'periodComparison':
                    document.getElementById('periodComparisonContainer').style.display = 'block';
                    break;
            }
        }
        
        // 地域別グラフの現在のタイプ
        let currentRegionalChartType = 'bar';
        
        // 地域別グラフ更新
        function updateRegionalChart(chartType = null) {
            if (chartType) {
                currentRegionalChartType = chartType;
            }
            
            const startMonth = document.getElementById('startMonth').value;
            const endMonth = document.getElementById('endMonth').value;
            
            const filteredMonths = Object.keys(monthlyData)
                .filter(month => month >= startMonth && month <= endMonth)
                .sort();
            
            if (filteredMonths.length === 0) return;
            
            // 期間全体の地域別集計
            const totalRegional = {};
            
            filteredMonths.forEach(month => {
                const monthRegional = monthlyData[month].regional;
                
                Object.keys(monthRegional.pure).forEach(region => {
                    if (!totalRegional[region]) {
                        totalRegional[region] = { pure: 0, re: 0 };
                    }
                    totalRegional[region].pure += monthRegional.pure[region];
                    totalRegional[region].re += monthRegional.re[region];
                });
            });
            
            // 上位地域を抽出
            const topRegions = Object.entries(totalRegional)
                .map(([region, data]) => ({
                    region,
                    total: data.pure + data.re,
                    pure: data.pure,
                    re: data.re
                }))
                .sort((a, b) => b.total - a.total)
                .slice(0, 15);
            
            const ctx = document.getElementById('regionalCanvas').getContext('2d');
            
            if (regionalChartInstance) {
                regionalChartInstance.destroy();
            }
            
            if (currentRegionalChartType === 'pie') {
                // 円グラフの場合
                const pieData = topRegions.map(r => r.total);
                const pieLabels = topRegions.map(r => `${r.region} (${r.total}人)`);
                const colors = [
                    '#3498db', '#2ecc71', '#e74c3c', '#f39c12', '#9b59b6',
                    '#1abc9c', '#34495e', '#e67e22', '#95a5a6', '#d35400',
                    '#c0392b', '#27ae60', '#2980b9', '#8e44ad', '#16a085'
                ];
                
                regionalChartInstance = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: pieLabels,
                        datasets: [{
                            data: pieData,
                            backgroundColor: colors.slice(0, topRegions.length)
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const region = topRegions[context.dataIndex];
                                        const percentage = ((region.total / topRegions.reduce((sum, r) => sum + r.total, 0)) * 100).toFixed(1);
                                        return [
                                            `${region.region}: ${region.total}人 (${percentage}%)`,
                                            `純初診: ${region.pure}人`,
                                            `再初診: ${region.re}人`
                                        ];
                                    }
                                }
                            }
                        }
                    }
                });
            } else {
                // 棒グラフの場合
                regionalChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: topRegions.map(r => r.region),
                        datasets: [
                            {
                                label: '純初診',
                                data: topRegions.map(r => r.pure),
                                backgroundColor: '#3498db'
                        },
                        {
                            label: '再初診',
                            data: topRegions.map(r => r.re),
                            backgroundColor: '#2ecc71'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: true
                        },
                        y: {
                            stacked: true,
                            title: {
                                display: true,
                                text: '患者数（人）'
                            }
                        }
                    }
                }
            });
            }
        }
        
        // 地域別グラフタイプ切り替え
        function switchRegionalChart(type) {
            // ボタンのスタイル更新
            if (type === 'bar') {
                document.getElementById('regionalBarBtn').style.backgroundColor = '#3498db';
                document.getElementById('regionalBarBtn').style.color = 'white';
                document.getElementById('regionalPieBtn').style.backgroundColor = '#ecf0f1';
                document.getElementById('regionalPieBtn').style.color = '#333';
            } else {
                document.getElementById('regionalPieBtn').style.backgroundColor = '#3498db';
                document.getElementById('regionalPieBtn').style.color = 'white';
                document.getElementById('regionalBarBtn').style.backgroundColor = '#ecf0f1';
                document.getElementById('regionalBarBtn').style.color = '#333';
            }
            
            updateRegionalChart(type);
        }
        
        // 前年・前月比較グラフ
        function updateComparisonChart() {
            const startMonth = document.getElementById('startMonth').value;
            const endMonth = document.getElementById('endMonth').value;
            
            const filteredMonths = Object.keys(monthlyData)
                .filter(month => month >= startMonth && month <= endMonth)
                .sort();
            
            if (filteredMonths.length === 0) return;
            
            const labels = [];
            const monthlyChange = [];
            const yearlyChange = [];
            
            filteredMonths.forEach(month => {
                const [year, mon] = month.split('-');
                labels.push(`${year}年${parseInt(mon)}月`);
                
                const currentTotal = monthlyData[month].pureFirst.length + monthlyData[month].reFirst.length;
                
                // 前月比
                const prevMonth = getPreviousMonth(month);
                if (monthlyData[prevMonth]) {
                    const prevTotal = monthlyData[prevMonth].pureFirst.length + monthlyData[prevMonth].reFirst.length;
                    const change = prevTotal > 0 ? ((currentTotal - prevTotal) / prevTotal * 100).toFixed(1) : 0;
                    monthlyChange.push(parseFloat(change));
                } else {
                    monthlyChange.push(null);
                }
                
                // 前年比
                const lastYearMonth = getLastYearMonth(month);
                if (monthlyData[lastYearMonth]) {
                    const lastYearTotal = monthlyData[lastYearMonth].pureFirst.length + monthlyData[lastYearMonth].reFirst.length;
                    const change = lastYearTotal > 0 ? ((currentTotal - lastYearTotal) / lastYearTotal * 100).toFixed(1) : 0;
                    yearlyChange.push(parseFloat(change));
                } else {
                    yearlyChange.push(null);
                }
            });
            
            const ctx = document.getElementById('comparisonCanvas').getContext('2d');
            
            if (comparisonChartInstance) {
                comparisonChartInstance.destroy();
            }
            
            comparisonChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '前月比（%）',
                            data: monthlyChange,
                            borderColor: '#3498db',
                            backgroundColor: 'transparent',
                            borderWidth: 2,
                            tension: 0.1
                        },
                        {
                            label: '前年同月比（%）',
                            data: yearlyChange,
                            borderColor: '#e74c3c',
                            backgroundColor: 'transparent',
                            borderWidth: 2,
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: '変化率（%）'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y.toFixed(1) + '%';
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // 大阪市区別グラフ
        function updateWardChart() {
            const startMonth = document.getElementById('startMonth').value;
            const endMonth = document.getElementById('endMonth').value;
            
            const filteredMonths = Object.keys(monthlyData)
                .filter(month => month >= startMonth && month <= endMonth)
                .sort();
            
            if (filteredMonths.length === 0) return;
            
            // 主要区のみ表示（上位6区）
            const wardTotals = {};
            
            filteredMonths.forEach(month => {
                const monthRegional = monthlyData[month].regional;
                osakaWards.forEach(ward => {
                    if (!wardTotals[ward]) wardTotals[ward] = 0;
                    wardTotals[ward] += (monthRegional.pure[ward] || 0);
                });
            });
            
            const topWards = Object.entries(wardTotals)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 6)
                .map(([ward]) => ward);
            
            const labels = filteredMonths.map(month => {
                const [year, mon] = month.split('-');
                return `${parseInt(mon)}月`;
            });
            
            const datasets = topWards.map((ward, index) => {
                const data = filteredMonths.map(month => 
                    monthlyData[month].regional.pure[ward] || 0
                );
                
                const colors = [
                    '#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6', '#34495e'
                ];
                
                return {
                    label: ward,
                    data: data,
                    borderColor: colors[index % colors.length],
                    backgroundColor: 'transparent',
                    borderWidth: 2,
                    tension: 0.1
                };
            });
            
            const ctx = document.getElementById('wardCanvas').getContext('2d');
            
            if (wardChartInstance) {
                wardChartInstance.destroy();
            }
            
            wardChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '純初診数（人）'
                            }
                        }
                    }
                }
            });
        }
        
        // ユーティリティ関数
        function getPreviousMonth(monthStr) {
            const [year, month] = monthStr.split('-').map(Number);
            const date = new Date(year, month - 2, 1); // month - 1 - 1
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        }
        
        function getLastYearMonth(monthStr) {
            const [year, month] = monthStr.split('-').map(Number);
            return `${year - 1}-${String(month).padStart(2, '0')}`;
        }
        
        function getChangeText(current, previous, label) {
            if (previous === 0) return label + ': -';
            const change = ((current - previous) / previous * 100).toFixed(1);
            const sign = change > 0 ? '+' : '';
            const className = change > 0 ? 'increase' : 'decrease';
            return `${label}: <span class="${className}">${sign}${change}%</span>`;
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }
        
        // ズームリセット関数
        function resetZoom() {
            if (currentChart) {
                currentChart.resetZoom();
            }
        }
        
        // クイック選択関数
        function selectLastMonth() {
            const months = Object.keys(monthlyData).sort();
            if (months.length > 0) {
                const lastMonth = months[months.length - 1];
                document.getElementById('startMonth').value = lastMonth;
                document.getElementById('endMonth').value = lastMonth;
                updateAnalysis();
            }
        }
        
        function selectThisYear() {
            const currentYear = new Date().getFullYear();
            const months = Object.keys(monthlyData).filter(m => m.startsWith(currentYear + '-')).sort();
            if (months.length > 0) {
                document.getElementById('startMonth').value = months[0];
                document.getElementById('endMonth').value = months[months.length - 1];
                updateAnalysis();
            }
        }
        
        function selectLastYear() {
            const lastYear = new Date().getFullYear() - 1;
            const months = Object.keys(monthlyData).filter(m => m.startsWith(lastYear + '-')).sort();
            if (months.length > 0) {
                document.getElementById('startMonth').value = months[0];
                document.getElementById('endMonth').value = months[months.length - 1];
                updateAnalysis();
            }
        }
        
        function selectLast3Months() {
            const months = Object.keys(monthlyData).sort();
            if (months.length > 0) {
                const endMonth = months[months.length - 1];
                const startIdx = Math.max(0, months.length - 3);
                document.getElementById('startMonth').value = months[startIdx];
                document.getElementById('endMonth').value = endMonth;
                updateAnalysis();
            }
        }
        
        function selectLast6Months() {
            const months = Object.keys(monthlyData).sort();
            if (months.length > 0) {
                const endMonth = months[months.length - 1];
                const startIdx = Math.max(0, months.length - 6);
                document.getElementById('startMonth').value = months[startIdx];
                document.getElementById('endMonth').value = endMonth;
                updateAnalysis();
            }
        }
        
        function selectAll() {
            const months = Object.keys(monthlyData).sort();
            if (months.length > 0) {
                document.getElementById('startMonth').value = months[0];
                document.getElementById('endMonth').value = months[months.length - 1];
                updateAnalysis();
            }
        }
        
        // データクリア関数
        function clearData() {
            if (confirm('すべてのデータをクリアしますか？')) {
                // データをクリア
                allData = [];
                monthlyData = {};
                
                // グラフインスタンスをクリア
                if (currentChart) {
                    currentChart.destroy();
                    currentChart = null;
                }
                if (regionalChartInstance) {
                    regionalChartInstance.destroy();
                    regionalChartInstance = null;
                }
                if (comparisonChartInstance) {
                    comparisonChartInstance.destroy();
                    comparisonChartInstance = null;
                }
                if (wardChartInstance) {
                    wardChartInstance.destroy();
                    wardChartInstance = null;
                }
                
                // UIを非表示
                document.getElementById('controls').style.display = 'none';
                document.getElementById('summaryCards').style.display = 'none';
                document.getElementById('tabs').style.display = 'none';
                document.getElementById('monthlyChart').style.display = 'none';
                document.getElementById('regionalChart').style.display = 'none';
                document.getElementById('comparisonChart').style.display = 'none';
                document.getElementById('wardChart').style.display = 'none';
                document.getElementById('regionalTable').style.display = 'none';
                document.getElementById('thresholdSettings').style.display = 'none';
                document.getElementById('periodComparisonContainer').style.display = 'none';
                document.getElementById('dataInfo').style.display = 'none';
                
                // ファイル入力をリセット
                document.getElementById('fileInput').value = '';
            }
        }
        
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }
        
        // 分析更新ボタン
        function updateAnalysis() {
            updateDisplay();
        }
        
        // 期間比較機能
        function comparePeriods() {
            const period1Start = document.getElementById('period1Start').value;
            const period1End = document.getElementById('period1End').value;
            const period2Start = document.getElementById('period2Start').value;
            const period2End = document.getElementById('period2End').value;
            
            if (!period1Start || !period1End || !period2Start || !period2End) {
                showError('すべての期間を選択してください');
                return;
            }
            
            // 期間1のデータ集計
            const period1Data = calculatePeriodData(period1Start, period1End);
            // 期間2のデータ集計
            const period2Data = calculatePeriodData(period2Start, period2End);
            
            // 結果表示
            displayComparisonResults(period1Data, period2Data, period1Start, period1End, period2Start, period2End);
        }
        
        // 期間データ集計
        function calculatePeriodData(startMonth, endMonth) {
            let totalPure = 0;
            let totalRe = 0;
            let monthCount = 0;
            const regionalData = {};
            
            Object.keys(monthlyData).forEach(month => {
                if (month >= startMonth && month <= endMonth) {
                    monthCount++;
                    totalPure += monthlyData[month].pureFirst.length;
                    totalRe += monthlyData[month].reFirst.length;
                    
                    // 地域別集計
                    const monthRegional = monthlyData[month].regional;
                    Object.keys(monthRegional.pure).forEach(region => {
                        if (!regionalData[region]) {
                            regionalData[region] = { pure: 0, re: 0 };
                        }
                        regionalData[region].pure += monthRegional.pure[region];
                        regionalData[region].re += monthRegional.re[region];
                    });
                    Object.keys(monthRegional.re).forEach(region => {
                        if (!regionalData[region]) {
                            regionalData[region] = { pure: 0, re: 0 };
                        }
                        regionalData[region].re += monthRegional.re[region];
                    });
                }
            });
            
            const total = totalPure + totalRe;
            const pureRate = total > 0 ? (totalPure / total * 100).toFixed(1) : 0;
            const avgPure = monthCount > 0 ? Math.round(totalPure / monthCount) : 0;
            const avgRe = monthCount > 0 ? Math.round(totalRe / monthCount) : 0;
            
            return {
                totalPure,
                totalRe,
                total,
                pureRate,
                avgPure,
                avgRe,
                monthCount,
                regionalData
            };
        }
        
        // 比較結果表示
        function displayComparisonResults(period1, period2, start1, end1, start2, end2) {
            const resultsDiv = document.getElementById('comparisonResults');
            
            // 期間1のフォーマット
            const formatPeriod = (start, end) => {
                const [startYear, startMonth] = start.split('-');
                const [endYear, endMonth] = end.split('-');
                return `${startYear}年${parseInt(startMonth)}月～${endYear}年${parseInt(endMonth)}月`;
            };
            
            // 差分計算
            const pureDiff = period2.totalPure - period1.totalPure;
            const reDiff = period2.totalRe - period1.totalRe;
            const totalDiff = period2.total - period1.total;
            const rateDiff = parseFloat(period2.pureRate) - parseFloat(period1.pureRate);
            
            // 変化率計算
            const pureChange = period1.totalPure > 0 ? ((pureDiff / period1.totalPure) * 100).toFixed(1) : '-';
            const reChange = period1.totalRe > 0 ? ((reDiff / period1.totalRe) * 100).toFixed(1) : '-';
            const totalChange = period1.total > 0 ? ((totalDiff / period1.total) * 100).toFixed(1) : '-';
            
            // HTML生成
            resultsDiv.innerHTML = `
                <div class="comparison-card">
                    <h4>期間1: ${formatPeriod(start1, end1)} (${period1.monthCount}ヶ月)</h4>
                    <div class="comparison-row">
                        <span class="comparison-label">純初診合計:</span>
                        <span class="comparison-value">${period1.totalPure.toLocaleString()}人</span>
                    </div>
                    <div class="comparison-row">
                        <span class="comparison-label">再初診合計:</span>
                        <span class="comparison-value">${period1.totalRe.toLocaleString()}人</span>
                    </div>
                    <div class="comparison-row">
                        <span class="comparison-label">初診合計:</span>
                        <span class="comparison-value">${period1.total.toLocaleString()}人</span>
                    </div>
                    <div class="comparison-row">
                        <span class="comparison-label">純初診率:</span>
                        <span class="comparison-value">${period1.pureRate}%</span>
                    </div>
                    <div class="comparison-row">
                        <span class="comparison-label">月平均純初診:</span>
                        <span class="comparison-value">${period1.avgPure.toLocaleString()}人</span>
                    </div>
                    <div class="comparison-row">
                        <span class="comparison-label">月平均再初診:</span>
                        <span class="comparison-value">${period1.avgRe.toLocaleString()}人</span>
                    </div>
                </div>
                
                <div class="comparison-card">
                    <h4>期間2: ${formatPeriod(start2, end2)} (${period2.monthCount}ヶ月)</h4>
                    <div class="comparison-row">
                        <span class="comparison-label">純初診合計:</span>
                        <span class="comparison-value">${period2.totalPure.toLocaleString()}人</span>
                    </div>
                    <div class="comparison-row">
                        <span class="comparison-label">再初診合計:</span>
                        <span class="comparison-value">${period2.totalRe.toLocaleString()}人</span>
                    </div>
                    <div class="comparison-row">
                        <span class="comparison-label">初診合計:</span>
                        <span class="comparison-value">${period2.total.toLocaleString()}人</span>
                    </div>
                    <div class="comparison-row">
                        <span class="comparison-label">純初診率:</span>
                        <span class="comparison-value">${period2.pureRate}%</span>
                    </div>
                    <div class="comparison-row">
                        <span class="comparison-label">月平均純初診:</span>
                        <span class="comparison-value">${period2.avgPure.toLocaleString()}人</span>
                    </div>
                    <div class="comparison-row">
                        <span class="comparison-label">月平均再初診:</span>
                        <span class="comparison-value">${period2.avgRe.toLocaleString()}人</span>
                    </div>
                </div>
                
                <div class="comparison-card" style="background-color: #e8f4f8; border: 2px solid #3498db;">
                    <h4>期間比較（期間2 - 期間1）</h4>
                    <div class="comparison-row">
                        <span class="comparison-label">純初診数変化:</span>
                        <span class="comparison-value ${pureDiff >= 0 ? 'increase' : 'decrease'}">
                            ${pureDiff >= 0 ? '+' : ''}${pureDiff.toLocaleString()}人 (${pureChange}%)
                        </span>
                    </div>
                    <div class="comparison-row">
                        <span class="comparison-label">再初診数変化:</span>
                        <span class="comparison-value ${reDiff >= 0 ? 'increase' : 'decrease'}">
                            ${reDiff >= 0 ? '+' : ''}${reDiff.toLocaleString()}人 (${reChange}%)
                        </span>
                    </div>
                    <div class="comparison-row">
                        <span class="comparison-label">初診合計変化:</span>
                        <span class="comparison-value ${totalDiff >= 0 ? 'increase' : 'decrease'}">
                            ${totalDiff >= 0 ? '+' : ''}${totalDiff.toLocaleString()}人 (${totalChange}%)
                        </span>
                    </div>
                    <div class="comparison-row">
                        <span class="comparison-label">純初診率変化:</span>
                        <span class="comparison-value ${rateDiff >= 0 ? 'increase' : 'decrease'}">
                            ${rateDiff >= 0 ? '+' : ''}${rateDiff.toFixed(1)}ポイント
                        </span>
                    </div>
                </div>
                
                <div class="comparison-card" style="grid-column: 1 / -1;">
                    <h4>地域別上位5地域の変化</h4>
                    ${generateRegionalComparison(period1.regionalData, period2.regionalData)}
                </div>
            `;
        }
        
        // 地域別比較生成
        function generateRegionalComparison(regional1, regional2) {
            // 期間2の合計でソート
            const sortedRegions = Object.keys(regional2)
                .map(region => ({
                    region,
                    total2: (regional2[region].pure || 0) + (regional2[region].re || 0),
                    total1: regional1[region] ? (regional1[region].pure || 0) + (regional1[region].re || 0) : 0
                }))
                .sort((a, b) => b.total2 - a.total2)
                .slice(0, 5);
            
            let html = '<table style="width: 100%; border-collapse: collapse;">';
            html += '<thead><tr style="background-color: #f8f9fa;">';
            html += '<th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">地域</th>';
            html += '<th style="padding: 10px; text-align: right; border-bottom: 2px solid #ddd;">期間1</th>';
            html += '<th style="padding: 10px; text-align: right; border-bottom: 2px solid #ddd;">期間2</th>';
            html += '<th style="padding: 10px; text-align: right; border-bottom: 2px solid #ddd;">変化</th>';
            html += '</tr></thead><tbody>';
            
            sortedRegions.forEach(item => {
                const change = item.total2 - item.total1;
                const changePercent = item.total1 > 0 ? ((change / item.total1) * 100).toFixed(1) : '-';
                html += '<tr>';
                html += `<td style="padding: 8px; border-bottom: 1px solid #eee;">${item.region}</td>`;
                html += `<td style="padding: 8px; text-align: right; border-bottom: 1px solid #eee;">${item.total1.toLocaleString()}人</td>`;
                html += `<td style="padding: 8px; text-align: right; border-bottom: 1px solid #eee;">${item.total2.toLocaleString()}人</td>`;
                html += `<td style="padding: 8px; text-align: right; border-bottom: 1px solid #eee;" class="${change >= 0 ? 'increase' : 'decrease'}">`;
                html += `${change >= 0 ? '+' : ''}${change.toLocaleString()}人 (${changePercent}%)`;
                html += '</td></tr>';
            });
            
            html += '</tbody></table>';
            return html;
        }
        
        // PDF出力機能
        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'pt', 'a4');
            
            // フォント設定（日本語対応）
            doc.setFont('helvetica');
            
            // タイトル
            doc.setFontSize(18);
            doc.text('リベ大総合クリニック 患者分析レポート', 40, 40);
            
            // 日付範囲
            const startMonth = document.getElementById('startMonth').value;
            const endMonth = document.getElementById('endMonth').value;
            
            if (!startMonth || !endMonth) {
                showError('期間を選択してください');
                return;
            }
            
            const [startYear, startMon] = startMonth.split('-');
            const [endYear, endMon] = endMonth.split('-');
            
            doc.setFontSize(12);
            doc.text(`分析期間: ${startYear}年${parseInt(startMon)}月～${endYear}年${parseInt(endMon)}月`, 40, 70);
            doc.text(`作成日: ${new Date().toLocaleDateString('ja-JP')}`, 40, 90);
            
            // サマリー情報
            const lastMonth = Object.keys(monthlyData).filter(m => m >= startMonth && m <= endMonth).sort().pop();
            if (lastMonth && monthlyData[lastMonth]) {
                const data = monthlyData[lastMonth];
                const pureCount = data.pureFirst.length;
                const reCount = data.reFirst.length;
                const totalCount = pureCount + reCount;
                const pureRate = totalCount > 0 ? (pureCount / totalCount * 100).toFixed(1) : 0;
                
                doc.setFontSize(14);
                doc.text('最終月サマリー', 40, 120);
                
                const summaryData = [
                    ['項目', '値'],
                    ['純初診数', `${pureCount}人`],
                    ['再初診数', `${reCount}人`],
                    ['初診合計', `${totalCount}人`],
                    ['純初診率', `${pureRate}%`]
                ];
                
                doc.autoTable({
                    startY: 140,
                    head: [summaryData[0]],
                    body: summaryData.slice(1),
                    theme: 'grid',
                    styles: { font: 'helvetica' }
                });
            }
            
            // 月別データ
            const monthlyTableData = [['月', '純初診', '再初診', '合計', '純初診率']];
            Object.keys(monthlyData)
                .filter(month => month >= startMonth && month <= endMonth)
                .sort()
                .forEach(month => {
                    const data = monthlyData[month];
                    const pure = data.pureFirst.length;
                    const re = data.reFirst.length;
                    const total = pure + re;
                    const rate = total > 0 ? (pure / total * 100).toFixed(1) : 0;
                    
                    const [year, mon] = month.split('-');
                    monthlyTableData.push([
                        `${year}年${parseInt(mon)}月`,
                        pure.toString(),
                        re.toString(),
                        total.toString(),
                        `${rate}%`
                    ]);
                });
            
            if (monthlyTableData.length > 1) {
                doc.addPage();
                doc.setFontSize(14);
                doc.text('月別推移データ', 40, 40);
                
                doc.autoTable({
                    startY: 60,
                    head: [monthlyTableData[0]],
                    body: monthlyTableData.slice(1),
                    theme: 'striped',
                    styles: { font: 'helvetica' }
                });
            }
            
            // PDFを保存
            const fileName = `患者分析レポート_${startMonth}_${endMonth}.pdf`;
            doc.save(fileName);
        }
        
        // Excel出力機能
        function exportToExcel() {
            const wb = XLSX.utils.book_new();
            
            // 日付範囲を取得
            const startMonth = document.getElementById('startMonth').value;
            const endMonth = document.getElementById('endMonth').value;
            
            if (!startMonth || !endMonth) {
                showError('期間を選択してください');
                return;
            }
            
            // サマリーシート作成
            const summaryData = [];
            summaryData.push(['リベ大総合クリニック 患者分析レポート']);
            summaryData.push([`分析期間: ${startMonth} ～ ${endMonth}`]);
            summaryData.push([`作成日: ${new Date().toLocaleDateString('ja-JP')}`]);
            summaryData.push([]);
            
            // 最終月サマリー
            const lastMonth = Object.keys(monthlyData).filter(m => m >= startMonth && m <= endMonth).sort().pop();
            if (lastMonth && monthlyData[lastMonth]) {
                const data = monthlyData[lastMonth];
                const pureCount = data.pureFirst.length;
                const reCount = data.reFirst.length;
                const totalCount = pureCount + reCount;
                const pureRate = totalCount > 0 ? (pureCount / totalCount * 100).toFixed(1) : 0;
                
                summaryData.push(['最終月サマリー']);
                summaryData.push(['項目', '値']);
                summaryData.push(['純初診数', `${pureCount}人`]);
                summaryData.push(['再初診数', `${reCount}人`]);
                summaryData.push(['初診合計', `${totalCount}人`]);
                summaryData.push(['純初診率', `${pureRate}%`]);
            }
            
            const summarySheet = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, summarySheet, 'サマリー');
            
            // 月別推移シート作成
            const monthlyData2 = [['年月', '純初診', '再初診', '合計', '純初診率']];
            Object.keys(monthlyData)
                .filter(month => month >= startMonth && month <= endMonth)
                .sort()
                .forEach(month => {
                    const data = monthlyData[month];
                    const pure = data.pureFirst.length;
                    const re = data.reFirst.length;
                    const total = pure + re;
                    const rate = total > 0 ? (pure / total * 100).toFixed(1) : 0;
                    
                    monthlyData2.push([month, pure, re, total, parseFloat(rate)]);
                });
            
            const monthlySheet = XLSX.utils.aoa_to_sheet(monthlyData2);
            XLSX.utils.book_append_sheet(wb, monthlySheet, '月別推移');
            
            // 地域別集計シート作成
            const regionalData = {};
            Object.keys(monthlyData)
                .filter(month => month >= startMonth && month <= endMonth)
                .forEach(month => {
                    const monthRegional = monthlyData[month].regional;
                    Object.keys(monthRegional.pure).forEach(region => {
                        if (!regionalData[region]) {
                            regionalData[region] = { pure: 0, re: 0 };
                        }
                        regionalData[region].pure += monthRegional.pure[region];
                    });
                    Object.keys(monthRegional.re).forEach(region => {
                        if (!regionalData[region]) {
                            regionalData[region] = { pure: 0, re: 0 };
                        }
                        regionalData[region].re += monthRegional.re[region];
                    });
                });
            
            const regionalArray = [['地域', '純初診', '再初診', '合計', '純初診率']];
            Object.entries(regionalData)
                .sort(([,a], [,b]) => (b.pure + b.re) - (a.pure + a.re))
                .forEach(([region, data]) => {
                    const total = data.pure + data.re;
                    const rate = total > 0 ? (data.pure / total * 100).toFixed(1) : 0;
                    regionalArray.push([region, data.pure, data.re, total, parseFloat(rate)]);
                });
            
            const regionalSheet = XLSX.utils.aoa_to_sheet(regionalArray);
            XLSX.utils.book_append_sheet(wb, regionalSheet, '地域別集計');
            
            // Excelファイルを保存
            const fileName = `患者分析レポート_${startMonth}_${endMonth}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }
        
        // 閾値更新
        function updateThresholds() {
            updateDisplay();
        }
        
        // サマリーレポート生成
        function generateSummaryReport() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'pt', 'a4');
            
            // 日付範囲
            const startMonth = document.getElementById('startMonth').value;
            const endMonth = document.getElementById('endMonth').value;
            
            if (!startMonth || !endMonth) {
                showError('期間を選択してください');
                return;
            }
            
            const [startYear, startMon] = startMonth.split('-');
            const [endYear, endMon] = endMonth.split('-');
            
            // タイトル
            doc.setFontSize(20);
            doc.text('患者分析サマリーレポート', 40, 40);
            
            doc.setFontSize(14);
            doc.text('リベ大総合クリニック', 40, 65);
            
            doc.setFontSize(12);
            doc.text(`分析期間: ${startYear}年${parseInt(startMon)}月～${endYear}年${parseInt(endMon)}月`, 40, 85);
            doc.text(`作成日: ${new Date().toLocaleDateString('ja-JP')}`, 40, 105);
            
            // 1. 期間概要
            doc.setFontSize(16);
            doc.text('1. 期間概要', 40, 140);
            
            const months = Object.keys(monthlyData)
                .filter(month => month >= startMonth && month <= endMonth)
                .sort();
            
            let totalPure = 0;
            let totalRe = 0;
            months.forEach(month => {
                totalPure += monthlyData[month].pureFirst.length;
                totalRe += monthlyData[month].reFirst.length;
            });
            const grandTotal = totalPure + totalRe;
            const avgPureRate = grandTotal > 0 ? (totalPure / grandTotal * 100).toFixed(1) : 0;
            
            doc.setFontSize(12);
            doc.text(`• 分析対象月数: ${months.length}ヶ月`, 60, 165);
            doc.text(`• 純初診総数: ${totalPure.toLocaleString()}人`, 60, 185);
            doc.text(`• 再初診総数: ${totalRe.toLocaleString()}人`, 60, 205);
            doc.text(`• 初診合計: ${grandTotal.toLocaleString()}人`, 60, 225);
            doc.text(`• 期間平均純初診率: ${avgPureRate}%`, 60, 245);
            
            // 2. 月別傾向分析
            doc.setFontSize(16);
            doc.text('2. 月別傾向分析', 40, 280);
            
            // 最高・最低純初診率
            let maxRate = 0;
            let minRate = 100;
            let maxMonth = '';
            let minMonth = '';
            
            months.forEach(month => {
                const data = monthlyData[month];
                const pure = data.pureFirst.length;
                const re = data.reFirst.length;
                const total = pure + re;
                const rate = total > 0 ? (pure / total * 100) : 0;
                
                if (rate > maxRate) {
                    maxRate = rate;
                    maxMonth = month;
                }
                if (rate < minRate) {
                    minRate = rate;
                    minMonth = month;
                }
            });
            
            doc.setFontSize(12);
            doc.text(`• 最高純初診率: ${maxRate.toFixed(1)}% (${maxMonth.replace('-', '年')}月)`, 60, 305);
            doc.text(`• 最低純初診率: ${minRate.toFixed(1)}% (${minMonth.replace('-', '年')}月)`, 60, 325);
            
            // 3. 地域別分析
            doc.setFontSize(16);
            doc.text('3. 地域別分析（上位5地域）', 40, 360);
            
            const regionalTotal = {};
            months.forEach(month => {
                const monthRegional = monthlyData[month].regional;
                Object.keys(monthRegional.pure).forEach(region => {
                    if (!regionalTotal[region]) {
                        regionalTotal[region] = { pure: 0, re: 0 };
                    }
                    regionalTotal[region].pure += monthRegional.pure[region];
                    regionalTotal[region].re += monthRegional.re[region];
                });
            });
            
            const topRegions = Object.entries(regionalTotal)
                .map(([region, data]) => ({
                    region,
                    total: data.pure + data.re,
                    pureRate: data.pure + data.re > 0 ? (data.pure / (data.pure + data.re) * 100).toFixed(1) : 0
                }))
                .sort((a, b) => b.total - a.total)
                .slice(0, 5);
            
            doc.setFontSize(12);
            let yPos = 385;
            topRegions.forEach((region, index) => {
                doc.text(`${index + 1}. ${region.region}: ${region.total.toLocaleString()}人 (純初診率: ${region.pureRate}%)`, 60, yPos);
                yPos += 20;
            });
            
            // 4. 改善提案
            doc.addPage();
            doc.setFontSize(16);
            doc.text('4. 改善提案', 40, 40);
            
            doc.setFontSize(12);
            const suggestions = [];
            
            if (parseFloat(avgPureRate) < 50) {
                suggestions.push('• 純初診率が50%を下回っています。新規患者獲得の施策を検討してください。');
            }
            
            if (minRate < 40) {
                suggestions.push('• 特定月の純初診率が40%を下回っています。季節要因の分析が必要です。');
            }
            
            const westWardData = regionalTotal['西区'];
            if (westWardData) {
                const westTotal = westWardData.pure + westWardData.re;
                const westPercentage = (westTotal / grandTotal * 100).toFixed(1);
                if (parseFloat(westPercentage) < 20) {
                    suggestions.push('• 地元（西区）からの患者比率が低い可能性があります。地域密着の施策を検討してください。');
                }
            }
            
            if (suggestions.length === 0) {
                suggestions.push('• 全体的に良好な数値を維持しています。現在の施策を継続してください。');
            }
            
            yPos = 65;
            suggestions.forEach(suggestion => {
                const lines = doc.splitTextToSize(suggestion, 500);
                doc.text(lines, 60, yPos);
                yPos += lines.length * 15 + 10;
            });
            
            // 5. 次期アクション
            doc.setFontSize(16);
            doc.text('5. 推奨アクション', 40, yPos + 30);
            
            doc.setFontSize(12);
            const actions = [
                '1. 月別の純初診率推移を定期的にモニタリング',
                '2. 低純初診率月の要因分析（季節性、キャンペーン効果等）',
                '3. 地域別マーケティング戦略の見直し',
                '4. 患者満足度調査による再初診要因の把握'
            ];
            
            yPos += 55;
            actions.forEach(action => {
                doc.text(action, 60, yPos);
                yPos += 20;
            });
            
            // PDFを保存
            const fileName = `サマリーレポート_${startMonth}_${endMonth}.pdf`;
            doc.save(fileName);
        }
    </script>
</body>
</html>