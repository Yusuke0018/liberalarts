<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒªãƒ™å¤§ç·åˆã‚¯ãƒªãƒ‹ãƒƒã‚¯ æ‚£è€…åˆ†æã‚·ã‚¹ãƒ†ãƒ </title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <!-- Removed date-fns as it was causing module export errors -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background-color: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .upload-area {
            background-color: #fff;
            border: 2px dashed #3498db;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .upload-area:hover {
            border-color: #2980b9;
            background-color: #f8f9fa;
        }
        
        .upload-area.dragover {
            background-color: #e3f2fd;
            border-color: #1976d2;
        }
        
        .controls {
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: none;
        }
        
        .date-selector {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .date-selector label {
            font-weight: bold;
            color: #555;
        }
        
        .date-selector input[type="month"] {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            display: none;
        }
        
        .summary-card {
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .summary-card h3 {
            color: #555;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .summary-card .value {
            font-size: 32px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .summary-card .sub-value {
            font-size: 14px;
            color: #7f8c8d;
            margin-top: 5px;
        }
        
        .summary-card.pure {
            border-left: 4px solid #3498db;
        }
        
        .summary-card.re {
            border-left: 4px solid #2ecc71;
        }
        
        .summary-card.total {
            border-left: 4px solid #e74c3c;
        }
        
        .summary-card.rate {
            border-left: 4px solid #f39c12;
        }
        
        .chart-container {
            background-color: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: none;
            position: relative;
        }
        
        .chart-container h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 20px;
        }
        
        .chart-wrapper {
            position: relative;
            height: 400px;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #ecf0f1;
            display: none;
        }
        
        .period-comparison-container {
            display: none;
            background-color: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .period-selector {
            display: flex;
            gap: 30px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .period-input {
            flex: 1;
            min-width: 250px;
        }
        
        .period-input h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .period-input select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .period-month-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .comparison-results {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .comparison-card {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        
        .comparison-card h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .comparison-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #ecf0f1;
        }
        
        .comparison-row:last-child {
            border-bottom: none;
        }
        
        .comparison-label {
            color: #555;
        }
        
        .comparison-value {
            font-weight: bold;
            color: #2c3e50;
        }
        
        .tab {
            padding: 10px 20px;
            background-color: transparent;
            border: none;
            font-size: 16px;
            cursor: pointer;
            color: #7f8c8d;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        
        .tab:hover {
            color: #2c3e50;
        }
        
        .tab.active {
            color: #3498db;
            border-bottom-color: #3498db;
        }
        
        .regional-table {
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: none;
            overflow-x: auto;
        }
        
        .regional-table table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .regional-table th,
        .regional-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
        }
        
        .regional-table th {
            background-color: #f8f9fa;
            font-weight: bold;
            color: #2c3e50;
            position: sticky;
            top: 0;
        }
        
        .regional-table tr:hover {
            background-color: #f8f9fa;
        }
        
        .increase {
            color: #2ecc71;
            font-weight: bold;
        }
        
        .decrease {
            color: #e74c3c;
            font-weight: bold;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            background-color: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }
        
        #fileInput {
            display: none;
        }
        
        
        .threshold-settings {
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: none;
        }
        
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ãƒªãƒ™å¤§ç·åˆã‚¯ãƒªãƒ‹ãƒƒã‚¯ æ‚£è€…åˆ†æã‚·ã‚¹ãƒ†ãƒ </h1>
            <p>CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠã—ã¦ãã ã•ã„</p>
        </div>
        
        <div class="error-message" id="errorMessage"></div>
        
        <div class="upload-area" id="uploadArea">
            <p>ğŸ“ CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã“ã“ã«ãƒ‰ãƒ­ãƒƒãƒ—</p>
            <p style="margin-top: 10px; font-size: 14px; color: #7f8c8d;">ã¾ãŸã¯ ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</p>
        </div>
        
        <input type="file" id="fileInput" accept=".csv">
        
        <div id="dataInfo" style="display: none; background-color: #fff; padding: 15px; border-radius: 5px; margin: 20px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <p style="margin: 0; color: #2c3e50;">ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿: <span id="dataCount" style="font-weight: bold;">0</span>ä»¶</p>
            <button onclick="clearData()" style="margin-top: 10px; padding: 5px 15px; background-color: #e74c3c; color: white; border: none; border-radius: 3px; cursor: pointer;">ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢</button>
        </div>
        
        <div class="controls" id="controls">
            <div class="date-selector">
                <label for="startMonth">é–‹å§‹æœˆï¼š</label>
                <input type="month" id="startMonth" min="2023-04">
                
                <label for="endMonth">çµ‚äº†æœˆï¼š</label>
                <input type="month" id="endMonth">
                
                <button onclick="updateAnalysis()" style="padding: 8px 20px; background-color: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer;">æœŸé–“ã‚’æ›´æ–°</button>
                
                <div style="margin-top: 10px;">
                    <span style="margin-right: 10px;">ã‚¯ã‚¤ãƒƒã‚¯é¸æŠï¼š</span>
                    <button onclick="selectLastMonth()" style="padding: 5px 10px; margin-right: 5px; background-color: #95a5a6; color: white; border: none; border-radius: 3px; cursor: pointer;">å…ˆæœˆ</button>
                    <button onclick="selectThisYear()" style="padding: 5px 10px; margin-right: 5px; background-color: #95a5a6; color: white; border: none; border-radius: 3px; cursor: pointer;">ä»Šå¹´</button>
                    <button onclick="selectLastYear()" style="padding: 5px 10px; margin-right: 5px; background-color: #95a5a6; color: white; border: none; border-radius: 3px; cursor: pointer;">æ˜¨å¹´</button>
                    <button onclick="selectLast3Months()" style="padding: 5px 10px; margin-right: 5px; background-color: #95a5a6; color: white; border: none; border-radius: 3px; cursor: pointer;">éå»3ãƒ¶æœˆ</button>
                    <button onclick="selectLast6Months()" style="padding: 5px 10px; margin-right: 5px; background-color: #95a5a6; color: white; border: none; border-radius: 3px; cursor: pointer;">éå»6ãƒ¶æœˆ</button>
                    <button onclick="selectAll()" style="padding: 5px 10px; background-color: #95a5a6; color: white; border: none; border-radius: 3px; cursor: pointer;">å…¨æœŸé–“</button>
                </div>
                
                <div style="margin-top: 10px;" id="monthButtons">
                    <span style="margin-right: 10px;">æœˆåˆ¥é¸æŠï¼š</span>
                    <!-- æœˆåˆ¥ãƒœã‚¿ãƒ³ã¯å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ -->
                </div>
            </div>
        </div>
        
        <div class="loading" id="loading">
            <div class="loading-spinner"></div>
            <p style="margin-top: 20px;">ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æä¸­...</p>
        </div>
        
        <div class="summary-cards" id="summaryCards">
            <div class="period-info" style="grid-column: 1 / -1; background-color: #2c3e50; color: white; padding: 20px; border-radius: 10px; text-align: center; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                <h2 style="margin: 0; font-size: 24px; font-weight: bold;" id="currentPeriodDisplay">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„</h2>
                <p style="margin: 5px 0 0 0; font-size: 14px; opacity: 0.8;">é¸æŠæœŸé–“ã®æœ€çµ‚æœˆã®ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™</p>
            </div>
            
            <div class="summary-card pure">
                <h3>ç´”åˆè¨ºï¼ˆæ–°è¦æ‚£è€…ï¼‰</h3>
                <div class="value" id="pureFirstValue">-</div>
                <div class="sub-value" id="pureFirstChange">-</div>
            </div>
            
            <div class="summary-card re">
                <h3>å†åˆè¨ºï¼ˆæ—¢å­˜æ‚£è€…ã®æ–°ç—‡çŠ¶ï¼‰</h3>
                <div class="value" id="reFirstValue">-</div>
                <div class="sub-value" id="reFirstChange">-</div>
            </div>
            
            <div class="summary-card total">
                <h3>åˆè¨ºåˆè¨ˆ</h3>
                <div class="value" id="totalFirstValue">-</div>
                <div class="sub-value" id="totalFirstChange">-</div>
            </div>
            
            <div class="summary-card rate">
                <h3>ç´”åˆè¨ºç‡</h3>
                <div class="value" id="pureRateValue">-</div>
                <div class="sub-value" id="pureRateChange">-</div>
            </div>
            
            <div class="summary-card rate" style="border-left-color: #9b59b6;">
                <h3>å†åˆè¨ºç‡</h3>
                <div class="value" id="reRateValue">-</div>
                <div class="sub-value" id="reRateChange">-</div>
            </div>
            
            <div class="summary-card return" style="border-left-color: #e74c3c;">
                <h3>å†è¨º</h3>
                <div class="value" id="returnValue">-</div>
                <div class="sub-value" id="returnChange">-</div>
            </div>
            
            <div class="summary-card total-all" style="border-left-color: #34495e;">
                <h3>å…¨æ‚£è€…æ•°</h3>
                <div class="value" id="totalAllValue">-</div>
                <div class="sub-value" id="totalAllChange">-</div>
            </div>
            
            <div class="summary-card rate" style="border-left-color: #e74c3c;">
                <h3>å†è¨ºç‡</h3>
                <div class="value" id="returnRateValue">-</div>
                <div class="sub-value" id="returnRateChange">-</div>
            </div>
        </div>
        
        <div class="tabs" id="tabs">
            <button class="tab active" onclick="switchTab('monthly')">æœˆåˆ¥æ¨ç§»</button>
            <button class="tab" onclick="switchTab('regional')">åœ°åŸŸåˆ¥åˆ†æ</button>
            <button class="tab" onclick="switchTab('comparison')">å‰å¹´ãƒ»å‰æœˆæ¯”è¼ƒ</button>
            <button class="tab" onclick="switchTab('ward')">å¤§é˜ªå¸‚åŒºåˆ¥è©³ç´°</button>
            <button class="tab" onclick="switchTab('periodComparison')">æœŸé–“æ¯”è¼ƒ</button>
        </div>
        
        
        <div class="chart-container" id="monthlyChart">
            <h2>æœˆåˆ¥ ç´”åˆè¨ºãƒ»å†åˆè¨ºæ¨ç§»</h2>
            <div style="display: flex; justify-content: space-between; align-items: center; margin: 10px 0;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <p style="font-size: 14px; color: #666; margin: 0;">
                        ãƒã‚¦ã‚¹ãƒ›ã‚¤ãƒ¼ãƒ«ã§ã‚ºãƒ¼ãƒ ã€ãƒ‰ãƒ©ãƒƒã‚°ã§ãƒ‘ãƒ³æ“ä½œãŒå¯èƒ½ã§ã™ã€‚
                    </p>
                    <select id="monthlyChartType" onchange="updateMonthlyChartDisplay()" style="padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
                        <option value="combined">çµ±åˆè¡¨ç¤º</option>
                        <option value="counts">æ¥é™¢æ•°ã®ã¿</option>
                        <option value="rates">æ¯”ç‡ã®ã¿</option>
                        <option value="pure">ç´”åˆè¨ºã®ã¿</option>
                        <option value="re">å†åˆè¨ºã®ã¿</option>
                    </select>
                </div>
                <button onclick="resetZoom()" style="padding: 5px 15px; background-color: #95a5a6; color: white; border: none; border-radius: 3px; cursor: pointer;">ã‚ºãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ</button>
            </div>
            <div class="chart-wrapper">
                <canvas id="monthlyCanvas"></canvas>
            </div>
        </div>
        
        <div class="chart-container" id="regionalChart" style="display: none;">
            <h2>åœ°åŸŸåˆ¥ ç´”åˆè¨ºãƒ»å†åˆè¨ºæ•°ã®æœˆåˆ¥æ¨ç§»</h2>
            <div style="display: flex; justify-content: space-between; align-items: center; margin: 10px 0;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <label for="regionSelect">åœ°åŸŸé¸æŠï¼š</label>
                    <select id="regionSelect" onchange="updateRegionalTrendChart()" style="padding: 5px 10px; border: 1px solid #ddd; border-radius: 3px;">
                        <option value="all">å…¨åœ°åŸŸ</option>
                    </select>
                    <select id="regionalChartType" onchange="updateRegionalTrendChart()" style="padding: 5px 10px; border: 1px solid #ddd; border-radius: 3px;">
                        <option value="combined">ç´”åˆè¨ºãƒ»å†åˆè¨ºä¸¡æ–¹</option>
                        <option value="pure">ç´”åˆè¨ºã®ã¿</option>
                        <option value="re">å†åˆè¨ºã®ã¿</option>
                    </select>
                </div>
                <button onclick="resetRegionalZoom()" style="padding: 5px 15px; background-color: #95a5a6; color: white; border: none; border-radius: 3px; cursor: pointer;">ã‚ºãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ</button>
            </div>
            <div class="chart-wrapper">
                <canvas id="regionalCanvas"></canvas>
            </div>
        </div>
        
        <div class="chart-container" id="comparisonChart" style="display: none;">
            <h2>å‰å¹´ãƒ»å‰æœˆæ¯”è¼ƒ</h2>
            <div class="chart-wrapper">
                <canvas id="comparisonCanvas"></canvas>
            </div>
        </div>
        
        <div class="chart-container" id="wardChart" style="display: none;">
            <h2>å¤§é˜ªå¸‚åŒºåˆ¥ ç´”åˆè¨ºæ•°æ¨ç§»</h2>
            <div class="chart-wrapper">
                <canvas id="wardCanvas"></canvas>
            </div>
        </div>
        
        <div class="period-comparison-container" id="periodComparisonContainer">
            <h2>æœŸé–“æ¯”è¼ƒåˆ†æ</h2>
            <div class="period-selector">
                <div class="period-input">
                    <h3>æœŸé–“1</h3>
                    <label>é–‹å§‹æœˆï¼š</label>
                    <input type="month" id="period1Start" class="period-month-input">
                    <label>çµ‚äº†æœˆï¼š</label>
                    <input type="month" id="period1End" class="period-month-input">
                </div>
                <div class="period-input">
                    <h3>æœŸé–“2</h3>
                    <label>é–‹å§‹æœˆï¼š</label>
                    <input type="month" id="period2Start" class="period-month-input">
                    <label>çµ‚äº†æœˆï¼š</label>
                    <input type="month" id="period2End" class="period-month-input">
                </div>
            </div>
            <button onclick="comparePeriods()" style="padding: 10px 24px; background-color: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; margin-bottom: 20px;">æœŸé–“ã‚’æ¯”è¼ƒ</button>
            
            <div class="comparison-results" id="comparisonResults">
                <!-- å‹•çš„ã«çµæœãŒæŒ¿å…¥ã•ã‚Œã‚‹ -->
            </div>
        </div>
        
        <div class="regional-table" id="regionalTable">
            <h2>åœ°åŸŸåˆ¥è©³ç´°ãƒ‡ãƒ¼ã‚¿</h2>
            <table id="regionalTableContent">
                <thead>
                    <tr>
                        <th>åœ°åŸŸ</th>
                        <th>ç´”åˆè¨º</th>
                        <th>å†åˆè¨º</th>
                        <th>åˆè¨ˆ</th>
                        <th>ç´”åˆè¨ºç‡</th>
                        <th>å‰æœˆæ¯”</th>
                    </tr>
                </thead>
                <tbody id="regionalTableBody">
                </tbody>
            </table>
        </div>
    </div>
    
    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let allData = [];
        let monthlyData = {};
        let currentChart = null;
        let regionalChartInstance = null;
        let comparisonChartInstance = null;
        let wardChartInstance = null;
        
        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
        function loadDataFromLocalStorage() {
            try {
                const savedData = localStorage.getItem('liberalArtsPatientData');
                if (savedData) {
                    allData = JSON.parse(savedData);
                    document.getElementById('dataInfo').style.display = 'block';
                    document.getElementById('dataCount').textContent = allData.length;
                    
                    // ãƒ‡ãƒ¼ã‚¿åˆ†æã‚’å®Ÿè¡Œ
                    analyzeData();
                    setDateRange();
                    
                    // UIã‚’è¡¨ç¤º
                    document.getElementById('controls').style.display = 'block';
                    document.getElementById('summaryCards').style.display = 'grid';
                    document.getElementById('tabs').style.display = 'flex';
                    document.getElementById('monthlyChart').style.display = 'block';
                    document.getElementById('regionalTable').style.display = 'block';
                    
                    // è¡¨ç¤ºã‚’æ›´æ–°
                    updateDisplay();
                    
                    console.log(`ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰${allData.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
                }
            } catch (error) {
                console.error('ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
        function saveDataToLocalStorage() {
            try {
                localStorage.setItem('liberalArtsPatientData', JSON.stringify(allData));
                console.log(`ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«${allData.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸ`);
            } catch (error) {
                console.error('ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã¸ã®ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                if (error.name === 'QuotaExceededError') {
                    showError('ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®å®¹é‡ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚å¤ã„ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¦ãã ã•ã„ã€‚');
                }
            }
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ
        window.addEventListener('load', () => {
            loadDataFromLocalStorage();
        });
        
        // å¤§é˜ªå¸‚ã®åŒºãƒªã‚¹ãƒˆ
        const osakaWards = [
            'åŒ—åŒº', 'éƒ½å³¶åŒº', 'ç¦å³¶åŒº', 'æ­¤èŠ±åŒº', 'ä¸­å¤®åŒº', 'è¥¿åŒº', 'æ¸¯åŒº', 'å¤§æ­£åŒº',
            'å¤©ç‹å¯ºåŒº', 'æµªé€ŸåŒº', 'è¥¿æ·€å·åŒº', 'æ·€å·åŒº', 'æ±æ·€å·åŒº', 'æ±æˆåŒº', 'ç”Ÿé‡åŒº',
            'æ—­åŒº', 'åŸæ±åŒº', 'é¶´è¦‹åŒº', 'é˜¿å€é‡åŒº', 'ä½ä¹‹æ±ŸåŒº', 'ä½å‰åŒº', 'æ±ä½å‰åŒº',
            'å¹³é‡åŒº', 'è¥¿æˆåŒº'
        ];
        
        // å¤§é˜ªåºœå†…ã®ä¸»è¦éƒ½å¸‚
        const osakaCities = [
            'å ºå¸‚', 'æ±å¤§é˜ªå¸‚', 'æšæ–¹å¸‚', 'è±Šä¸­å¸‚', 'å¹ç”°å¸‚', 'é«˜æ§»å¸‚', 'èŒ¨æœ¨å¸‚', 'å…«å°¾å¸‚',
            'å¯å±‹å·å¸‚', 'å²¸å’Œç”°å¸‚', 'å’Œæ³‰å¸‚', 'å®ˆå£å¸‚', 'é–€çœŸå¸‚', 'æ¾åŸå¸‚', 'å¤§æ±å¸‚',
            'ç®•é¢å¸‚', 'ç¾½æ›³é‡å¸‚', 'æ‘‚æ´¥å¸‚', 'å¯Œç”°æ—å¸‚', 'æ²³å†…é•·é‡å¸‚', 'æ± ç”°å¸‚', 'æ³‰å¤§æ´¥å¸‚',
            'æ³‰ä½é‡å¸‚', 'è²å¡šå¸‚', 'è—¤äº•å¯ºå¸‚', 'æ³‰å—å¸‚', 'æŸåŸå¸‚', 'äº¤é‡å¸‚', 'å¤§é˜ªç‹­å±±å¸‚', 'é˜ªå—å¸‚'
        ];
        
        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        
        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });
        
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });
        
        // ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†
        function handleFile(file) {
            if (!file.name.endsWith('.csv')) {
                showError('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            showLoading(true);
            
            // ã‚°ãƒ©ãƒ•ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ã‚¯ãƒªã‚¢
            if (currentChart) {
                currentChart.destroy();
                currentChart = null;
            }
            if (regionalChartInstance) {
                regionalChartInstance.destroy();
                regionalChartInstance = null;
            }
            if (comparisonChartInstance) {
                comparisonChartInstance.destroy();
                comparisonChartInstance = null;
            }
            if (wardChartInstance) {
                wardChartInstance.destroy();
                wardChartInstance = null;
            }
            
            // FileReaderã‚’ä½¿ã£ã¦UTF-8ã¨ã—ã¦èª­ã¿è¾¼ã‚€
            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                Papa.parse(text, {
                    header: true,
                    dynamicTyping: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        try {
                            processData(results.data);
                        } catch (error) {
                            showError('ãƒ‡ãƒ¼ã‚¿ã®å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
                            showLoading(false);
                        }
                    },
                    error: function(error) {
                        showError('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                        showLoading(false);
                    }
                });
            };
            reader.readAsText(file, 'UTF-8');
        }
        
        // ãƒ‡ãƒ¼ã‚¿å‡¦ç†
        function processData(data) {
            // ãƒ‡ãƒãƒƒã‚°: æœ€åˆã®è¡Œã®ã‚­ãƒ¼ã‚’ç¢ºèª
            if (data.length > 0) {
                console.log('CSVã®åˆ—å:', Object.keys(data[0]));
                console.log('å®Ÿéš›ã®åˆ—å:', JSON.stringify(Object.keys(data[0])));
                console.log('æœ€åˆã®ãƒ‡ãƒ¼ã‚¿è¡Œ:', data[0]);
                console.log('æœ€åˆã®ãƒ‡ãƒ¼ã‚¿è¡Œï¼ˆJSONï¼‰:', JSON.stringify(data[0], null, 2));
            }
            
            // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã«æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ï¼ˆé‡è¤‡ã‚’é¿ã‘ã‚‹ãŸã‚ï¼‰
            const existingKeys = new Set(allData.map(row => `${row['æ—¥ä»˜']}_${row['æ‚£è€…ç•ªå·']}`));
            const newData = data.filter(row => !existingKeys.has(`${row['æ—¥ä»˜']}_${row['æ‚£è€…ç•ªå·']}`));
            allData = [...allData, ...newData];
            
            // ãƒ‡ãƒ¼ã‚¿æƒ…å ±ã‚’æ›´æ–°
            document.getElementById('dataInfo').style.display = 'block';
            document.getElementById('dataCount').textContent = allData.length;
            
            // ãƒ‡ãƒ¼ã‚¿åˆ†æã‚’å®Ÿè¡Œ
            analyzeData();
            
            // æ—¥ä»˜ç¯„å›²ã‚’è¨­å®šï¼ˆãƒ‡ãƒ¼ã‚¿åˆ†æå¾Œã«å®Ÿè¡Œï¼‰
            setDateRange();
            
            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
            saveDataToLocalStorage();
            
            // å‡¦ç†ãŒå®Œäº†ã—ã¦ã‹ã‚‰UIã‚’è¡¨ç¤ºï¼ˆ100msé…å»¶ï¼‰
            setTimeout(() => {
                showLoading(false);
                
                // UIã‚’è¡¨ç¤º
                document.getElementById('controls').style.display = 'block';
                document.getElementById('summaryCards').style.display = 'grid';
                document.getElementById('tabs').style.display = 'flex';
                document.getElementById('monthlyChart').style.display = 'block';
                document.getElementById('regionalTable').style.display = 'block';
                
                // è¡¨ç¤ºã‚’æ›´æ–°
                updateDisplay();
            }, 100);
        }
        
        // ãƒ‡ãƒ¼ã‚¿åˆ†æ
        function analyzeData() {
            monthlyData = {};
            
            // æœˆã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
            let processedCount = 0;
            let errorCount = 0;
            
            allData.forEach((row, index) => {
                try {
                    if (!row['æ—¥ä»˜'] || !row['åˆè¨ºãƒ»å†è¨º']) {
                        errorCount++;
                        if (index < 5) { // æœ€åˆã®5è¡Œã ã‘ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›
                            console.log(`ã‚¨ãƒ©ãƒ¼è¡Œ ${index}:`, row);
                            console.log(`è¡Œã®ã‚­ãƒ¼:`, Object.keys(row));
                            console.log(`æ—¥ä»˜: ${row['æ—¥ä»˜']}, åˆè¨ºãƒ»å†è¨º: ${row['åˆè¨ºãƒ»å†è¨º']}`);
                            // ã™ã¹ã¦ã®åˆ—ã‚’è¡¨ç¤º
                            for (const [key, value] of Object.entries(row)) {
                                console.log(`  ${key}: ${value}`);
                            }
                        }
                        return;
                    }
                    
                    const date = new Date(row['æ—¥ä»˜']);
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    
                    if (!monthKey || monthKey.includes('NaN')) {
                        errorCount++;
                        console.error('ç„¡åŠ¹ãªæ—¥ä»˜:', row['æ—¥ä»˜']);
                        return;
                    }
                    
                    processedCount++;
                    
                    if (!monthlyData[monthKey]) {
                        monthlyData[monthKey] = {
                            allRecords: [],
                            firstVisits: [],
                            returnVisits: [],
                            maxPatientNumber: 0
                        };
                    }
                    
                    monthlyData[monthKey].allRecords.push(row);
                    
                    if (row['åˆè¨ºãƒ»å†è¨º'] === 'åˆè¨º') {
                        monthlyData[monthKey].firstVisits.push(row);
                        // åˆè¨ºã®æœ€å¤§æ‚£è€…ç•ªå·ã®ã¿ã‚’è¿½è·¡ï¼ˆå¢ƒç•Œè¨ˆç®—ç”¨ï¼‰
                        if (row['æ‚£è€…ç•ªå·'] > monthlyData[monthKey].maxPatientNumber) {
                            monthlyData[monthKey].maxPatientNumber = row['æ‚£è€…ç•ªå·'];
                        }
                    } else if (row['åˆè¨ºãƒ»å†è¨º'] === 'å†è¨º') {
                        monthlyData[monthKey].returnVisits.push(row);
                    }
                } catch (error) {
                    errorCount++;
                    console.error('ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error, row);
                }
            });
            
            console.log(`å‡¦ç†å®Œäº†: ${processedCount}ä»¶, ã‚¨ãƒ©ãƒ¼: ${errorCount}ä»¶`);
            
            // å„æœˆã®å¢ƒç•Œç•ªå·ã‚’è¨ˆç®—ï¼ˆå‰æœˆã®æœ€å¤§ç•ªå· + 1ï¼‰
            const sortedMonths = Object.keys(monthlyData).sort();
            // æœ€åˆã®æœˆã®æœ€å°æ‚£è€…ç•ªå·-1ã‚’åˆæœŸå€¤ã¨ã™ã‚‹
            let previousMax = 0;
            if (sortedMonths.length > 0) {
                const firstMonthData = monthlyData[sortedMonths[0]];
                let minPatientNumber = Number.MAX_SAFE_INTEGER;
                firstMonthData.allRecords.forEach(record => {
                    if (record['æ‚£è€…ç•ªå·'] && record['æ‚£è€…ç•ªå·'] < minPatientNumber) {
                        minPatientNumber = record['æ‚£è€…ç•ªå·'];
                    }
                });
                previousMax = minPatientNumber > 1 ? minPatientNumber - 1 : 0;
            }
            
            sortedMonths.forEach((month, idx) => {
                // é€šå¸¸ã®å¢ƒç•Œè¨ˆç®—ï¼ˆå‰æœˆã®æœ€å¤§ç•ªå· + 1ï¼‰
                monthlyData[month].boundary = previousMax + 1;
                
                // ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚°
                if (month === '2024-07' || month === '2024-08') {
                    console.log(`\n=== ${month} ===`);
                    console.log(`å¢ƒç•Œ: ${monthlyData[month].boundary}`);
                    console.log(`å‰æœˆã®åˆè¨ºæœ€å¤§: ${previousMax}`);
                    console.log(`å½“æœˆã®åˆè¨ºæœ€å¤§: ${monthlyData[month].maxPatientNumber}`);
                    console.log(`åˆè¨ºç·æ•°: ${monthlyData[month].firstVisits.length}`);
                    
                    if (month === '2024-08') {
                        // 8æœˆã®åˆè¨ºæ‚£è€…ç•ªå·ã®åˆ†å¸ƒã‚’ç¢ºèª
                        const patientNumbers = monthlyData[month].firstVisits.map(r => r['æ‚£è€…ç•ªå·']).sort((a, b) => a - b);
                        console.log(`8æœˆåˆè¨ºæ‚£è€…ç•ªå·ç¯„å›²: ${Math.min(...patientNumbers)} - ${Math.max(...patientNumbers)}`);
                        console.log(`8985ä»¥ä¸Šã®æ‚£è€…æ•°: ${patientNumbers.filter(n => n >= 8985).length}`);
                        console.log(`8985æœªæº€ã®æ‚£è€…æ•°: ${patientNumbers.filter(n => n < 8985).length}`);
                    }
                }
                
                previousMax = monthlyData[month].maxPatientNumber;
                
                // ç´”åˆè¨ºã¨å†åˆè¨ºã‚’åˆ†é¡
                const boundary = monthlyData[month].boundary;
                monthlyData[month].pureFirst = [];
                monthlyData[month].reFirst = [];
                
                // ãƒ¦ãƒ‹ãƒ¼ã‚¯æ‚£è€…ã§é›†è¨ˆ
                const processedPatients = new Set();
                
                monthlyData[month].firstVisits.forEach(record => {
                    const patientId = record['æ‚£è€…ç•ªå·'];
                    if (!processedPatients.has(patientId)) {
                        processedPatients.add(patientId);
                        
                        if (patientId >= boundary) {
                            monthlyData[month].pureFirst.push(record);
                        } else {
                            monthlyData[month].reFirst.push(record);
                        }
                    }
                });
                
                // ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚°ï¼ˆç´”åˆè¨ºãƒ»å†åˆè¨ºã®åˆ†é¡çµæœï¼‰
                if (month === '2024-07' || month === '2024-08') {
                    console.log(`${month} åˆ†é¡çµæœ - ç´”åˆè¨º: ${monthlyData[month].pureFirst.length}, å†åˆè¨º: ${monthlyData[month].reFirst.length}`);
                    
                    if (month === '2024-08' && monthlyData[month].pureFirst.length === 0) {
                        console.warn('è­¦å‘Š: 8æœˆã®ç´”åˆè¨ºãŒ0ä»¶ã§ã™ï¼');
                        // æœ€åˆã®5ä»¶ã®æ‚£è€…ç•ªå·ã¨å¢ƒç•Œã‚’æ¯”è¼ƒ
                        const first5 = monthlyData[month].firstVisits.slice(0, 5);
                        first5.forEach(record => {
                            console.log(`æ‚£è€…ç•ªå·: ${record['æ‚£è€…ç•ªå·']}, å¢ƒç•Œ: ${boundary}, åˆ¤å®š: ${record['æ‚£è€…ç•ªå·'] >= boundary ? 'ç´”åˆè¨º' : 'å†åˆè¨º'}`);
                        });
                    }
                }
                
                // åœ°åŸŸåˆ¥é›†è¨ˆ
                monthlyData[month].regional = analyzeRegional(monthlyData[month].pureFirst, monthlyData[month].reFirst);
            });
            
            updateDisplay();
        }
        
        // åœ°åŸŸåˆ†æ
        function analyzeRegional(pureFirst, reFirst) {
            const regional = {
                pure: {},
                re: {}
            };
            
            // å¤§é˜ªå¸‚å„åŒºã®åˆæœŸåŒ–
            osakaWards.forEach(ward => {
                regional.pure[ward] = 0;
                regional.re[ward] = 0;
            });
            
            // å¤§é˜ªåºœå†…å„å¸‚ã®åˆæœŸåŒ–
            regional.pure['å¤§é˜ªåºœå†…ãã®ä»–'] = 0;
            regional.re['å¤§é˜ªåºœå†…ãã®ä»–'] = 0;
            
            // ç´”åˆè¨ºã®åœ°åŸŸåˆ¥é›†è¨ˆ
            pureFirst.forEach(record => {
                const address = record['æ‚£è€…ä½æ‰€'] || '';
                const region = classifyAddress(address);
                
                if (!regional.pure[region]) {
                    regional.pure[region] = 0;
                }
                regional.pure[region]++;
            });
            
            // å†åˆè¨ºã®åœ°åŸŸåˆ¥é›†è¨ˆ
            reFirst.forEach(record => {
                const address = record['æ‚£è€…ä½æ‰€'] || '';
                const region = classifyAddress(address);
                
                if (!regional.re[region]) {
                    regional.re[region] = 0;
                }
                regional.re[region]++;
            });
            
            return regional;
        }
        
        // ä½æ‰€ã‹ã‚‰åœ°åŸŸã‚’åˆ†é¡
        function classifyAddress(address) {
            if (!address) return 'ãã®ä»–';
            
            // å¤§é˜ªå¸‚ã®åŒºã‚’åˆ¤å®š
            for (const ward of osakaWards) {
                if (address.includes(`å¤§é˜ªå¸‚${ward}`)) {
                    return ward;
                }
            }
            
            // å¤§é˜ªåºœå†…ã®å¸‚ã‚’åˆ¤å®š
            for (const city of osakaCities) {
                if (address.includes(city)) {
                    return city;
                }
            }
            
            // ä»–åºœçœŒ
            const prefectures = {
                'å…µåº«çœŒ': ['å…µåº«çœŒ', 'ç¥æˆ¸å¸‚', 'å°¼å´å¸‚', 'è¥¿å®®å¸‚', 'èŠ¦å±‹å¸‚', 'ä¼Šä¸¹å¸‚', 'å®å¡šå¸‚'],
                'äº¬éƒ½åºœ': ['äº¬éƒ½åºœ', 'äº¬éƒ½å¸‚', 'å®‡æ²»å¸‚', 'äº€å²¡å¸‚'],
                'æ±äº¬éƒ½': ['æ±äº¬éƒ½', 'åƒä»£ç”°åŒº', 'ä¸­å¤®åŒº', 'æ¸¯åŒº', 'æ–°å®¿åŒº', 'æ–‡äº¬åŒº', 'å°æ±åŒº', 'å¢¨ç”°åŒº', 'æ±Ÿæ±åŒº', 'å“å·åŒº', 'ç›®é»’åŒº', 'å¤§ç”°åŒº', 'ä¸–ç”°è°·åŒº', 'æ¸‹è°·åŒº', 'ä¸­é‡åŒº', 'æ‰ä¸¦åŒº', 'è±Šå³¶åŒº', 'åŒ—åŒº', 'è’å·åŒº', 'æ¿æ©‹åŒº', 'ç·´é¦¬åŒº', 'è¶³ç«‹åŒº', 'è‘›é£¾åŒº', 'æ±Ÿæˆ¸å·åŒº'],
                'å¥ˆè‰¯çœŒ': ['å¥ˆè‰¯çœŒ', 'å¥ˆè‰¯å¸‚', 'å¤§å’Œé«˜ç”°å¸‚', 'å¤§å’Œéƒ¡å±±å¸‚'],
                'å’Œæ­Œå±±çœŒ': ['å’Œæ­Œå±±çœŒ', 'å’Œæ­Œå±±å¸‚'],
                'æ»‹è³€çœŒ': ['æ»‹è³€çœŒ', 'å¤§æ´¥å¸‚', 'è‰æ´¥å¸‚']
            };
            
            for (const [pref, keywords] of Object.entries(prefectures)) {
                for (const keyword of keywords) {
                    if (address.includes(keyword)) {
                        return pref;
                    }
                }
            }
            
            // å¤§é˜ªåºœå†…ã®ãã®ä»–
            if (address.includes('å¤§é˜ªåºœ') || address.includes('åºœ')) {
                return 'å¤§é˜ªåºœå†…ãã®ä»–';
            }
            
            return 'ãã®ä»–';
        }
        
        // æ—¥ä»˜ç¯„å›²ã‚’è¨­å®š
        function setDateRange() {
            const months = Object.keys(monthlyData).sort();
            if (months.length > 0) {
                document.getElementById('startMonth').value = months[0];
                document.getElementById('endMonth').value = months[months.length - 1];
                
                // æœˆåˆ¥ãƒœã‚¿ãƒ³ã‚’ç”Ÿæˆ
                generateMonthButtons(months);
            }
        }
        
        // æœˆåˆ¥ãƒœã‚¿ãƒ³ã‚’ç”Ÿæˆ
        function generateMonthButtons(months) {
            const container = document.getElementById('monthButtons');
            container.innerHTML = '<span style="margin-right: 10px;">æœˆåˆ¥é¸æŠï¼š</span>';
            
            // æœ€æ–°ã®12ãƒ¶æœˆåˆ†ã®ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
            const recentMonths = months.slice(-12);
            
            recentMonths.forEach(month => {
                const [year, mon] = month.split('-');
                const button = document.createElement('button');
                button.textContent = `${year}/${mon}`;
                button.style.cssText = 'padding: 3px 8px; margin: 2px; background-color: #ecf0f1; color: #333; border: 1px solid #bdc3c7; border-radius: 3px; cursor: pointer;';
                button.onclick = () => selectSingleMonth(month);
                container.appendChild(button);
            });
        }
        
        // ç‰¹å®šã®æœˆã‚’é¸æŠ
        function selectSingleMonth(month) {
            document.getElementById('startMonth').value = month;
            document.getElementById('endMonth').value = month;
            updateAnalysis();
        }
        
        // è¡¨ç¤ºæ›´æ–°
        function updateDisplay() {
            let startMonth = document.getElementById('startMonth').value;
            let endMonth = document.getElementById('endMonth').value;
            
            // æœŸé–“ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã€è‡ªå‹•çš„ã«è¨­å®š
            if (!startMonth || !endMonth) {
                setDateRange();
                startMonth = document.getElementById('startMonth').value;
                endMonth = document.getElementById('endMonth').value;
                
                if (!startMonth || !endMonth) {
                    showError('æœŸé–“ã‚’è¨­å®šã—ã¦ãã ã•ã„');
                    return;
                }
            }
            
            const filteredMonths = Object.keys(monthlyData)
                .filter(month => month >= startMonth && month <= endMonth)
                .sort();
            
            if (filteredMonths.length === 0) {
                showError('é¸æŠã•ã‚ŒãŸæœŸé–“ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            // ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ã‚’æ›´æ–°
            updateSummaryCards(filteredMonths);
            
            // ã‚°ãƒ©ãƒ•ã‚’æ›´æ–°
            updateMonthlyChart(filteredMonths);
            
            // åœ°åŸŸåˆ¥ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ›´æ–°
            updateRegionalTable(filteredMonths);
        }
        
        // ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰æ›´æ–°
        function updateSummaryCards(months) {
            const lastMonth = months[months.length - 1];
            const prevMonth = months.length > 1 ? months[months.length - 2] : null;
            const lastYearMonth = getLastYearMonth(lastMonth);
            
            // è¡¨ç¤ºæœˆã‚’æ›´æ–°
            const [year, mon] = lastMonth.split('-');
            document.getElementById('currentPeriodDisplay').textContent = `${year}å¹´${parseInt(mon)}æœˆã®ãƒ‡ãƒ¼ã‚¿`;
            
            const lastData = monthlyData[lastMonth];
            const pureCount = lastData.pureFirst.length;
            const reFirstCount = lastData.reFirst.length;
            const returnCount = lastData.returnVisits.length;
            const totalFirstVisits = pureCount + reFirstCount;
            const totalAllVisits = pureCount + reFirstCount + returnCount;
            
            // å…¨æ‚£è€…ã«å¯¾ã™ã‚‹å‰²åˆ
            const pureRateAll = totalAllVisits > 0 ? (pureCount / totalAllVisits * 100).toFixed(1) : 0;
            const reFirstRateAll = totalAllVisits > 0 ? (reFirstCount / totalAllVisits * 100).toFixed(1) : 0;
            const returnRateAll = totalAllVisits > 0 ? (returnCount / totalAllVisits * 100).toFixed(1) : 0;
            
            document.getElementById('pureFirstValue').textContent = pureCount.toLocaleString() + 'äºº';
            document.getElementById('reFirstValue').textContent = reFirstCount.toLocaleString() + 'äºº';
            document.getElementById('totalFirstValue').textContent = totalFirstVisits.toLocaleString() + 'äºº';
            document.getElementById('pureRateValue').textContent = pureRateAll + '%';
            document.getElementById('reRateValue').textContent = reFirstRateAll + '%';
            document.getElementById('returnValue').textContent = returnCount.toLocaleString() + 'äºº';
            document.getElementById('totalAllValue').textContent = totalAllVisits.toLocaleString() + 'äºº';
            document.getElementById('returnRateValue').textContent = returnRateAll + '%';
            
            // å‰æœˆæ¯”ãƒ»å‰å¹´æ¯”ã‚’è¨ˆç®—
            if (prevMonth && monthlyData[prevMonth]) {
                const prevData = monthlyData[prevMonth];
                const prevPure = prevData.pureFirst.length;
                const prevReFirst = prevData.reFirst.length;
                const prevReturn = prevData.returnVisits.length;
                const prevTotalFirst = prevPure + prevReFirst;
                const prevTotalAll = prevPure + prevReFirst + prevReturn;
                
                const [prevYear, prevMon] = prevMonth.split('-');
                const prevMonthLabel = `${prevYear}å¹´${parseInt(prevMon)}æœˆæ¯”`;
                
                document.getElementById('pureFirstChange').innerHTML = getChangeText(pureCount, prevPure, prevMonthLabel);
                document.getElementById('reFirstChange').innerHTML = getChangeText(reFirstCount, prevReFirst, prevMonthLabel);
                document.getElementById('totalFirstChange').innerHTML = getChangeText(totalFirstVisits, prevTotalFirst, prevMonthLabel);
                document.getElementById('returnChange').innerHTML = getChangeText(returnCount, prevReturn, prevMonthLabel);
                document.getElementById('totalAllChange').innerHTML = getChangeText(totalAllVisits, prevTotalAll, prevMonthLabel);
            } else {
                document.getElementById('pureFirstChange').textContent = 'å‰æœˆãƒ‡ãƒ¼ã‚¿ãªã—';
                document.getElementById('reFirstChange').textContent = 'å‰æœˆãƒ‡ãƒ¼ã‚¿ãªã—';
                document.getElementById('totalFirstChange').textContent = 'å‰æœˆãƒ‡ãƒ¼ã‚¿ãªã—';
                document.getElementById('returnChange').textContent = 'å‰æœˆãƒ‡ãƒ¼ã‚¿ãªã—';
                document.getElementById('totalAllChange').textContent = 'å‰æœˆãƒ‡ãƒ¼ã‚¿ãªã—';
            }
            
            if (monthlyData[lastYearMonth]) {
                const lastYearData = monthlyData[lastYearMonth];
                const lastYearPure = lastYearData.pureFirst.length;
                const lastYearReFirst = lastYearData.reFirst.length;
                const lastYearReturn = lastYearData.returnVisits.length;
                const lastYearTotalAll = lastYearPure + lastYearReFirst + lastYearReturn;
                
                if (lastYearTotalAll > 0) {
                    const lastYearPureRate = (lastYearPure / lastYearTotalAll * 100).toFixed(1);
                    const lastYearReRate = (lastYearReFirst / lastYearTotalAll * 100).toFixed(1);
                    const lastYearReturnRate = (lastYearReturn / lastYearTotalAll * 100).toFixed(1);
                    
                    const pureRateChange = (parseFloat(pureRateAll) - parseFloat(lastYearPureRate)).toFixed(1);
                    const reRateChange = (parseFloat(reFirstRateAll) - parseFloat(lastYearReRate)).toFixed(1);
                    const returnRateChange = (parseFloat(returnRateAll) - parseFloat(lastYearReturnRate)).toFixed(1);
                    
                    const [lyYear, lyMon] = lastYearMonth.split('-');
                    const pureChangeClass = pureRateChange > 0 ? 'increase' : 'decrease';
                    const reChangeClass = reRateChange > 0 ? 'increase' : 'decrease';
                    const returnChangeClass = returnRateChange > 0 ? 'increase' : 'decrease';
                    
                    document.getElementById('pureRateChange').innerHTML = 
                        `${lyYear}å¹´${parseInt(lyMon)}æœˆæ¯”: <span class="${pureChangeClass}">${pureRateChange > 0 ? '+' : ''}${pureRateChange}pt</span>`;
                    document.getElementById('reRateChange').innerHTML = 
                        `${lyYear}å¹´${parseInt(lyMon)}æœˆæ¯”: <span class="${reChangeClass}">${reRateChange > 0 ? '+' : ''}${reRateChange}pt</span>`;
                    document.getElementById('returnRateChange').innerHTML = 
                        `${lyYear}å¹´${parseInt(lyMon)}æœˆæ¯”: <span class="${returnChangeClass}">${returnRateChange > 0 ? '+' : ''}${returnRateChange}pt</span>`;
                }
            } else {
                document.getElementById('pureRateChange').textContent = 'å‰å¹´åŒæœˆãƒ‡ãƒ¼ã‚¿ãªã—';
                document.getElementById('reRateChange').textContent = 'å‰å¹´åŒæœˆãƒ‡ãƒ¼ã‚¿ãªã—';
                document.getElementById('returnRateChange').textContent = 'å‰å¹´åŒæœˆãƒ‡ãƒ¼ã‚¿ãªã—';
            }
        }
        
        // ã‚°ãƒ©ãƒ•ã‚¿ã‚¤ãƒ—åˆ‡ã‚Šæ›¿ãˆç”¨é–¢æ•°
        function updateMonthlyChartDisplay() {
            updateDisplay();
        }
        
        // æœˆåˆ¥ã‚°ãƒ©ãƒ•æ›´æ–°
        function updateMonthlyChart(months) {
            const chartType = document.getElementById('monthlyChartType')?.value || 'combined';
            renderMonthlyChart(months, chartType);
        }
        
        function renderMonthlyChart(months, chartType = 'combined') {
            const ctx = document.getElementById('monthlyCanvas').getContext('2d');
            
            const labels = months.map(month => {
                const [year, mon] = month.split('-');
                return `${year}å¹´${parseInt(mon)}æœˆ`;
            });
            
            const pureData = months.map(month => monthlyData[month].pureFirst.length);
            const reData = months.map(month => monthlyData[month].reFirst.length);
            const returnData = months.map(month => monthlyData[month].returnVisits.length);
            
            // å…¨æ‚£è€…ã«å¯¾ã™ã‚‹ç´”åˆè¨ºç‡
            const pureRateData = months.map(month => {
                const pure = monthlyData[month].pureFirst.length;
                const reFirst = monthlyData[month].reFirst.length;
                const returns = monthlyData[month].returnVisits.length;
                const total = pure + reFirst + returns;
                return total > 0 ? (pure / total * 100).toFixed(1) : 0;
            });
            
            // å…¨æ‚£è€…ã«å¯¾ã™ã‚‹å†åˆè¨ºç‡
            const reFirstRateData = months.map(month => {
                const pure = monthlyData[month].pureFirst.length;
                const reFirst = monthlyData[month].reFirst.length;
                const returns = monthlyData[month].returnVisits.length;
                const total = pure + reFirst + returns;
                return total > 0 ? (reFirst / total * 100).toFixed(1) : 0;
            });
            
            // åˆè¨ºå†…ã§ã®ç´”åˆè¨ºç‡
            const pureRateInFirstData = months.map(month => {
                const pure = monthlyData[month].pureFirst.length;
                const reFirst = monthlyData[month].reFirst.length;
                const totalFirst = pure + reFirst;
                return totalFirst > 0 ? (pure / totalFirst * 100).toFixed(1) : 0;
            });
            
            // åˆè¨ºå†…ã§ã®å†åˆè¨ºç‡
            const reRateInFirstData = months.map(month => {
                const pure = monthlyData[month].pureFirst.length;
                const reFirst = monthlyData[month].reFirst.length;
                const totalFirst = pure + reFirst;
                return totalFirst > 0 ? (reFirst / totalFirst * 100).toFixed(1) : 0;
            });
            
            
            if (currentChart) {
                currentChart.destroy();
            }
            
            let datasets = [];
            let yScales = {};
            
            switch (chartType) {
                case 'combined':
                    datasets = [
                        {
                            label: 'ç´”åˆè¨º',
                            data: pureData,
                            backgroundColor: '#3498db',
                            yAxisID: 'y'
                        },
                        {
                            label: 'å†åˆè¨º',
                            data: reData,
                            backgroundColor: '#2ecc71',
                            yAxisID: 'y'
                        },
                        {
                            label: 'ç´”åˆè¨ºç‡',
                            data: pureRateData,
                            type: 'line',
                            borderColor: '#3498db',
                            backgroundColor: 'transparent',
                            yAxisID: 'y1',
                            borderWidth: 3,
                            tension: 0.1,
                        },
                        {
                            label: 'å†åˆè¨ºç‡',
                            data: reFirstRateData,
                            type: 'line',
                            borderColor: '#9b59b6',
                            backgroundColor: 'transparent',
                            yAxisID: 'y1',
                            borderWidth: 3,
                            tension: 0.1
                        }
                    ];
                    yScales = {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'æ‚£è€…æ•°ï¼ˆäººï¼‰'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            min: 0,
                            max: 100,
                            title: {
                                display: true,
                                text: 'æ¯”ç‡ï¼ˆ%ï¼‰'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    };
                    break;
                    
                case 'counts':
                    datasets = [
                        {
                            label: 'ç´”åˆè¨º',
                            data: pureData,
                            backgroundColor: '#3498db'
                        },
                        {
                            label: 'å†åˆè¨º',
                            data: reData,
                            backgroundColor: '#2ecc71'
                        },
                        {
                            label: 'å†è¨º',
                            data: returnData,
                            backgroundColor: '#e67e22'
                        }
                    ];
                    yScales = {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'æ‚£è€…æ•°ï¼ˆäººï¼‰'
                            }
                        }
                    };
                    break;
                    
                case 'rates':
                    datasets = [
                        {
                            label: 'ç´”åˆè¨ºç‡ï¼ˆå…¨æ‚£è€…ä¸­ï¼‰',
                            data: pureRateData,
                            type: 'line',
                            borderColor: '#3498db',
                            backgroundColor: 'transparent',
                            borderWidth: 3,
                            tension: 0.1,
                        },
                        {
                            label: 'å†åˆè¨ºç‡ï¼ˆå…¨æ‚£è€…ä¸­ï¼‰',
                            data: reFirstRateData,
                            type: 'line',
                            borderColor: '#9b59b6',
                            backgroundColor: 'transparent',
                            borderWidth: 3,
                            tension: 0.1
                        },
                        {
                            label: 'ç´”åˆè¨ºç‡ï¼ˆåˆè¨ºå†…ï¼‰',
                            data: pureRateInFirstData,
                            type: 'line',
                            borderColor: '#3498db',
                            borderDash: [5, 5],
                            backgroundColor: 'transparent',
                            borderWidth: 2,
                            tension: 0.1
                        },
                        {
                            label: 'å†åˆè¨ºç‡ï¼ˆåˆè¨ºå†…ï¼‰',
                            data: reRateInFirstData,
                            type: 'line',
                            borderColor: '#2ecc71',
                            borderDash: [5, 5],
                            backgroundColor: 'transparent',
                            borderWidth: 2,
                            tension: 0.1
                        }
                    ];
                    yScales = {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            min: 0,
                            max: 100,
                            title: {
                                display: true,
                                text: 'æ¯”ç‡ï¼ˆ%ï¼‰'
                            }
                        }
                    };
                    break;
                    
                case 'pure':
                    datasets = [
                        {
                            label: 'ç´”åˆè¨ºæ•°',
                            data: pureData,
                            backgroundColor: '#3498db',
                            yAxisID: 'y'
                        },
                        {
                            label: 'ç´”åˆè¨ºç‡ï¼ˆå…¨æ‚£è€…ä¸­ï¼‰',
                            data: pureRateData,
                            type: 'line',
                            borderColor: '#3498db',
                            backgroundColor: 'transparent',
                            yAxisID: 'y1',
                            borderWidth: 3,
                            tension: 0.1,
                        },
                        {
                            label: 'ç´”åˆè¨ºç‡ï¼ˆåˆè¨ºå†…ï¼‰',
                            data: pureRateInFirstData,
                            type: 'line',
                            borderColor: '#3498db',
                            borderDash: [5, 5],
                            backgroundColor: 'transparent',
                            yAxisID: 'y1',
                            borderWidth: 2,
                            tension: 0.1
                        }
                    ];
                    yScales = {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'ç´”åˆè¨ºæ•°ï¼ˆäººï¼‰'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            min: 0,
                            max: 100,
                            title: {
                                display: true,
                                text: 'ç´”åˆè¨ºç‡ï¼ˆ%ï¼‰'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    };
                    break;
                    
                case 're':
                    datasets = [
                        {
                            label: 'å†åˆè¨ºæ•°',
                            data: reData,
                            backgroundColor: '#2ecc71',
                            yAxisID: 'y'
                        },
                        {
                            label: 'å†åˆè¨ºç‡ï¼ˆå…¨æ‚£è€…ä¸­ï¼‰',
                            data: reFirstRateData,
                            type: 'line',
                            borderColor: '#9b59b6',
                            backgroundColor: 'transparent',
                            yAxisID: 'y1',
                            borderWidth: 3,
                            tension: 0.1
                        },
                        {
                            label: 'å†åˆè¨ºç‡ï¼ˆåˆè¨ºå†…ï¼‰',
                            data: reRateInFirstData,
                            type: 'line',
                            borderColor: '#2ecc71',
                            borderDash: [5, 5],
                            backgroundColor: 'transparent',
                            yAxisID: 'y1',
                            borderWidth: 2,
                            tension: 0.1
                        }
                    ];
                    yScales = {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'å†åˆè¨ºæ•°ï¼ˆäººï¼‰'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            min: 0,
                            max: 100,
                            title: {
                                display: true,
                                text: 'å†åˆè¨ºç‡ï¼ˆ%ï¼‰'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    };
                    break;
            }
            
            currentChart = new Chart(ctx, {
                type: chartType === 'rates' ? 'line' : 'bar',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    aspectRatio: 2,
                    scales: yScales,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (label.includes('ç‡')) {
                                        label += context.parsed.y + '%';
                                    } else {
                                        label += context.parsed.y + 'äºº';
                                    }
                                    return label;
                                }
                            }
                        },
                        zoom: {
                            zoom: {
                                wheel: {
                                    enabled: true,
                                },
                                pinch: {
                                    enabled: true
                                },
                                mode: 'x',
                            },
                            pan: {
                                enabled: true,
                                mode: 'x',
                            }
                        },
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            formatter: (value, ctx) => {
                                if (ctx.dataset.type === 'line') {
                                    return value + '%';
                                }
                                return value;
                            },
                            color: '#666',
                            font: {
                                weight: 'bold',
                                size: 10
                            }
                        }
                    }
                }
            });
        }
        
        // åœ°åŸŸåˆ¥ãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°
        function updateRegionalTable(months) {
            const lastMonth = months[months.length - 1];
            const prevMonth = months.length > 1 ? months[months.length - 2] : null;
            
            const lastData = monthlyData[lastMonth].regional;
            const tbody = document.getElementById('regionalTableBody');
            tbody.innerHTML = '';
            
            // å…¨åœ°åŸŸã‚’é›†è¨ˆ
            const allRegions = new Set();
            Object.keys(lastData.pure).forEach(region => allRegions.add(region));
            Object.keys(lastData.re).forEach(region => allRegions.add(region));
            
            // åœ°åŸŸã‚’ã‚½ãƒ¼ãƒˆï¼ˆè¥¿åŒºã‚’æœ€åˆã«ã€ãã®ä»–ã®åŒºã€åºœå†…å¸‚ç”ºæ‘ã€ä»–åºœçœŒã®é †ï¼‰
            const sortedRegions = Array.from(allRegions).sort((a, b) => {
                if (a === 'è¥¿åŒº') return -1;
                if (b === 'è¥¿åŒº') return 1;
                if (osakaWards.includes(a) && !osakaWards.includes(b)) return -1;
                if (!osakaWards.includes(a) && osakaWards.includes(b)) return 1;
                return a.localeCompare(b);
            });
            
            sortedRegions.forEach(region => {
                const pure = lastData.pure[region] || 0;
                const re = lastData.re[region] || 0;
                const total = pure + re;
                
                if (total === 0) return; // ãƒ‡ãƒ¼ã‚¿ãŒãªã„åœ°åŸŸã¯è¡¨ç¤ºã—ãªã„
                
                const rate = total > 0 ? (pure / total * 100).toFixed(1) : 0;
                
                let prevChange = '-';
                if (prevMonth && monthlyData[prevMonth].regional) {
                    const prevPure = monthlyData[prevMonth].regional.pure[region] || 0;
                    const prevRe = monthlyData[prevMonth].regional.re[region] || 0;
                    const prevTotal = prevPure + prevRe;
                    
                    if (prevTotal > 0) {
                        const change = ((total - prevTotal) / prevTotal * 100).toFixed(1);
                        const changeClass = change > 0 ? 'increase' : 'decrease';
                        prevChange = `<span class="${changeClass}">${change > 0 ? '+' : ''}${change}%</span>`;
                    }
                }
                
                const row = `
                    <tr>
                        <td>${region}</td>
                        <td>${pure}</td>
                        <td>${re}</td>
                        <td>${total}</td>
                        <td>${rate}%</td>
                        <td>${prevChange}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }
        
        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function switchTab(tabName) {
            // ã‚¿ãƒ–ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // ãƒãƒ£ãƒ¼ãƒˆã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
            document.getElementById('monthlyChart').style.display = 'none';
            document.getElementById('regionalChart').style.display = 'none';
            document.getElementById('comparisonChart').style.display = 'none';
            document.getElementById('wardChart').style.display = 'none';
            document.getElementById('periodComparisonContainer').style.display = 'none';
            
            switch(tabName) {
                case 'monthly':
                    document.getElementById('monthlyChart').style.display = 'block';
                    break;
                case 'regional':
                    document.getElementById('regionalChart').style.display = 'block';
                    updateRegionalChart();
                    break;
                case 'comparison':
                    document.getElementById('comparisonChart').style.display = 'block';
                    updateComparisonChart();
                    break;
                case 'ward':
                    document.getElementById('wardChart').style.display = 'block';
                    updateWardChart();
                    break;
                case 'periodComparison':
                    document.getElementById('periodComparisonContainer').style.display = 'block';
                    break;
            }
        }
        
        // åœ°åŸŸåˆ¥ã‚°ãƒ©ãƒ•ã®ç¾åœ¨ã®ã‚¿ã‚¤ãƒ—
        let currentRegionalChartType = 'bar';
        
        // åœ°åŸŸåˆ¥ã‚°ãƒ©ãƒ•æ›´æ–°
        function updateRegionalChart() {
            // åœ°åŸŸé¸æŠãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°
            updateRegionSelect();
            // ã‚°ãƒ©ãƒ•ã‚’æ›´æ–°
            updateRegionalTrendChart();
        }
        
        // åœ°åŸŸé¸æŠãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°
        function updateRegionSelect() {
            const startMonth = document.getElementById('startMonth').value;
            const endMonth = document.getElementById('endMonth').value;
            
            const filteredMonths = Object.keys(monthlyData)
                .filter(month => month >= startMonth && month <= endMonth)
                .sort();
            
            if (filteredMonths.length === 0) return;
            
            // å…¨æœŸé–“ã®åœ°åŸŸã‚’é›†è¨ˆ
            const allRegions = new Set();
            filteredMonths.forEach(month => {
                const monthRegional = monthlyData[month].regional;
                Object.keys(monthRegional.pure).forEach(region => allRegions.add(region));
                Object.keys(monthRegional.re).forEach(region => allRegions.add(region));
            });
            
            // åœ°åŸŸã‚’é…åˆ—ã«å¤‰æ›ã—ã¦ã‚½ãƒ¼ãƒˆ
            const sortedRegions = Array.from(allRegions).sort((a, b) => {
                // è¥¿åŒºã‚’æœ€åˆã«
                if (a === 'è¥¿åŒº') return -1;
                if (b === 'è¥¿åŒº') return 1;
                // åŒºã‚’å„ªå…ˆ
                const aIsWard = a.includes('åŒº');
                const bIsWard = b.includes('åŒº');
                if (aIsWard && !bIsWard) return -1;
                if (!aIsWard && bIsWard) return 1;
                return a.localeCompare(b);
            });
            
            const regionSelect = document.getElementById('regionSelect');
            const currentValue = regionSelect.value;
            
            // ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°
            regionSelect.innerHTML = '<option value="all">å…¨åœ°åŸŸ</option>';
            sortedRegions.forEach(region => {
                const option = document.createElement('option');
                option.value = region;
                option.textContent = region;
                regionSelect.appendChild(option);
            });
            
            // ä»¥å‰ã®é¸æŠã‚’å¾©å…ƒ
            if (currentValue && Array.from(regionSelect.options).some(opt => opt.value === currentValue)) {
                regionSelect.value = currentValue;
            }
        }
        
        // åœ°åŸŸåˆ¥æœˆåˆ¥æ¨ç§»ã‚°ãƒ©ãƒ•ã‚’æ›´æ–°
        function updateRegionalTrendChart() {
            const selectedRegion = document.getElementById('regionSelect').value;
            const chartType = document.getElementById('regionalChartType').value;
            const startMonth = document.getElementById('startMonth').value;
            const endMonth = document.getElementById('endMonth').value;
            
            const filteredMonths = Object.keys(monthlyData)
                .filter(month => month >= startMonth && month <= endMonth)
                .sort();
            
            if (filteredMonths.length === 0) return;
            
            const ctx = document.getElementById('regionalCanvas').getContext('2d');
            
            if (regionalChartInstance) {
                regionalChartInstance.destroy();
            }
            
            const labels = filteredMonths.map(month => {
                const [year, mon] = month.split('-');
                return `${year}å¹´${parseInt(mon)}æœˆ`;
            });
            
            let datasets = [];
            
            if (selectedRegion === 'all') {
                // å…¨åœ°åŸŸã®å ´åˆã€ä¸Šä½5åœ°åŸŸã‚’è¡¨ç¤º
                const regionalTotals = {};
                
                filteredMonths.forEach(month => {
                    const monthRegional = monthlyData[month].regional;
                    Object.keys(monthRegional.pure).forEach(region => {
                        if (!regionalTotals[region]) regionalTotals[region] = 0;
                        regionalTotals[region] += monthRegional.pure[region] + (monthRegional.re[region] || 0);
                    });
                });
                
                // ä¸Šä½5åœ°åŸŸã‚’å–å¾—
                const top5Regions = Object.entries(regionalTotals)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5)
                    .map(([region]) => region);
                
                const colors = ['#3498db', '#2ecc71', '#e74c3c', '#f39c12', '#9b59b6'];
                
                if (chartType === 'combined' || chartType === 'pure') {
                    // ç´”åˆè¨ºãƒ‡ãƒ¼ã‚¿
                    top5Regions.forEach((region, index) => {
                        const data = filteredMonths.map(month => {
                            return monthlyData[month].regional.pure[region] || 0;
                        });
                        
                        datasets.push({
                            label: `${region} (ç´”åˆè¨º)`,
                            data: data,
                            borderColor: colors[index],
                            backgroundColor: colors[index] + '20',
                            borderWidth: 2,
                            tension: 0.1
                        });
                    });
                }
                
                if (chartType === 'combined' || chartType === 're') {
                    // å†åˆè¨ºãƒ‡ãƒ¼ã‚¿
                    top5Regions.forEach((region, index) => {
                        const data = filteredMonths.map(month => {
                            return monthlyData[month].regional.re[region] || 0;
                        });
                        
                        datasets.push({
                            label: `${region} (å†åˆè¨º)`,
                            data: data,
                            borderColor: colors[index],
                            backgroundColor: colors[index] + '40',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            tension: 0.1
                        });
                    });
                }
            } else {
                // ç‰¹å®šåœ°åŸŸã®å ´åˆ
                if (chartType === 'combined' || chartType === 'pure') {
                    const pureData = filteredMonths.map(month => {
                        return monthlyData[month].regional.pure[selectedRegion] || 0;
                    });
                    
                    datasets.push({
                        label: `${selectedRegion} (ç´”åˆè¨º)`,
                        data: pureData,
                        backgroundColor: 'rgba(52, 152, 219, 0.6)',
                        borderColor: 'rgba(52, 152, 219, 1)',
                        borderWidth: 2,
                        type: 'bar'
                    });
                }
                
                if (chartType === 'combined' || chartType === 're') {
                    const reData = filteredMonths.map(month => {
                        return monthlyData[month].regional.re[selectedRegion] || 0;
                    });
                    
                    datasets.push({
                        label: `${selectedRegion} (å†åˆè¨º)`,
                        data: reData,
                        backgroundColor: 'rgba(46, 204, 113, 0.6)',
                        borderColor: 'rgba(46, 204, 113, 1)',
                        borderWidth: 2,
                        type: 'bar'
                    });
                }
            }
            
            regionalChartInstance = new Chart(ctx, {
                type: selectedRegion === 'all' ? 'line' : 'bar',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'æ‚£è€…æ•°ï¼ˆäººï¼‰'
                            }
                        }
                    },
                    plugins: {
                        zoom: {
                            zoom: {
                                wheel: {
                                    enabled: true,
                                },
                                pinch: {
                                    enabled: true
                                },
                                mode: 'x',
                            },
                            pan: {
                                enabled: true,
                                mode: 'x',
                            }
                        }
                    }
                }
            });
        }
        
        // åœ°åŸŸåˆ¥ã‚°ãƒ©ãƒ•ã®ã‚ºãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
        function resetRegionalZoom() {
            if (regionalChartInstance) {
                regionalChartInstance.resetZoom();
            }
        }
        
        // å‰å¹´ãƒ»å‰æœˆæ¯”è¼ƒã‚°ãƒ©ãƒ•
        function updateComparisonChart() {
            const startMonth = document.getElementById('startMonth').value;
            const endMonth = document.getElementById('endMonth').value;
            
            const filteredMonths = Object.keys(monthlyData)
                .filter(month => month >= startMonth && month <= endMonth)
                .sort();
            
            if (filteredMonths.length === 0) return;
            
            const labels = [];
            const monthlyChange = [];
            const yearlyChange = [];
            
            filteredMonths.forEach(month => {
                const [year, mon] = month.split('-');
                labels.push(`${year}å¹´${parseInt(mon)}æœˆ`);
                
                const currentTotal = monthlyData[month].pureFirst.length + monthlyData[month].reFirst.length;
                
                // å‰æœˆæ¯”
                const prevMonth = getPreviousMonth(month);
                if (monthlyData[prevMonth]) {
                    const prevTotal = monthlyData[prevMonth].pureFirst.length + monthlyData[prevMonth].reFirst.length;
                    const change = prevTotal > 0 ? ((currentTotal - prevTotal) / prevTotal * 100).toFixed(1) : 0;
                    monthlyChange.push(parseFloat(change));
                } else {
                    monthlyChange.push(null);
                }
                
                // å‰å¹´æ¯”
                const lastYearMonth = getLastYearMonth(month);
                if (monthlyData[lastYearMonth]) {
                    const lastYearTotal = monthlyData[lastYearMonth].pureFirst.length + monthlyData[lastYearMonth].reFirst.length;
                    const change = lastYearTotal > 0 ? ((currentTotal - lastYearTotal) / lastYearTotal * 100).toFixed(1) : 0;
                    yearlyChange.push(parseFloat(change));
                } else {
                    yearlyChange.push(null);
                }
            });
            
            const ctx = document.getElementById('comparisonCanvas').getContext('2d');
            
            if (comparisonChartInstance) {
                comparisonChartInstance.destroy();
            }
            
            comparisonChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'å‰æœˆæ¯”ï¼ˆ%ï¼‰',
                            data: monthlyChange,
                            borderColor: '#3498db',
                            backgroundColor: 'transparent',
                            borderWidth: 2,
                            tension: 0.1
                        },
                        {
                            label: 'å‰å¹´åŒæœˆæ¯”ï¼ˆ%ï¼‰',
                            data: yearlyChange,
                            borderColor: '#e74c3c',
                            backgroundColor: 'transparent',
                            borderWidth: 2,
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: 'å¤‰åŒ–ç‡ï¼ˆ%ï¼‰'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y.toFixed(1) + '%';
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // å¤§é˜ªå¸‚åŒºåˆ¥ã‚°ãƒ©ãƒ•
        function updateWardChart() {
            const startMonth = document.getElementById('startMonth').value;
            const endMonth = document.getElementById('endMonth').value;
            
            const filteredMonths = Object.keys(monthlyData)
                .filter(month => month >= startMonth && month <= endMonth)
                .sort();
            
            if (filteredMonths.length === 0) return;
            
            // ä¸»è¦åŒºã®ã¿è¡¨ç¤ºï¼ˆä¸Šä½6åŒºï¼‰
            const wardTotals = {};
            
            filteredMonths.forEach(month => {
                const monthRegional = monthlyData[month].regional;
                osakaWards.forEach(ward => {
                    if (!wardTotals[ward]) wardTotals[ward] = 0;
                    wardTotals[ward] += (monthRegional.pure[ward] || 0);
                });
            });
            
            const topWards = Object.entries(wardTotals)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 6)
                .map(([ward]) => ward);
            
            const labels = filteredMonths.map(month => {
                const [year, mon] = month.split('-');
                return `${parseInt(mon)}æœˆ`;
            });
            
            const datasets = topWards.map((ward, index) => {
                const data = filteredMonths.map(month => 
                    monthlyData[month].regional.pure[ward] || 0
                );
                
                const colors = [
                    '#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6', '#34495e'
                ];
                
                return {
                    label: ward,
                    data: data,
                    borderColor: colors[index % colors.length],
                    backgroundColor: 'transparent',
                    borderWidth: 2,
                    tension: 0.1
                };
            });
            
            const ctx = document.getElementById('wardCanvas').getContext('2d');
            
            if (wardChartInstance) {
                wardChartInstance.destroy();
            }
            
            wardChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'ç´”åˆè¨ºæ•°ï¼ˆäººï¼‰'
                            }
                        }
                    }
                }
            });
        }
        
        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        function getPreviousMonth(monthStr) {
            const [year, month] = monthStr.split('-').map(Number);
            const date = new Date(year, month - 2, 1); // month - 1 - 1
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        }
        
        function getLastYearMonth(monthStr) {
            const [year, month] = monthStr.split('-').map(Number);
            return `${year - 1}-${String(month).padStart(2, '0')}`;
        }
        
        function getChangeText(current, previous, label) {
            if (previous === 0) return label + ': -';
            const change = ((current - previous) / previous * 100).toFixed(1);
            const sign = change > 0 ? '+' : '';
            const className = change > 0 ? 'increase' : 'decrease';
            return `${label}: <span class="${className}">${sign}${change}%</span>`;
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }
        
        // ã‚ºãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆé–¢æ•°
        function resetZoom() {
            if (currentChart) {
                currentChart.resetZoom();
            }
        }
        
        // ã‚¯ã‚¤ãƒƒã‚¯é¸æŠé–¢æ•°
        function selectLastMonth() {
            const months = Object.keys(monthlyData).sort();
            if (months.length > 0) {
                const lastMonth = months[months.length - 1];
                document.getElementById('startMonth').value = lastMonth;
                document.getElementById('endMonth').value = lastMonth;
                updateAnalysis();
            }
        }
        
        function selectThisYear() {
            const currentYear = new Date().getFullYear();
            const months = Object.keys(monthlyData).filter(m => m.startsWith(currentYear + '-')).sort();
            if (months.length > 0) {
                document.getElementById('startMonth').value = months[0];
                document.getElementById('endMonth').value = months[months.length - 1];
                updateAnalysis();
            }
        }
        
        function selectLastYear() {
            const lastYear = new Date().getFullYear() - 1;
            const months = Object.keys(monthlyData).filter(m => m.startsWith(lastYear + '-')).sort();
            if (months.length > 0) {
                document.getElementById('startMonth').value = months[0];
                document.getElementById('endMonth').value = months[months.length - 1];
                updateAnalysis();
            }
        }
        
        function selectLast3Months() {
            const months = Object.keys(monthlyData).sort();
            if (months.length > 0) {
                const endMonth = months[months.length - 1];
                const startIdx = Math.max(0, months.length - 3);
                document.getElementById('startMonth').value = months[startIdx];
                document.getElementById('endMonth').value = endMonth;
                updateAnalysis();
            }
        }
        
        function selectLast6Months() {
            const months = Object.keys(monthlyData).sort();
            if (months.length > 0) {
                const endMonth = months[months.length - 1];
                const startIdx = Math.max(0, months.length - 6);
                document.getElementById('startMonth').value = months[startIdx];
                document.getElementById('endMonth').value = endMonth;
                updateAnalysis();
            }
        }
        
        function selectAll() {
            const months = Object.keys(monthlyData).sort();
            if (months.length > 0) {
                document.getElementById('startMonth').value = months[0];
                document.getElementById('endMonth').value = months[months.length - 1];
                updateAnalysis();
            }
        }
        
        // ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢é–¢æ•°
        function clearData() {
            if (confirm('ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) {
                // ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
                allData = [];
                monthlyData = {};
                
                // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚‚ã‚¯ãƒªã‚¢
                localStorage.removeItem('liberalArtsPatientData');
                
                // ã‚°ãƒ©ãƒ•ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ã‚¯ãƒªã‚¢
                if (currentChart) {
                    currentChart.destroy();
                    currentChart = null;
                }
                if (regionalChartInstance) {
                    regionalChartInstance.destroy();
                    regionalChartInstance = null;
                }
                if (comparisonChartInstance) {
                    comparisonChartInstance.destroy();
                    comparisonChartInstance = null;
                }
                if (wardChartInstance) {
                    wardChartInstance.destroy();
                    wardChartInstance = null;
                }
                
                // UIã‚’éè¡¨ç¤º
                document.getElementById('controls').style.display = 'none';
                document.getElementById('summaryCards').style.display = 'none';
                document.getElementById('tabs').style.display = 'none';
                document.getElementById('monthlyChart').style.display = 'none';
                document.getElementById('regionalChart').style.display = 'none';
                document.getElementById('comparisonChart').style.display = 'none';
                document.getElementById('wardChart').style.display = 'none';
                document.getElementById('regionalTable').style.display = 'none';
                document.getElementById('periodComparisonContainer').style.display = 'none';
                document.getElementById('dataInfo').style.display = 'none';
                
                // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã‚’ãƒªã‚»ãƒƒãƒˆ
                document.getElementById('fileInput').value = '';
            }
        }
        
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }
        
        // åˆ†ææ›´æ–°ãƒœã‚¿ãƒ³
        function updateAnalysis() {
            updateDisplay();
        }
        
        // æœŸé–“æ¯”è¼ƒæ©Ÿèƒ½
        function comparePeriods() {
            const period1Start = document.getElementById('period1Start').value;
            const period1End = document.getElementById('period1End').value;
            const period2Start = document.getElementById('period2Start').value;
            const period2End = document.getElementById('period2End').value;
            
            if (!period1Start || !period1End || !period2Start || !period2End) {
                showError('ã™ã¹ã¦ã®æœŸé–“ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            // æœŸé–“1ã®ãƒ‡ãƒ¼ã‚¿é›†è¨ˆ
            const period1Data = calculatePeriodData(period1Start, period1End);
            // æœŸé–“2ã®ãƒ‡ãƒ¼ã‚¿é›†è¨ˆ
            const period2Data = calculatePeriodData(period2Start, period2End);
            
            // çµæœè¡¨ç¤º
            displayComparisonResults(period1Data, period2Data, period1Start, period1End, period2Start, period2End);
        }
        
        // æœŸé–“ãƒ‡ãƒ¼ã‚¿é›†è¨ˆ
        function calculatePeriodData(startMonth, endMonth) {
            let totalPure = 0;
            let totalRe = 0;
            let monthCount = 0;
            const regionalData = {};
            
            Object.keys(monthlyData).forEach(month => {
                if (month >= startMonth && month <= endMonth) {
                    monthCount++;
                    totalPure += monthlyData[month].pureFirst.length;
                    totalRe += monthlyData[month].reFirst.length;
                    
                    // åœ°åŸŸåˆ¥é›†è¨ˆ
                    const monthRegional = monthlyData[month].regional;
                    Object.keys(monthRegional.pure).forEach(region => {
                        if (!regionalData[region]) {
                            regionalData[region] = { pure: 0, re: 0 };
                        }
                        regionalData[region].pure += monthRegional.pure[region];
                        regionalData[region].re += monthRegional.re[region];
                    });
                    Object.keys(monthRegional.re).forEach(region => {
                        if (!regionalData[region]) {
                            regionalData[region] = { pure: 0, re: 0 };
                        }
                        regionalData[region].re += monthRegional.re[region];
                    });
                }
            });
            
            const total = totalPure + totalRe;
            const pureRate = total > 0 ? (totalPure / total * 100).toFixed(1) : 0;
            const avgPure = monthCount > 0 ? Math.round(totalPure / monthCount) : 0;
            const avgRe = monthCount > 0 ? Math.round(totalRe / monthCount) : 0;
            
            return {
                totalPure,
                totalRe,
                total,
                pureRate,
                avgPure,
                avgRe,
                monthCount,
                regionalData
            };
        }
        
        // æ¯”è¼ƒçµæœè¡¨ç¤º
        function displayComparisonResults(period1, period2, start1, end1, start2, end2) {
            const resultsDiv = document.getElementById('comparisonResults');
            
            // æœŸé–“1ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
            const formatPeriod = (start, end) => {
                const [startYear, startMonth] = start.split('-');
                const [endYear, endMonth] = end.split('-');
                return `${startYear}å¹´${parseInt(startMonth)}æœˆï½${endYear}å¹´${parseInt(endMonth)}æœˆ`;
            };
            
            // å·®åˆ†è¨ˆç®—
            const pureDiff = period2.totalPure - period1.totalPure;
            const reDiff = period2.totalRe - period1.totalRe;
            const totalDiff = period2.total - period1.total;
            const rateDiff = parseFloat(period2.pureRate) - parseFloat(period1.pureRate);
            
            // å¤‰åŒ–ç‡è¨ˆç®—
            const pureChange = period1.totalPure > 0 ? ((pureDiff / period1.totalPure) * 100).toFixed(1) : '-';
            const reChange = period1.totalRe > 0 ? ((reDiff / period1.totalRe) * 100).toFixed(1) : '-';
            const totalChange = period1.total > 0 ? ((totalDiff / period1.total) * 100).toFixed(1) : '-';
            
            // HTMLç”Ÿæˆ
            resultsDiv.innerHTML = `
                <div class="comparison-card">
                    <h4>æœŸé–“1: ${formatPeriod(start1, end1)} (${period1.monthCount}ãƒ¶æœˆ)</h4>
                    <div class="comparison-row">
                        <span class="comparison-label">ç´”åˆè¨ºåˆè¨ˆ:</span>
                        <span class="comparison-value">${period1.totalPure.toLocaleString()}äºº</span>
                    </div>
                    <div class="comparison-row">
                        <span class="comparison-label">å†åˆè¨ºåˆè¨ˆ:</span>
                        <span class="comparison-value">${period1.totalRe.toLocaleString()}äºº</span>
                    </div>
                    <div class="comparison-row">
                        <span class="comparison-label">åˆè¨ºåˆè¨ˆ:</span>
                        <span class="comparison-value">${period1.total.toLocaleString()}äºº</span>
                    </div>
                    <div class="comparison-row">
                        <span class="comparison-label">ç´”åˆè¨ºç‡:</span>
                        <span class="comparison-value">${period1.pureRate}%</span>
                    </div>
                    <div class="comparison-row">
                        <span class="comparison-label">æœˆå¹³å‡ç´”åˆè¨º:</span>
                        <span class="comparison-value">${period1.avgPure.toLocaleString()}äºº</span>
                    </div>
                    <div class="comparison-row">
                        <span class="comparison-label">æœˆå¹³å‡å†åˆè¨º:</span>
                        <span class="comparison-value">${period1.avgRe.toLocaleString()}äºº</span>
                    </div>
                </div>
                
                <div class="comparison-card">
                    <h4>æœŸé–“2: ${formatPeriod(start2, end2)} (${period2.monthCount}ãƒ¶æœˆ)</h4>
                    <div class="comparison-row">
                        <span class="comparison-label">ç´”åˆè¨ºåˆè¨ˆ:</span>
                        <span class="comparison-value">${period2.totalPure.toLocaleString()}äºº</span>
                    </div>
                    <div class="comparison-row">
                        <span class="comparison-label">å†åˆè¨ºåˆè¨ˆ:</span>
                        <span class="comparison-value">${period2.totalRe.toLocaleString()}äºº</span>
                    </div>
                    <div class="comparison-row">
                        <span class="comparison-label">åˆè¨ºåˆè¨ˆ:</span>
                        <span class="comparison-value">${period2.total.toLocaleString()}äºº</span>
                    </div>
                    <div class="comparison-row">
                        <span class="comparison-label">ç´”åˆè¨ºç‡:</span>
                        <span class="comparison-value">${period2.pureRate}%</span>
                    </div>
                    <div class="comparison-row">
                        <span class="comparison-label">æœˆå¹³å‡ç´”åˆè¨º:</span>
                        <span class="comparison-value">${period2.avgPure.toLocaleString()}äºº</span>
                    </div>
                    <div class="comparison-row">
                        <span class="comparison-label">æœˆå¹³å‡å†åˆè¨º:</span>
                        <span class="comparison-value">${period2.avgRe.toLocaleString()}äºº</span>
                    </div>
                </div>
                
                <div class="comparison-card" style="background-color: #e8f4f8; border: 2px solid #3498db;">
                    <h4>æœŸé–“æ¯”è¼ƒï¼ˆæœŸé–“2 - æœŸé–“1ï¼‰</h4>
                    <div class="comparison-row">
                        <span class="comparison-label">ç´”åˆè¨ºæ•°å¤‰åŒ–:</span>
                        <span class="comparison-value ${pureDiff >= 0 ? 'increase' : 'decrease'}">
                            ${pureDiff >= 0 ? '+' : ''}${pureDiff.toLocaleString()}äºº (${pureChange}%)
                        </span>
                    </div>
                    <div class="comparison-row">
                        <span class="comparison-label">å†åˆè¨ºæ•°å¤‰åŒ–:</span>
                        <span class="comparison-value ${reDiff >= 0 ? 'increase' : 'decrease'}">
                            ${reDiff >= 0 ? '+' : ''}${reDiff.toLocaleString()}äºº (${reChange}%)
                        </span>
                    </div>
                    <div class="comparison-row">
                        <span class="comparison-label">åˆè¨ºåˆè¨ˆå¤‰åŒ–:</span>
                        <span class="comparison-value ${totalDiff >= 0 ? 'increase' : 'decrease'}">
                            ${totalDiff >= 0 ? '+' : ''}${totalDiff.toLocaleString()}äºº (${totalChange}%)
                        </span>
                    </div>
                    <div class="comparison-row">
                        <span class="comparison-label">ç´”åˆè¨ºç‡å¤‰åŒ–:</span>
                        <span class="comparison-value ${rateDiff >= 0 ? 'increase' : 'decrease'}">
                            ${rateDiff >= 0 ? '+' : ''}${rateDiff.toFixed(1)}ãƒã‚¤ãƒ³ãƒˆ
                        </span>
                    </div>
                </div>
                
                <div class="comparison-card" style="grid-column: 1 / -1;">
                    <h4>åœ°åŸŸåˆ¥ä¸Šä½5åœ°åŸŸã®å¤‰åŒ–</h4>
                    ${generateRegionalComparison(period1.regionalData, period2.regionalData)}
                </div>
            `;
        }
        
        // åœ°åŸŸåˆ¥æ¯”è¼ƒç”Ÿæˆ
        function generateRegionalComparison(regional1, regional2) {
            // æœŸé–“2ã®åˆè¨ˆã§ã‚½ãƒ¼ãƒˆ
            const sortedRegions = Object.keys(regional2)
                .map(region => ({
                    region,
                    total2: (regional2[region].pure || 0) + (regional2[region].re || 0),
                    total1: regional1[region] ? (regional1[region].pure || 0) + (regional1[region].re || 0) : 0
                }))
                .sort((a, b) => b.total2 - a.total2)
                .slice(0, 5);
            
            let html = '<table style="width: 100%; border-collapse: collapse;">';
            html += '<thead><tr style="background-color: #f8f9fa;">';
            html += '<th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">åœ°åŸŸ</th>';
            html += '<th style="padding: 10px; text-align: right; border-bottom: 2px solid #ddd;">æœŸé–“1</th>';
            html += '<th style="padding: 10px; text-align: right; border-bottom: 2px solid #ddd;">æœŸé–“2</th>';
            html += '<th style="padding: 10px; text-align: right; border-bottom: 2px solid #ddd;">å¤‰åŒ–</th>';
            html += '</tr></thead><tbody>';
            
            sortedRegions.forEach(item => {
                const change = item.total2 - item.total1;
                const changePercent = item.total1 > 0 ? ((change / item.total1) * 100).toFixed(1) : '-';
                html += '<tr>';
                html += `<td style="padding: 8px; border-bottom: 1px solid #eee;">${item.region}</td>`;
                html += `<td style="padding: 8px; text-align: right; border-bottom: 1px solid #eee;">${item.total1.toLocaleString()}äºº</td>`;
                html += `<td style="padding: 8px; text-align: right; border-bottom: 1px solid #eee;">${item.total2.toLocaleString()}äºº</td>`;
                html += `<td style="padding: 8px; text-align: right; border-bottom: 1px solid #eee;" class="${change >= 0 ? 'increase' : 'decrease'}">`;
                html += `${change >= 0 ? '+' : ''}${change.toLocaleString()}äºº (${changePercent}%)`;
                html += '</td></tr>';
            });
            
            html += '</tbody></table>';
            return html;
        }
        
        // å‰Šé™¤ã•ã‚ŒãŸã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½
        /*function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'pt', 'a4');
            
            // ãƒ•ã‚©ãƒ³ãƒˆè¨­å®šï¼ˆæ—¥æœ¬èªå¯¾å¿œï¼‰
            doc.setFont('helvetica');
            
            // ã‚¿ã‚¤ãƒˆãƒ«
            doc.setFontSize(18);
            doc.text('ãƒªãƒ™å¤§ç·åˆã‚¯ãƒªãƒ‹ãƒƒã‚¯ æ‚£è€…åˆ†æãƒ¬ãƒãƒ¼ãƒˆ', 40, 40);
            
            // æ—¥ä»˜ç¯„å›²
            const startMonth = document.getElementById('startMonth').value;
            const endMonth = document.getElementById('endMonth').value;
            
            if (!startMonth || !endMonth) {
                showError('æœŸé–“ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            const [startYear, startMon] = startMonth.split('-');
            const [endYear, endMon] = endMonth.split('-');
            
            doc.setFontSize(12);
            doc.text(`åˆ†ææœŸé–“: ${startYear}å¹´${parseInt(startMon)}æœˆï½${endYear}å¹´${parseInt(endMon)}æœˆ`, 40, 70);
            doc.text(`ä½œæˆæ—¥: ${new Date().toLocaleDateString('ja-JP')}`, 40, 90);
            
            // ã‚µãƒãƒªãƒ¼æƒ…å ±
            const lastMonth = Object.keys(monthlyData).filter(m => m >= startMonth && m <= endMonth).sort().pop();
            if (lastMonth && monthlyData[lastMonth]) {
                const data = monthlyData[lastMonth];
                const pureCount = data.pureFirst.length;
                const reCount = data.reFirst.length;
                const totalCount = pureCount + reCount;
                const pureRate = totalCount > 0 ? (pureCount / totalCount * 100).toFixed(1) : 0;
                
                doc.setFontSize(14);
                doc.text('æœ€çµ‚æœˆã‚µãƒãƒªãƒ¼', 40, 120);
                
                const summaryData = [
                    ['é …ç›®', 'å€¤'],
                    ['ç´”åˆè¨ºæ•°', `${pureCount}äºº`],
                    ['å†åˆè¨ºæ•°', `${reCount}äºº`],
                    ['åˆè¨ºåˆè¨ˆ', `${totalCount}äºº`],
                    ['ç´”åˆè¨ºç‡', `${pureRate}%`]
                ];
                
                doc.autoTable({
                    startY: 140,
                    head: [summaryData[0]],
                    body: summaryData.slice(1),
                    theme: 'grid',
                    styles: { font: 'helvetica' }
                });
            }
            
            // æœˆåˆ¥ãƒ‡ãƒ¼ã‚¿
            const monthlyTableData = [['æœˆ', 'ç´”åˆè¨º', 'å†åˆè¨º', 'åˆè¨ˆ', 'ç´”åˆè¨ºç‡']];
            Object.keys(monthlyData)
                .filter(month => month >= startMonth && month <= endMonth)
                .sort()
                .forEach(month => {
                    const data = monthlyData[month];
                    const pure = data.pureFirst.length;
                    const re = data.reFirst.length;
                    const total = pure + re;
                    const rate = total > 0 ? (pure / total * 100).toFixed(1) : 0;
                    
                    const [year, mon] = month.split('-');
                    monthlyTableData.push([
                        `${year}å¹´${parseInt(mon)}æœˆ`,
                        pure.toString(),
                        re.toString(),
                        total.toString(),
                        `${rate}%`
                    ]);
                });
            
            if (monthlyTableData.length > 1) {
                doc.addPage();
                doc.setFontSize(14);
                doc.text('æœˆåˆ¥æ¨ç§»ãƒ‡ãƒ¼ã‚¿', 40, 40);
                
                doc.autoTable({
                    startY: 60,
                    head: [monthlyTableData[0]],
                    body: monthlyTableData.slice(1),
                    theme: 'striped',
                    styles: { font: 'helvetica' }
                });
            }
            
            // PDFã‚’ä¿å­˜
            const fileName = `æ‚£è€…åˆ†æãƒ¬ãƒãƒ¼ãƒˆ_${startMonth}_${endMonth}.pdf`;
            doc.save(fileName);
        }
        
        // Excelå‡ºåŠ›æ©Ÿèƒ½
        function exportToExcel() {
            const wb = XLSX.utils.book_new();
            
            // æ—¥ä»˜ç¯„å›²ã‚’å–å¾—
            const startMonth = document.getElementById('startMonth').value;
            const endMonth = document.getElementById('endMonth').value;
            
            if (!startMonth || !endMonth) {
                showError('æœŸé–“ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            // ã‚µãƒãƒªãƒ¼ã‚·ãƒ¼ãƒˆä½œæˆ
            const summaryData = [];
            summaryData.push(['ãƒªãƒ™å¤§ç·åˆã‚¯ãƒªãƒ‹ãƒƒã‚¯ æ‚£è€…åˆ†æãƒ¬ãƒãƒ¼ãƒˆ']);
            summaryData.push([`åˆ†ææœŸé–“: ${startMonth} ï½ ${endMonth}`]);
            summaryData.push([`ä½œæˆæ—¥: ${new Date().toLocaleDateString('ja-JP')}`]);
            summaryData.push([]);
            
            // æœ€çµ‚æœˆã‚µãƒãƒªãƒ¼
            const lastMonth = Object.keys(monthlyData).filter(m => m >= startMonth && m <= endMonth).sort().pop();
            if (lastMonth && monthlyData[lastMonth]) {
                const data = monthlyData[lastMonth];
                const pureCount = data.pureFirst.length;
                const reCount = data.reFirst.length;
                const totalCount = pureCount + reCount;
                const pureRate = totalCount > 0 ? (pureCount / totalCount * 100).toFixed(1) : 0;
                
                summaryData.push(['æœ€çµ‚æœˆã‚µãƒãƒªãƒ¼']);
                summaryData.push(['é …ç›®', 'å€¤']);
                summaryData.push(['ç´”åˆè¨ºæ•°', `${pureCount}äºº`]);
                summaryData.push(['å†åˆè¨ºæ•°', `${reCount}äºº`]);
                summaryData.push(['åˆè¨ºåˆè¨ˆ', `${totalCount}äºº`]);
                summaryData.push(['ç´”åˆè¨ºç‡', `${pureRate}%`]);
            }
            
            const summarySheet = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, summarySheet, 'ã‚µãƒãƒªãƒ¼');
            
            // æœˆåˆ¥æ¨ç§»ã‚·ãƒ¼ãƒˆä½œæˆ
            const monthlyData2 = [['å¹´æœˆ', 'ç´”åˆè¨º', 'å†åˆè¨º', 'åˆè¨ˆ', 'ç´”åˆè¨ºç‡']];
            Object.keys(monthlyData)
                .filter(month => month >= startMonth && month <= endMonth)
                .sort()
                .forEach(month => {
                    const data = monthlyData[month];
                    const pure = data.pureFirst.length;
                    const re = data.reFirst.length;
                    const total = pure + re;
                    const rate = total > 0 ? (pure / total * 100).toFixed(1) : 0;
                    
                    monthlyData2.push([month, pure, re, total, parseFloat(rate)]);
                });
            
            const monthlySheet = XLSX.utils.aoa_to_sheet(monthlyData2);
            XLSX.utils.book_append_sheet(wb, monthlySheet, 'æœˆåˆ¥æ¨ç§»');
            
            // åœ°åŸŸåˆ¥é›†è¨ˆã‚·ãƒ¼ãƒˆä½œæˆ
            const regionalData = {};
            Object.keys(monthlyData)
                .filter(month => month >= startMonth && month <= endMonth)
                .forEach(month => {
                    const monthRegional = monthlyData[month].regional;
                    Object.keys(monthRegional.pure).forEach(region => {
                        if (!regionalData[region]) {
                            regionalData[region] = { pure: 0, re: 0 };
                        }
                        regionalData[region].pure += monthRegional.pure[region];
                    });
                    Object.keys(monthRegional.re).forEach(region => {
                        if (!regionalData[region]) {
                            regionalData[region] = { pure: 0, re: 0 };
                        }
                        regionalData[region].re += monthRegional.re[region];
                    });
                });
            
            const regionalArray = [['åœ°åŸŸ', 'ç´”åˆè¨º', 'å†åˆè¨º', 'åˆè¨ˆ', 'ç´”åˆè¨ºç‡']];
            Object.entries(regionalData)
                .sort(([,a], [,b]) => (b.pure + b.re) - (a.pure + a.re))
                .forEach(([region, data]) => {
                    const total = data.pure + data.re;
                    const rate = total > 0 ? (data.pure / total * 100).toFixed(1) : 0;
                    regionalArray.push([region, data.pure, data.re, total, parseFloat(rate)]);
                });
            
            const regionalSheet = XLSX.utils.aoa_to_sheet(regionalArray);
            XLSX.utils.book_append_sheet(wb, regionalSheet, 'åœ°åŸŸåˆ¥é›†è¨ˆ');
            
            // Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜
            const fileName = `æ‚£è€…åˆ†æãƒ¬ãƒãƒ¼ãƒˆ_${startMonth}_${endMonth}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }
        
        
        // ã‚µãƒãƒªãƒ¼ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
        function generateSummaryReport() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'pt', 'a4');
            
            // æ—¥ä»˜ç¯„å›²
            const startMonth = document.getElementById('startMonth').value;
            const endMonth = document.getElementById('endMonth').value;
            
            if (!startMonth || !endMonth) {
                showError('æœŸé–“ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            const [startYear, startMon] = startMonth.split('-');
            const [endYear, endMon] = endMonth.split('-');
            
            // ã‚¿ã‚¤ãƒˆãƒ«
            doc.setFontSize(20);
            doc.text('æ‚£è€…åˆ†æã‚µãƒãƒªãƒ¼ãƒ¬ãƒãƒ¼ãƒˆ', 40, 40);
            
            doc.setFontSize(14);
            doc.text('ãƒªãƒ™å¤§ç·åˆã‚¯ãƒªãƒ‹ãƒƒã‚¯', 40, 65);
            
            doc.setFontSize(12);
            doc.text(`åˆ†ææœŸé–“: ${startYear}å¹´${parseInt(startMon)}æœˆï½${endYear}å¹´${parseInt(endMon)}æœˆ`, 40, 85);
            doc.text(`ä½œæˆæ—¥: ${new Date().toLocaleDateString('ja-JP')}`, 40, 105);
            
            // 1. æœŸé–“æ¦‚è¦
            doc.setFontSize(16);
            doc.text('1. æœŸé–“æ¦‚è¦', 40, 140);
            
            const months = Object.keys(monthlyData)
                .filter(month => month >= startMonth && month <= endMonth)
                .sort();
            
            let totalPure = 0;
            let totalRe = 0;
            months.forEach(month => {
                totalPure += monthlyData[month].pureFirst.length;
                totalRe += monthlyData[month].reFirst.length;
            });
            const grandTotal = totalPure + totalRe;
            const avgPureRate = grandTotal > 0 ? (totalPure / grandTotal * 100).toFixed(1) : 0;
            
            doc.setFontSize(12);
            doc.text(`â€¢ åˆ†æå¯¾è±¡æœˆæ•°: ${months.length}ãƒ¶æœˆ`, 60, 165);
            doc.text(`â€¢ ç´”åˆè¨ºç·æ•°: ${totalPure.toLocaleString()}äºº`, 60, 185);
            doc.text(`â€¢ å†åˆè¨ºç·æ•°: ${totalRe.toLocaleString()}äºº`, 60, 205);
            doc.text(`â€¢ åˆè¨ºåˆè¨ˆ: ${grandTotal.toLocaleString()}äºº`, 60, 225);
            doc.text(`â€¢ æœŸé–“å¹³å‡ç´”åˆè¨ºç‡: ${avgPureRate}%`, 60, 245);
            
            // 2. æœˆåˆ¥å‚¾å‘åˆ†æ
            doc.setFontSize(16);
            doc.text('2. æœˆåˆ¥å‚¾å‘åˆ†æ', 40, 280);
            
            // æœ€é«˜ãƒ»æœ€ä½ç´”åˆè¨ºç‡
            let maxRate = 0;
            let minRate = 100;
            let maxMonth = '';
            let minMonth = '';
            
            months.forEach(month => {
                const data = monthlyData[month];
                const pure = data.pureFirst.length;
                const re = data.reFirst.length;
                const total = pure + re;
                const rate = total > 0 ? (pure / total * 100) : 0;
                
                if (rate > maxRate) {
                    maxRate = rate;
                    maxMonth = month;
                }
                if (rate < minRate) {
                    minRate = rate;
                    minMonth = month;
                }
            });
            
            doc.setFontSize(12);
            doc.text(`â€¢ æœ€é«˜ç´”åˆè¨ºç‡: ${maxRate.toFixed(1)}% (${maxMonth.replace('-', 'å¹´')}æœˆ)`, 60, 305);
            doc.text(`â€¢ æœ€ä½ç´”åˆè¨ºç‡: ${minRate.toFixed(1)}% (${minMonth.replace('-', 'å¹´')}æœˆ)`, 60, 325);
            
            // 3. åœ°åŸŸåˆ¥åˆ†æ
            doc.setFontSize(16);
            doc.text('3. åœ°åŸŸåˆ¥åˆ†æï¼ˆä¸Šä½5åœ°åŸŸï¼‰', 40, 360);
            
            const regionalTotal = {};
            months.forEach(month => {
                const monthRegional = monthlyData[month].regional;
                Object.keys(monthRegional.pure).forEach(region => {
                    if (!regionalTotal[region]) {
                        regionalTotal[region] = { pure: 0, re: 0 };
                    }
                    regionalTotal[region].pure += monthRegional.pure[region];
                    regionalTotal[region].re += monthRegional.re[region];
                });
            });
            
            const topRegions = Object.entries(regionalTotal)
                .map(([region, data]) => ({
                    region,
                    total: data.pure + data.re,
                    pureRate: data.pure + data.re > 0 ? (data.pure / (data.pure + data.re) * 100).toFixed(1) : 0
                }))
                .sort((a, b) => b.total - a.total)
                .slice(0, 5);
            
            doc.setFontSize(12);
            let yPos = 385;
            topRegions.forEach((region, index) => {
                doc.text(`${index + 1}. ${region.region}: ${region.total.toLocaleString()}äºº (ç´”åˆè¨ºç‡: ${region.pureRate}%)`, 60, yPos);
                yPos += 20;
            });
            
            // 4. æ”¹å–„ææ¡ˆ
            doc.addPage();
            doc.setFontSize(16);
            doc.text('4. æ”¹å–„ææ¡ˆ', 40, 40);
            
            doc.setFontSize(12);
            const suggestions = [];
            
            if (parseFloat(avgPureRate) < 50) {
                suggestions.push('â€¢ ç´”åˆè¨ºç‡ãŒ50%ã‚’ä¸‹å›ã£ã¦ã„ã¾ã™ã€‚æ–°è¦æ‚£è€…ç²å¾—ã®æ–½ç­–ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚');
            }
            
            if (minRate < 40) {
                suggestions.push('â€¢ ç‰¹å®šæœˆã®ç´”åˆè¨ºç‡ãŒ40%ã‚’ä¸‹å›ã£ã¦ã„ã¾ã™ã€‚å­£ç¯€è¦å› ã®åˆ†æãŒå¿…è¦ã§ã™ã€‚');
            }
            
            const westWardData = regionalTotal['è¥¿åŒº'];
            if (westWardData) {
                const westTotal = westWardData.pure + westWardData.re;
                const westPercentage = (westTotal / grandTotal * 100).toFixed(1);
                if (parseFloat(westPercentage) < 20) {
                    suggestions.push('â€¢ åœ°å…ƒï¼ˆè¥¿åŒºï¼‰ã‹ã‚‰ã®æ‚£è€…æ¯”ç‡ãŒä½ã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚åœ°åŸŸå¯†ç€ã®æ–½ç­–ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚');
                }
            }
            
            if (suggestions.length === 0) {
                suggestions.push('â€¢ å…¨ä½“çš„ã«è‰¯å¥½ãªæ•°å€¤ã‚’ç¶­æŒã—ã¦ã„ã¾ã™ã€‚ç¾åœ¨ã®æ–½ç­–ã‚’ç¶™ç¶šã—ã¦ãã ã•ã„ã€‚');
            }
            
            yPos = 65;
            suggestions.forEach(suggestion => {
                const lines = doc.splitTextToSize(suggestion, 500);
                doc.text(lines, 60, yPos);
                yPos += lines.length * 15 + 10;
            });
            
            // 5. æ¬¡æœŸã‚¢ã‚¯ã‚·ãƒ§ãƒ³
            doc.setFontSize(16);
            doc.text('5. æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³', 40, yPos + 30);
            
            doc.setFontSize(12);
            const actions = [
                '1. æœˆåˆ¥ã®ç´”åˆè¨ºç‡æ¨ç§»ã‚’å®šæœŸçš„ã«ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°',
                '2. ä½ç´”åˆè¨ºç‡æœˆã®è¦å› åˆ†æï¼ˆå­£ç¯€æ€§ã€ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³åŠ¹æœç­‰ï¼‰',
                '3. åœ°åŸŸåˆ¥ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°æˆ¦ç•¥ã®è¦‹ç›´ã—',
                '4. æ‚£è€…æº€è¶³åº¦èª¿æŸ»ã«ã‚ˆã‚‹å†åˆè¨ºè¦å› ã®æŠŠæ¡'
            ];
            
            yPos += 55;
            actions.forEach(action => {
                doc.text(action, 60, yPos);
                yPos += 20;
            });
            
            // PDFã‚’ä¿å­˜
            const fileName = `ã‚µãƒãƒªãƒ¼ãƒ¬ãƒãƒ¼ãƒˆ_${startMonth}_${endMonth}.pdf`;
            doc.save(fileName);
        }*/
    </script>
</body>
</html>