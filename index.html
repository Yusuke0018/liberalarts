<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„É™„ÉôÂ§ßÁ∑èÂêà„ÇØ„É™„Éã„ÉÉ„ÇØ ÊÇ£ËÄÖÂàÜÊûê„Ç∑„Çπ„ÉÜ„É†</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <!-- Removed date-fns as it was causing module export errors -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background-color: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .upload-area {
            background-color: #fff;
            border: 2px dashed #3498db;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .upload-area:hover {
            border-color: #2980b9;
            background-color: #f8f9fa;
        }
        
        .upload-area.dragover {
            background-color: #e3f2fd;
            border-color: #1976d2;
        }
        
        .controls {
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: none;
        }
        
        .date-selector {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .date-selector label {
            font-weight: bold;
            color: #555;
        }
        
        .date-selector input[type="month"] {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            display: none;
        }
        
        .summary-card {
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .summary-card h3 {
            color: #555;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .summary-card .value {
            font-size: 32px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .summary-card .sub-value {
            font-size: 14px;
            color: #7f8c8d;
            margin-top: 5px;
        }
        
        .summary-card.pure {
            border-left: 4px solid #3498db;
        }
        
        .summary-card.re {
            border-left: 4px solid #2ecc71;
        }
        
        .summary-card.total {
            border-left: 4px solid #e74c3c;
        }
        
        .summary-card.rate {
            border-left: 4px solid #f39c12;
        }
        
        .chart-container {
            background-color: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: none;
            position: relative;
        }
        
        .chart-container h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 20px;
        }
        
        .chart-wrapper {
            position: relative;
            height: 400px;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #ecf0f1;
            display: none;
        }
        
        .period-comparison-container {
            display: none;
            background-color: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .period-selector {
            display: flex;
            gap: 30px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .period-input {
            flex: 1;
            min-width: 250px;
        }
        
        .period-input h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .period-input select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .period-month-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .comparison-results {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .comparison-card {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        
        .comparison-card h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .comparison-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #ecf0f1;
        }
        
        .comparison-row:last-child {
            border-bottom: none;
        }
        
        .comparison-label {
            color: #555;
        }
        
        .comparison-value {
            font-weight: bold;
            color: #2c3e50;
        }
        
        .tab {
            padding: 10px 20px;
            background-color: transparent;
            border: none;
            font-size: 16px;
            cursor: pointer;
            color: #7f8c8d;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        
        .tab:hover {
            color: #2c3e50;
        }
        
        .tab.active {
            color: #3498db;
            border-bottom-color: #3498db;
        }
        
        .regional-table {
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: none;
            overflow-x: auto;
        }
        
        .regional-table table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .regional-table th,
        .regional-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
        }
        
        .regional-table th {
            background-color: #f8f9fa;
            font-weight: bold;
            color: #2c3e50;
            position: sticky;
            top: 0;
        }
        
        .regional-table tr:hover {
            background-color: #f8f9fa;
        }
        
        .increase {
            color: #2ecc71;
            font-weight: bold;
        }
        
        .decrease {
            color: #e74c3c;
            font-weight: bold;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            background-color: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }
        
        #fileInput {
            display: none;
        }
        
        
        .threshold-settings {
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: none;
        }
        
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>„É™„ÉôÂ§ßÁ∑èÂêà„ÇØ„É™„Éã„ÉÉ„ÇØ ÊÇ£ËÄÖÂàÜÊûê„Ç∑„Çπ„ÉÜ„É†</h1>
            <p>CSV„Éï„Ç°„Ç§„É´„Çí„Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó„Åæ„Åü„ÅØ„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
        </div>
        
        <div class="error-message" id="errorMessage"></div>
        
        <div class="upload-area" id="uploadArea">
            <p>üìÅ CSV„Éï„Ç°„Ç§„É´„Çí„Åì„Åì„Å´„Éâ„É≠„ÉÉ„Éó</p>
            <p style="margin-top: 10px; font-size: 14px; color: #7f8c8d;">„Åæ„Åü„ÅØ „ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû</p>
        </div>
        
        <input type="file" id="fileInput" accept=".csv">
        
        <div id="dataInfo" style="display: none; background-color: #fff; padding: 15px; border-radius: 5px; margin: 20px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <p style="margin: 0; color: #2c3e50;">ÁèæÂú®„ÅÆ„Éá„Éº„Çø: <span id="dataCount" style="font-weight: bold;">0</span>‰ª∂</p>
            <button onclick="clearData()" style="margin-top: 10px; padding: 5px 15px; background-color: #e74c3c; color: white; border: none; border-radius: 3px; cursor: pointer;">„Éá„Éº„Çø„Çí„ÇØ„É™„Ç¢</button>
        </div>
        
        <div class="controls" id="controls">
            <div class="date-selector">
                <label for="startMonth">ÈñãÂßãÊúàÔºö</label>
                <input type="month" id="startMonth" min="2023-04">
                
                <label for="endMonth">ÁµÇ‰∫ÜÊúàÔºö</label>
                <input type="month" id="endMonth">
                
                <button onclick="updateAnalysis()" style="padding: 8px 20px; background-color: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer;">ÊúüÈñì„ÇíÊõ¥Êñ∞</button>
                
                <div style="margin-top: 10px;">
                    <span style="margin-right: 10px;">„ÇØ„Ç§„ÉÉ„ÇØÈÅ∏ÊäûÔºö</span>
                    <button onclick="selectLastMonth()" style="padding: 5px 10px; margin-right: 5px; background-color: #95a5a6; color: white; border: none; border-radius: 3px; cursor: pointer;">ÂÖàÊúà</button>
                    <button onclick="selectThisYear()" style="padding: 5px 10px; margin-right: 5px; background-color: #95a5a6; color: white; border: none; border-radius: 3px; cursor: pointer;">‰ªäÂπ¥</button>
                    <button onclick="selectLastYear()" style="padding: 5px 10px; margin-right: 5px; background-color: #95a5a6; color: white; border: none; border-radius: 3px; cursor: pointer;">Êò®Âπ¥</button>
                    <button onclick="selectLast3Months()" style="padding: 5px 10px; margin-right: 5px; background-color: #95a5a6; color: white; border: none; border-radius: 3px; cursor: pointer;">ÈÅéÂéª3„É∂Êúà</button>
                    <button onclick="selectLast6Months()" style="padding: 5px 10px; margin-right: 5px; background-color: #95a5a6; color: white; border: none; border-radius: 3px; cursor: pointer;">ÈÅéÂéª6„É∂Êúà</button>
                    <button onclick="selectAll()" style="padding: 5px 10px; background-color: #95a5a6; color: white; border: none; border-radius: 3px; cursor: pointer;">ÂÖ®ÊúüÈñì</button>
                </div>
                
                <div style="margin-top: 10px;" id="monthButtons">
                    <span style="margin-right: 10px;">ÊúàÂà•ÈÅ∏ÊäûÔºö</span>
                    <!-- ÊúàÂà•„Éú„Çø„É≥„ÅØÂãïÁöÑ„Å´ÁîüÊàê„Åï„Çå„Çã -->
                </div>
            </div>
        </div>
        
        <div class="loading" id="loading">
            <div class="loading-spinner"></div>
            <p style="margin-top: 20px;">„Éá„Éº„Çø„ÇíÂàÜÊûê‰∏≠...</p>
        </div>
        
        <div class="summary-cards" id="summaryCards">
            <div class="period-info" style="grid-column: 1 / -1; background-color: #2c3e50; color: white; padding: 20px; border-radius: 10px; text-align: center; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                <h2 style="margin: 0; font-size: 24px; font-weight: bold;" id="currentPeriodDisplay">„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Çì„Åß„Åè„Å†„Åï„ÅÑ</h2>
                <p style="margin: 5px 0 0 0; font-size: 14px; opacity: 0.8;">ÈÅ∏ÊäûÊúüÈñì„ÅÆÊúÄÁµÇÊúà„ÅÆ„Éá„Éº„Çø„ÇíË°®Á§∫„Åó„Å¶„ÅÑ„Åæ„Åô</p>
            </div>
            
            <div class="summary-card pure">
                <h3>Á¥îÂàùË®∫ÔºàÊñ∞Ë¶èÊÇ£ËÄÖÔºâ</h3>
                <div class="value" id="pureFirstValue">-</div>
                <div class="sub-value" id="pureFirstChange">-</div>
            </div>
            
            <div class="summary-card re">
                <h3>ÂÜçÂàùË®∫ÔºàÊó¢Â≠òÊÇ£ËÄÖ„ÅÆÊñ∞ÁóáÁä∂Ôºâ</h3>
                <div class="value" id="reFirstValue">-</div>
                <div class="sub-value" id="reFirstChange">-</div>
            </div>
            
            <div class="summary-card total">
                <h3>ÂàùË®∫ÂêàË®à</h3>
                <div class="value" id="totalFirstValue">-</div>
                <div class="sub-value" id="totalFirstChange">-</div>
            </div>
            
            <div class="summary-card rate">
                <h3>Á¥îÂàùË®∫Áéá</h3>
                <div class="value" id="pureRateValue">-</div>
                <div class="sub-value" id="pureRateChange">-</div>
            </div>
            
            <div class="summary-card rate" style="border-left-color: #9b59b6;">
                <h3>ÂÜçÂàùË®∫Áéá</h3>
                <div class="value" id="reRateValue">-</div>
                <div class="sub-value" id="reRateChange">-</div>
            </div>
            
            <div class="summary-card return" style="border-left-color: #e74c3c;">
                <h3>ÂÜçË®∫</h3>
                <div class="value" id="returnValue">-</div>
                <div class="sub-value" id="returnChange">-</div>
            </div>
            
            <div class="summary-card total-all" style="border-left-color: #34495e;">
                <h3>ÂÖ®ÊÇ£ËÄÖÊï∞</h3>
                <div class="value" id="totalAllValue">-</div>
                <div class="sub-value" id="totalAllChange">-</div>
            </div>
            
            <div class="summary-card rate" style="border-left-color: #e74c3c;">
                <h3>ÂÜçË®∫Áéá</h3>
                <div class="value" id="returnRateValue">-</div>
                <div class="sub-value" id="returnRateChange">-</div>
            </div>
        </div>
        
        <div class="tabs" id="tabs">
            <button class="tab active" onclick="switchTab('monthly')">ÊúàÂà•Êé®Áßª</button>
            <button class="tab" onclick="switchTab('regional')">Âú∞ÂüüÂà•ÂàÜÊûê</button>
            <button class="tab" onclick="switchTab('comparison')">ÂâçÂπ¥„ÉªÂâçÊúàÊØîËºÉ</button>
            <button class="tab" onclick="switchTab('ward')">Â§ßÈò™Â∏ÇÂå∫Âà•Ë©≥Á¥∞</button>
            <button class="tab" onclick="switchTab('periodComparison')">ÊúüÈñìÊØîËºÉ</button>
        </div>
        
        
        <div class="chart-container" id="monthlyChart">
            <h2>ÊúàÂà• Á¥îÂàùË®∫„ÉªÂÜçÂàùË®∫Êé®Áßª</h2>
            <div style="display: flex; justify-content: space-between; align-items: center; margin: 10px 0;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <p style="font-size: 14px; color: #666; margin: 0;">
                        „Éû„Ç¶„Çπ„Éõ„Ç§„Éº„É´„Åß„Ç∫„Éº„É†„ÄÅ„Éâ„É©„ÉÉ„Ç∞„Åß„Éë„É≥Êìç‰Ωú„ÅåÂèØËÉΩ„Åß„Åô„ÄÇ
                    </p>
                    <select id="monthlyChartType" onchange="updateMonthlyChartDisplay()" style="padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
                        <option value="combined">Áµ±ÂêàË°®Á§∫</option>
                        <option value="counts">Êù•Èô¢Êï∞„ÅÆ„Åø</option>
                        <option value="rates">ÊØîÁéá„ÅÆ„Åø</option>
                        <option value="pure">Á¥îÂàùË®∫„ÅÆ„Åø</option>
                        <option value="re">ÂÜçÂàùË®∫„ÅÆ„Åø</option>
                    </select>
                </div>
                <button onclick="resetZoom()" style="padding: 5px 15px; background-color: #95a5a6; color: white; border: none; border-radius: 3px; cursor: pointer;">„Ç∫„Éº„É†„É™„Çª„ÉÉ„Éà</button>
            </div>
            <div class="chart-wrapper">
                <canvas id="monthlyCanvas"></canvas>
            </div>
        </div>
        
        <div class="chart-container" id="regionalChart" style="display: none;">
            <h2>Âú∞ÂüüÂà• Á¥îÂàùË®∫„ÉªÂÜçÂàùË®∫Êï∞„ÅÆÊúàÂà•Êé®Áßª</h2>
            <div style="display: flex; justify-content: space-between; align-items: center; margin: 10px 0;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <label for="regionSelect">Âú∞ÂüüÈÅ∏ÊäûÔºö</label>
                    <select id="regionSelect" onchange="updateRegionalTrendChart()" style="padding: 5px 10px; border: 1px solid #ddd; border-radius: 3px;">
                        <option value="all">ÂÖ®Âú∞Âüü</option>
                    </select>
                    <select id="regionalChartType" onchange="updateRegionalTrendChart()" style="padding: 5px 10px; border: 1px solid #ddd; border-radius: 3px;">
                        <option value="combined">Á¥îÂàùË®∫„ÉªÂÜçÂàùË®∫‰∏°Êñπ</option>
                        <option value="pure">Á¥îÂàùË®∫„ÅÆ„Åø</option>
                        <option value="re">ÂÜçÂàùË®∫„ÅÆ„Åø</option>
                    </select>
                </div>
                <button onclick="resetRegionalZoom()" style="padding: 5px 15px; background-color: #95a5a6; color: white; border: none; border-radius: 3px; cursor: pointer;">„Ç∫„Éº„É†„É™„Çª„ÉÉ„Éà</button>
            </div>
            <div class="chart-wrapper">
                <canvas id="regionalCanvas"></canvas>
            </div>
        </div>
        
        <div class="chart-container" id="comparisonChart" style="display: none;">
            <h2>ÂâçÂπ¥„ÉªÂâçÊúàÊØîËºÉ</h2>
            <div class="chart-wrapper">
                <canvas id="comparisonCanvas"></canvas>
            </div>
        </div>
        
        <div class="chart-container" id="wardChart" style="display: none;">
            <h2>Â§ßÈò™Â∏ÇÂå∫Âà• Á¥îÂàùË®∫Êï∞Êé®Áßª</h2>
            <div class="chart-wrapper">
                <canvas id="wardCanvas"></canvas>
            </div>
        </div>
        
        <div class="period-comparison-container" id="periodComparisonContainer">
            <h2>ÊúüÈñìÊØîËºÉÂàÜÊûê</h2>
            <div class="period-selector">
                <div class="period-input">
                    <h3>ÊúüÈñì1</h3>
                    <label>ÈñãÂßãÊúàÔºö</label>
                    <input type="month" id="period1Start" class="period-month-input">
                    <label>ÁµÇ‰∫ÜÊúàÔºö</label>
                    <input type="month" id="period1End" class="period-month-input">
                </div>
                <div class="period-input">
                    <h3>ÊúüÈñì2</h3>
                    <label>ÈñãÂßãÊúàÔºö</label>
                    <input type="month" id="period2Start" class="period-month-input">
                    <label>ÁµÇ‰∫ÜÊúàÔºö</label>
                    <input type="month" id="period2End" class="period-month-input">
                </div>
            </div>
            <button onclick="comparePeriods()" style="padding: 10px 24px; background-color: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; margin-bottom: 20px;">ÊúüÈñì„ÇíÊØîËºÉ</button>
            
            <div class="comparison-results" id="comparisonResults">
                <!-- ÂãïÁöÑ„Å´ÁµêÊûú„ÅåÊåøÂÖ•„Åï„Çå„Çã -->
            </div>
        </div>
        
        <div class="regional-table" id="regionalTable">
            <h2>Âú∞ÂüüÂà•Ë©≥Á¥∞„Éá„Éº„Çø</h2>
            <table id="regionalTableContent">
                <thead>
                    <tr>
                        <th>Âú∞Âüü</th>
                        <th>Á¥îÂàùË®∫</th>
                        <th>ÂÜçÂàùË®∫</th>
                        <th>ÂêàË®à</th>
                        <th>Á¥îÂàùË®∫Áéá</th>
                        <th>ÂâçÊúàÊØî</th>
                    </tr>
                </thead>
                <tbody id="regionalTableBody">
                </tbody>
            </table>
        </div>
    </div>
    
    <script>
        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        let allData = [];
        let monthlyData = {};
        let currentChart = null;
        let regionalChartInstance = null;
        let comparisonChartInstance = null;
        let wardChartInstance = null;
        
        // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Åã„Çâ„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø
        function loadDataFromLocalStorage() {
            try {
                const savedData = localStorage.getItem('liberalArtsPatientData');
                if (savedData) {
                    allData = JSON.parse(savedData);
                    document.getElementById('dataInfo').style.display = 'block';
                    document.getElementById('dataCount').textContent = allData.length;
                    
                    // „Éá„Éº„ÇøÂàÜÊûê„ÇíÂÆüË°å
                    analyzeData();
                    setDateRange();
                    
                    // UI„ÇíË°®Á§∫
                    document.getElementById('controls').style.display = 'block';
                    document.getElementById('summaryCards').style.display = 'grid';
                    document.getElementById('tabs').style.display = 'flex';
                    document.getElementById('monthlyChart').style.display = 'block';
                    document.getElementById('regionalTable').style.display = 'block';
                    
                    // Ë°®Á§∫„ÇíÊõ¥Êñ∞
                    updateDisplay();
                    
                    console.log(`„É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Åã„Çâ${allData.length}‰ª∂„ÅÆ„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü`);
                }
            } catch (error) {
                console.error('„É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Åã„Çâ„ÅÆ„Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
            }
        }
        
        // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Å´„Éá„Éº„Çø„Çí‰øùÂ≠ò
        function saveDataToLocalStorage() {
            try {
                localStorage.setItem('liberalArtsPatientData', JSON.stringify(allData));
                console.log(`„É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Å´${allData.length}‰ª∂„ÅÆ„Éá„Éº„Çø„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü`);
            } catch (error) {
                console.error('„É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Å∏„ÅÆ‰øùÂ≠ò„Ç®„É©„Éº:', error);
                if (error.name === 'QuotaExceededError') {
                    showError('„É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„ÅÆÂÆπÈáè„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇÂè§„ÅÑ„Éá„Éº„Çø„Çí„ÇØ„É™„Ç¢„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                }
            }
        }
        
        // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„Å´„É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Åã„Çâ„Éá„Éº„Çø„ÇíÂæ©ÂÖÉ
        window.addEventListener('load', () => {
            loadDataFromLocalStorage();
        });
        
        // Â§ßÈò™Â∏Ç„ÅÆÂå∫„É™„Çπ„Éà
        const osakaWards = [
            'ÂåóÂå∫', 'ÈÉΩÂ≥∂Âå∫', 'Á¶èÂ≥∂Âå∫', 'Ê≠§Ëä±Âå∫', '‰∏≠Â§ÆÂå∫', 'Ë•øÂå∫', 'Ê∏ØÂå∫', 'Â§ßÊ≠£Âå∫',
            'Â§©ÁéãÂØ∫Âå∫', 'Êµ™ÈÄüÂå∫', 'Ë•øÊ∑ÄÂ∑ùÂå∫', 'Ê∑ÄÂ∑ùÂå∫', 'Êù±Ê∑ÄÂ∑ùÂå∫', 'Êù±ÊàêÂå∫', 'ÁîüÈáéÂå∫',
            'Êó≠Âå∫', 'ÂüéÊù±Âå∫', 'È∂¥Ë¶ãÂå∫', 'ÈòøÂÄçÈáéÂå∫', '‰Ωè‰πãÊ±üÂå∫', '‰ΩèÂêâÂå∫', 'Êù±‰ΩèÂêâÂå∫',
            'Âπ≥ÈáéÂå∫', 'Ë•øÊàêÂå∫'
        ];
        
        // Â§ßÈò™Â∫úÂÜÖ„ÅÆ‰∏ªË¶ÅÈÉΩÂ∏Ç
        const osakaCities = [
            'Â†∫Â∏Ç', 'Êù±Â§ßÈò™Â∏Ç', 'ÊûöÊñπÂ∏Ç', 'Ë±ä‰∏≠Â∏Ç', 'ÂêπÁî∞Â∏Ç', 'È´òÊßªÂ∏Ç', 'Ëå®Êú®Â∏Ç', 'ÂÖ´Â∞æÂ∏Ç',
            'ÂØùÂ±ãÂ∑ùÂ∏Ç', 'Â≤∏ÂíåÁî∞Â∏Ç', 'ÂíåÊ≥âÂ∏Ç', 'ÂÆàÂè£Â∏Ç', 'ÈñÄÁúüÂ∏Ç', 'ÊùæÂéüÂ∏Ç', 'Â§ßÊù±Â∏Ç',
            'ÁÆïÈù¢Â∏Ç', 'ÁæΩÊõ≥ÈáéÂ∏Ç', 'ÊëÇÊ¥•Â∏Ç', 'ÂØåÁî∞ÊûóÂ∏Ç', 'Ê≤≥ÂÜÖÈï∑ÈáéÂ∏Ç', 'Ê±†Áî∞Â∏Ç', 'Ê≥âÂ§ßÊ¥•Â∏Ç',
            'Ê≥â‰ΩêÈáéÂ∏Ç', 'Ë≤ùÂ°öÂ∏Ç', 'Ëó§‰∫ïÂØ∫Â∏Ç', 'Ê≥âÂçóÂ∏Ç', 'ÊüèÂéüÂ∏Ç', '‰∫§ÈáéÂ∏Ç', 'Â§ßÈò™Áã≠Â±±Â∏Ç', 'Èò™ÂçóÂ∏Ç'
        ];
        
        // „Éï„Ç°„Ç§„É´„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÂá¶ÁêÜ
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        
        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });
        
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });
        
        // „Éï„Ç°„Ç§„É´Âá¶ÁêÜ
        function handleFile(file) {
            if (!file.name.endsWith('.csv')) {
                showError('CSV„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            showLoading(true);
            
            // „Ç∞„É©„Éï„Ç§„É≥„Çπ„Çø„É≥„Çπ„Çí„ÇØ„É™„Ç¢
            if (currentChart) {
                currentChart.destroy();
                currentChart = null;
            }
            if (regionalChartInstance) {
                regionalChartInstance.destroy();
                regionalChartInstance = null;
            }
            if (comparisonChartInstance) {
                comparisonChartInstance.destroy();
                comparisonChartInstance = null;
            }
            if (wardChartInstance) {
                wardChartInstance.destroy();
                wardChartInstance = null;
            }
            
            // FileReader„Çí‰Ωø„Å£„Å¶UTF-8„Å®„Åó„Å¶Ë™≠„ÅøËæº„ÇÄ
            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                Papa.parse(text, {
                    header: true,
                    dynamicTyping: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        try {
                            processData(results.data);
                        } catch (error) {
                            showError('„Éá„Éº„Çø„ÅÆÂá¶ÁêÜ‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error.message);
                            showLoading(false);
                        }
                    },
                    error: function(error) {
                        showError('„Éï„Ç°„Ç§„É´„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
                        showLoading(false);
                    }
                });
            };
            reader.readAsText(file, 'UTF-8');
        }
        
        // „Éá„Éº„ÇøÂá¶ÁêÜ
        function processData(data) {
            // „Éá„Éê„ÉÉ„Ç∞: ÊúÄÂàù„ÅÆË°å„ÅÆ„Ç≠„Éº„ÇíÁ¢∫Ë™ç
            if (data.length > 0) {
                console.log('CSV„ÅÆÂàóÂêç:', Object.keys(data[0]));
                console.log('ÂÆüÈöõ„ÅÆÂàóÂêç:', JSON.stringify(Object.keys(data[0])));
                console.log('ÊúÄÂàù„ÅÆ„Éá„Éº„ÇøË°å:', data[0]);
                console.log('ÊúÄÂàù„ÅÆ„Éá„Éº„ÇøË°åÔºàJSONÔºâ:', JSON.stringify(data[0], null, 2));
            }
            
            // Êó¢Â≠ò„Éá„Éº„Çø„Å´Êñ∞„Åó„ÅÑ„Éá„Éº„Çø„ÇíËøΩÂä†ÔºàÈáçË§á„ÇíÈÅø„Åë„Çã„Åü„ÇÅÔºâ
            const existingKeys = new Set(allData.map(row => `${row['Êó•‰ªò']}_${row['ÊÇ£ËÄÖÁï™Âè∑']}`));
            const newData = data.filter(row => !existingKeys.has(`${row['Êó•‰ªò']}_${row['ÊÇ£ËÄÖÁï™Âè∑']}`));
            allData = [...allData, ...newData];
            
            // „Éá„Éº„ÇøÊÉÖÂ†±„ÇíÊõ¥Êñ∞
            document.getElementById('dataInfo').style.display = 'block';
            document.getElementById('dataCount').textContent = allData.length;
            
            // „Éá„Éº„ÇøÂàÜÊûê„ÇíÂÆüË°å
            analyzeData();
            
            // Êó•‰ªòÁØÑÂõ≤„ÇíË®≠ÂÆöÔºà„Éá„Éº„ÇøÂàÜÊûêÂæå„Å´ÂÆüË°åÔºâ
            setDateRange();
            
            // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Å´‰øùÂ≠ò
            saveDataToLocalStorage();
            
            // Âá¶ÁêÜ„ÅåÂÆå‰∫Ü„Åó„Å¶„Åã„ÇâUI„ÇíË°®Á§∫Ôºà100msÈÅÖÂª∂Ôºâ
            setTimeout(() => {
                showLoading(false);
                
                // UI„ÇíË°®Á§∫
                document.getElementById('controls').style.display = 'block';
                document.getElementById('summaryCards').style.display = 'grid';
                document.getElementById('tabs').style.display = 'flex';
                document.getElementById('monthlyChart').style.display = 'block';
                document.getElementById('regionalTable').style.display = 'block';
                
                // Ë°®Á§∫„ÇíÊõ¥Êñ∞
                updateDisplay();
            }, 100);
        }
        
        // „Éá„Éº„ÇøÂàÜÊûê
        function analyzeData() {
            monthlyData = {};
            
            // Êúà„Åî„Å®„Å´„Ç∞„É´„Éº„ÉóÂåñ
            let processedCount = 0;
            let errorCount = 0;
            
            allData.forEach((row, index) => {
                try {
                    if (!row['Êó•‰ªò'] || !row['ÂàùË®∫„ÉªÂÜçË®∫']) {
                        errorCount++;
                        if (index < 5) { // ÊúÄÂàù„ÅÆ5Ë°å„Å†„Åë„Éá„Éê„ÉÉ„Ç∞Âá∫Âäõ
                            console.log(`„Ç®„É©„ÉºË°å ${index}:`, row);
                            console.log(`Ë°å„ÅÆ„Ç≠„Éº:`, Object.keys(row));
                            console.log(`Êó•‰ªò: ${row['Êó•‰ªò']}, ÂàùË®∫„ÉªÂÜçË®∫: ${row['ÂàùË®∫„ÉªÂÜçË®∫']}`);
                            // „Åô„Åπ„Å¶„ÅÆÂàó„ÇíË°®Á§∫
                            for (const [key, value] of Object.entries(row)) {
                                console.log(`  ${key}: ${value}`);
                            }
                        }
                        return;
                    }
                    
                    const date = new Date(row['Êó•‰ªò']);
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    
                    if (!monthKey || monthKey.includes('NaN')) {
                        errorCount++;
                        console.error('ÁÑ°Âäπ„Å™Êó•‰ªò:', row['Êó•‰ªò']);
                        return;
                    }
                    
                    processedCount++;
                    
                    if (!monthlyData[monthKey]) {
                        monthlyData[monthKey] = {
                            allRecords: [],
                            firstVisits: [],
                            returnVisits: [],
                            maxPatientNumber: 0
                        };
                    }
                    
                    monthlyData[monthKey].allRecords.push(row);
                    
                    if (row['ÂàùË®∫„ÉªÂÜçË®∫'] === 'ÂàùË®∫') {
                        monthlyData[monthKey].firstVisits.push(row);
                        // ÂàùË®∫„ÅÆÊúÄÂ§ßÊÇ£ËÄÖÁï™Âè∑„ÅÆ„Åø„ÇíËøΩË∑°ÔºàÂ¢ÉÁïåË®àÁÆóÁî®Ôºâ
                        if (row['ÊÇ£ËÄÖÁï™Âè∑'] > monthlyData[monthKey].maxPatientNumber) {
                            monthlyData[monthKey].maxPatientNumber = row['ÊÇ£ËÄÖÁï™Âè∑'];
                        }
                    } else if (row['ÂàùË®∫„ÉªÂÜçË®∫'] === 'ÂÜçË®∫') {
                        monthlyData[monthKey].returnVisits.push(row);
                    }
                } catch (error) {
                    errorCount++;
                    console.error('„Éá„Éº„ÇøÂá¶ÁêÜ„Ç®„É©„Éº:', error, row);
                }
            });
            
            console.log(`Âá¶ÁêÜÂÆå‰∫Ü: ${processedCount}‰ª∂, „Ç®„É©„Éº: ${errorCount}‰ª∂`);
            
            // ÂêÑÊúà„ÅÆÂ¢ÉÁïåÁï™Âè∑„ÇíË®àÁÆóÔºàÂâçÊúà„ÅÆÊúÄÂ§ßÁï™Âè∑ + 1Ôºâ
            const sortedMonths = Object.keys(monthlyData).sort();
            // ÊúÄÂàù„ÅÆÊúà„ÅÆÊúÄÂ∞èÊÇ£ËÄÖÁï™Âè∑-1„ÇíÂàùÊúüÂÄ§„Å®„Åô„Çã
            let previousMax = 0;
            if (sortedMonths.length > 0) {
                const firstMonthData = monthlyData[sortedMonths[0]];
                let minPatientNumber = Number.MAX_SAFE_INTEGER;
                firstMonthData.allRecords.forEach(record => {
                    if (record['ÊÇ£ËÄÖÁï™Âè∑'] && record['ÊÇ£ËÄÖÁï™Âè∑'] < minPatientNumber) {
                        minPatientNumber = record['ÊÇ£ËÄÖÁï™Âè∑'];
                    }
                });
                previousMax = minPatientNumber > 1 ? minPatientNumber - 1 : 0;
            }
            
            sortedMonths.forEach((month, idx) => {
                // ÈÄöÂ∏∏„ÅÆÂ¢ÉÁïåË®àÁÆóÔºàÂâçÊúà„ÅÆÊúÄÂ§ßÁï™Âè∑ + 1Ôºâ
                monthlyData[month].boundary = previousMax + 1;
                
                // „Éá„Éê„ÉÉ„Ç∞Áî®„É≠„Ç∞
                if (month === '2024-07' || month === '2024-08') {
                    console.log(`\n=== ${month} ===`);
                    console.log(`Â¢ÉÁïå: ${monthlyData[month].boundary}`);
                    console.log(`ÂâçÊúà„ÅÆÂàùË®∫ÊúÄÂ§ß: ${previousMax}`);
                    console.log(`ÂΩìÊúà„ÅÆÂàùË®∫ÊúÄÂ§ß: ${monthlyData[month].maxPatientNumber}`);
                    console.log(`ÂàùË®∫Á∑èÊï∞: ${monthlyData[month].firstVisits.length}`);
                    
                    if (month === '2024-08') {
                        // 8Êúà„ÅÆÂàùË®∫ÊÇ£ËÄÖÁï™Âè∑„ÅÆÂàÜÂ∏É„ÇíÁ¢∫Ë™ç
                        const patientNumbers = monthlyData[month].firstVisits.map(r => r['ÊÇ£ËÄÖÁï™Âè∑']).sort((a, b) => a - b);
                        console.log(`8ÊúàÂàùË®∫ÊÇ£ËÄÖÁï™Âè∑ÁØÑÂõ≤: ${Math.min(...patientNumbers)} - ${Math.max(...patientNumbers)}`);
                        console.log(`8985‰ª•‰∏ä„ÅÆÊÇ£ËÄÖÊï∞: ${patientNumbers.filter(n => n >= 8985).length}`);
                        console.log(`8985Êú™Ê∫Ä„ÅÆÊÇ£ËÄÖÊï∞: ${patientNumbers.filter(n => n < 8985).length}`);
                    }
                }
                
                previousMax = monthlyData[month].maxPatientNumber;
                
                // Á¥îÂàùË®∫„Å®ÂÜçÂàùË®∫„ÇíÂàÜÈ°û
                const boundary = monthlyData[month].boundary;
                monthlyData[month].pureFirst = [];
                monthlyData[month].reFirst = [];
                
                // „É¶„Éã„Éº„ÇØÊÇ£ËÄÖ„ÅßÈõÜË®à
                const processedPatients = new Set();
                
                monthlyData[month].firstVisits.forEach(record => {
                    const patientId = record['ÊÇ£ËÄÖÁï™Âè∑'];
                    if (!processedPatients.has(patientId)) {
                        processedPatients.add(patientId);
                        
                        if (patientId >= boundary) {
                            monthlyData[month].pureFirst.push(record);
                        } else {
                            monthlyData[month].reFirst.push(record);
                        }
                    }
                });
                
                // „Éá„Éê„ÉÉ„Ç∞Áî®„É≠„Ç∞ÔºàÁ¥îÂàùË®∫„ÉªÂÜçÂàùË®∫„ÅÆÂàÜÈ°ûÁµêÊûúÔºâ
                if (month === '2024-07' || month === '2024-08') {
                    console.log(`${month} ÂàÜÈ°ûÁµêÊûú - Á¥îÂàùË®∫: ${monthlyData[month].pureFirst.length}, ÂÜçÂàùË®∫: ${monthlyData[month].reFirst.length}`);
                    
                    if (month === '2024-08' && monthlyData[month].pureFirst.length === 0) {
                        console.warn('Ë≠¶Âëä: 8Êúà„ÅÆÁ¥îÂàùË®∫„Åå0‰ª∂„Åß„ÅôÔºÅ');
                        // ÊúÄÂàù„ÅÆ5‰ª∂„ÅÆÊÇ£ËÄÖÁï™Âè∑„Å®Â¢ÉÁïå„ÇíÊØîËºÉ
                        const first5 = monthlyData[month].firstVisits.slice(0, 5);
                        first5.forEach(record => {
                            console.log(`ÊÇ£ËÄÖÁï™Âè∑: ${record['ÊÇ£ËÄÖÁï™Âè∑']}, Â¢ÉÁïå: ${boundary}, Âà§ÂÆö: ${record['ÊÇ£ËÄÖÁï™Âè∑'] >= boundary ? 'Á¥îÂàùË®∫' : 'ÂÜçÂàùË®∫'}`);
                        });
                    }
                }
                
                // Âú∞ÂüüÂà•ÈõÜË®à
                monthlyData[month].regional = analyzeRegional(monthlyData[month].pureFirst, monthlyData[month].reFirst);
            });
            
            updateDisplay();
        }
        
        // Âú∞ÂüüÂàÜÊûê
        function analyzeRegional(pureFirst, reFirst) {
            const regional = {
                pure: {},
                re: {}
            };
            
            // Â§ßÈò™Â∏ÇÂêÑÂå∫„ÅÆÂàùÊúüÂåñ
            osakaWards.forEach(ward => {
                regional.pure[ward] = 0;
                regional.re[ward] = 0;
            });
            
            // Â§ßÈò™Â∫úÂÜÖÂêÑÂ∏Ç„ÅÆÂàùÊúüÂåñ
            regional.pure['Â§ßÈò™Â∫úÂÜÖ„Åù„ÅÆ‰ªñ'] = 0;
            regional.re['Â§ßÈò™Â∫úÂÜÖ„Åù„ÅÆ‰ªñ'] = 0;
            
            // Á¥îÂàùË®∫„ÅÆÂú∞ÂüüÂà•ÈõÜË®à
            pureFirst.forEach(record => {
                const address = record['ÊÇ£ËÄÖ‰ΩèÊâÄ'] || '';
                const region = classifyAddress(address);
                
                if (!regional.pure[region]) {
                    regional.pure[region] = 0;
                }
                regional.pure[region]++;
            });
            
            // ÂÜçÂàùË®∫„ÅÆÂú∞ÂüüÂà•ÈõÜË®à
            reFirst.forEach(record => {
                const address = record['ÊÇ£ËÄÖ‰ΩèÊâÄ'] || '';
                const region = classifyAddress(address);
                
                if (!regional.re[region]) {
                    regional.re[region] = 0;
                }
                regional.re[region]++;
            });
            
            return regional;
        }
        
        // ‰ΩèÊâÄ„Åã„ÇâÂú∞Âüü„ÇíÂàÜÈ°û
        function classifyAddress(address) {
            if (!address) return '„Åù„ÅÆ‰ªñ';
            
            // Â§ßÈò™Â∏Ç„ÅÆÂå∫„ÇíÂà§ÂÆö
            for (const ward of osakaWards) {
                if (address.includes(`Â§ßÈò™Â∏Ç${ward}`)) {
                    return ward;
                }
            }
            
            // Â§ßÈò™Â∫úÂÜÖ„ÅÆÂ∏Ç„ÇíÂà§ÂÆö
            for (const city of osakaCities) {
                if (address.includes(city)) {
                    return city;
                }
            }
            
            // ‰ªñÂ∫úÁúå
            const prefectures = {
                'ÂÖµÂ∫´Áúå': ['ÂÖµÂ∫´Áúå', 'Á•ûÊà∏Â∏Ç', 'Â∞ºÂ¥éÂ∏Ç', 'Ë•øÂÆÆÂ∏Ç', 'Ëä¶Â±ãÂ∏Ç', '‰ºä‰∏πÂ∏Ç', 'ÂÆùÂ°öÂ∏Ç'],
                '‰∫¨ÈÉΩÂ∫ú': ['‰∫¨ÈÉΩÂ∫ú', '‰∫¨ÈÉΩÂ∏Ç', 'ÂÆáÊ≤ªÂ∏Ç', '‰∫ÄÂ≤°Â∏Ç'],
                'Êù±‰∫¨ÈÉΩ': ['Êù±‰∫¨ÈÉΩ', 'ÂçÉ‰ª£Áî∞Âå∫', '‰∏≠Â§ÆÂå∫', 'Ê∏ØÂå∫', 'Êñ∞ÂÆøÂå∫', 'Êñá‰∫¨Âå∫', 'Âè∞Êù±Âå∫', 'Â¢®Áî∞Âå∫', 'Ê±üÊù±Âå∫', 'ÂìÅÂ∑ùÂå∫', 'ÁõÆÈªíÂå∫', 'Â§ßÁî∞Âå∫', '‰∏ñÁî∞Ë∞∑Âå∫', 'Ê∏ãË∞∑Âå∫', '‰∏≠ÈáéÂå∫', 'Êùâ‰∏¶Âå∫', 'Ë±äÂ≥∂Âå∫', 'ÂåóÂå∫', 'ËçíÂ∑ùÂå∫', 'ÊùøÊ©ãÂå∫', 'Á∑¥È¶¨Âå∫', 'Ë∂≥Á´ãÂå∫', 'ËëõÈ£æÂå∫', 'Ê±üÊà∏Â∑ùÂå∫'],
                'Â•àËâØÁúå': ['Â•àËâØÁúå', 'Â•àËâØÂ∏Ç', 'Â§ßÂíåÈ´òÁî∞Â∏Ç', 'Â§ßÂíåÈÉ°Â±±Â∏Ç'],
                'ÂíåÊ≠åÂ±±Áúå': ['ÂíåÊ≠åÂ±±Áúå', 'ÂíåÊ≠åÂ±±Â∏Ç'],
                'ÊªãË≥ÄÁúå': ['ÊªãË≥ÄÁúå', 'Â§ßÊ¥•Â∏Ç', 'ËçâÊ¥•Â∏Ç']
            };
            
            for (const [pref, keywords] of Object.entries(prefectures)) {
                for (const keyword of keywords) {
                    if (address.includes(keyword)) {
                        return pref;
                    }
                }
            }
            
            // Â§ßÈò™Â∫úÂÜÖ„ÅÆ„Åù„ÅÆ‰ªñ
            if (address.includes('Â§ßÈò™Â∫ú') || address.includes('Â∫ú')) {
                return 'Â§ßÈò™Â∫úÂÜÖ„Åù„ÅÆ‰ªñ';
            }
            
            return '„Åù„ÅÆ‰ªñ';
        }
        
        // Êó•‰ªòÁØÑÂõ≤„ÇíË®≠ÂÆö
        function setDateRange() {
            const months = Object.keys(monthlyData).sort();
            if (months.length > 0) {
                document.getElementById('startMonth').value = months[0];
                document.getElementById('endMonth').value = months[months.length - 1];
                
                // ÊúàÂà•„Éú„Çø„É≥„ÇíÁîüÊàê
                generateMonthButtons(months);
            }
        }
        
        // ÊúàÂà•„Éú„Çø„É≥„ÇíÁîüÊàê
        function generateMonthButtons(months) {
            const container = document.getElementById('monthButtons');
            container.innerHTML = '<span style="margin-right: 10px;">ÊúàÂà•ÈÅ∏ÊäûÔºö</span>';
            
            // ÊúÄÊñ∞„ÅÆ12„É∂ÊúàÂàÜ„ÅÆ„Éú„Çø„É≥„ÇíË°®Á§∫
            const recentMonths = months.slice(-12);
            
            recentMonths.forEach(month => {
                const [year, mon] = month.split('-');
                const button = document.createElement('button');
                button.textContent = `${year}/${mon}`;
                button.style.cssText = 'padding: 3px 8px; margin: 2px; background-color: #ecf0f1; color: #333; border: 1px solid #bdc3c7; border-radius: 3px; cursor: pointer;';
                button.onclick = () => selectSingleMonth(month);
                container.appendChild(button);
            });
        }
        
        // ÁâπÂÆö„ÅÆÊúà„ÇíÈÅ∏Êäû
        function selectSingleMonth(month) {
            document.getElementById('startMonth').value = month;
            document.getElementById('endMonth').value = month;
            updateAnalysis();
        }
        
        // Ë°®Á§∫Êõ¥Êñ∞
        function updateDisplay() {
            let startMonth = document.getElementById('startMonth').value;
            let endMonth = document.getElementById('endMonth').value;
            
            // ÊúüÈñì„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØ„ÄÅËá™ÂãïÁöÑ„Å´Ë®≠ÂÆö
            if (!startMonth || !endMonth) {
                setDateRange();
                startMonth = document.getElementById('startMonth').value;
                endMonth = document.getElementById('endMonth').value;
                
                if (!startMonth || !endMonth) {
                    showError('ÊúüÈñì„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    return;
                }
            }
            
            const filteredMonths = Object.keys(monthlyData)
                .filter(month => month >= startMonth && month <= endMonth)
                .sort();
            
            if (filteredMonths.length === 0) {
                showError('ÈÅ∏Êäû„Åï„Çå„ÅüÊúüÈñì„Å´„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                return;
            }
            
            // „Çµ„Éû„É™„Éº„Ç´„Éº„Éâ„ÇíÊõ¥Êñ∞
            updateSummaryCards(filteredMonths);
            
            // „Ç∞„É©„Éï„ÇíÊõ¥Êñ∞
            updateMonthlyChart(filteredMonths);
            
            // Âú∞ÂüüÂà•„ÉÜ„Éº„Éñ„É´„ÇíÊõ¥Êñ∞
            updateRegionalTable(filteredMonths);
        }
        
        // „Çµ„Éû„É™„Éº„Ç´„Éº„ÉâÊõ¥Êñ∞
        function updateSummaryCards(months) {
            const lastMonth = months[months.length - 1];
            const prevMonth = months.length > 1 ? months[months.length - 2] : null;
            const lastYearMonth = getLastYearMonth(lastMonth);
            
            // Ë°®Á§∫Êúà„ÇíÊõ¥Êñ∞
            const [year, mon] = lastMonth.split('-');
            document.getElementById('currentPeriodDisplay').textContent = `${year}Âπ¥${parseInt(mon)}Êúà„ÅÆ„Éá„Éº„Çø`;
            
            const lastData = monthlyData[lastMonth];
            const pureCount = lastData.pureFirst.length;
            const reFirstCount = lastData.reFirst.length;
            const returnCount = lastData.returnVisits.length;
            const totalFirstVisits = pureCount + reFirstCount;
            const totalAllVisits = pureCount + reFirstCount + returnCount;
            
            // ÂÖ®ÊÇ£ËÄÖ„Å´ÂØæ„Åô„ÇãÂâ≤Âêà
            const pureRateAll = totalAllVisits > 0 ? (pureCount / totalAllVisits * 100).toFixed(1) : 0;
            const reFirstRateAll = totalAllVisits > 0 ? (reFirstCount / totalAllVisits * 100).toFixed(1) : 0;
            const returnRateAll = totalAllVisits > 0 ? (returnCount / totalAllVisits * 100).toFixed(1) : 0;
            
            document.getElementById('pureFirstValue').textContent = pureCount.toLocaleString() + '‰∫∫';
            document.getElementById('reFirstValue').textContent = reFirstCount.toLocaleString() + '‰∫∫';
            document.getElementById('totalFirstValue').textContent = totalFirstVisits.toLocaleString() + '‰∫∫';
            document.getElementById('pureRateValue').textContent = pureRateAll + '%';
            document.getElementById('reRateValue').textContent = reFirstRateAll + '%';
            document.getElementById('returnValue').textContent = returnCount.toLocaleString() + '‰∫∫';
            document.getElementById('totalAllValue').textContent = totalAllVisits.toLocaleString() + '‰∫∫';
            document.getElementById('returnRateValue').textContent = returnRateAll + '%';
            
            // ÂâçÊúàÊØî„ÉªÂâçÂπ¥ÊØî„ÇíË®àÁÆó
            if (prevMonth && monthlyData[prevMonth]) {
                const prevData = monthlyData[prevMonth];
                const prevPure = prevData.pureFirst.length;
                const prevReFirst = prevData.reFirst.length;
                const prevReturn = prevData.returnVisits.length;
                const prevTotalFirst = prevPure + prevReFirst;
                const prevTotalAll = prevPure + prevReFirst + prevReturn;
                
                const [prevYear, prevMon] = prevMonth.split('-');
                const prevMonthLabel = `${prevYear}Âπ¥${parseInt(prevMon)}ÊúàÊØî`;
                
                document.getElementById('pureFirstChange').innerHTML = getChangeText(pureCount, prevPure, prevMonthLabel);
                document.getElementById('reFirstChange').innerHTML = getChangeText(reFirstCount, prevReFirst, prevMonthLabel);
                document.getElementById('totalFirstChange').innerHTML = getChangeText(totalFirstVisits, prevTotalFirst, prevMonthLabel);
                document.getElementById('returnChange').innerHTML = getChangeText(returnCount, prevReturn, prevMonthLabel);
                document.getElementById('totalAllChange').innerHTML = getChangeText(totalAllVisits, prevTotalAll, prevMonthLabel);
            } else {
                document.getElementById('pureFirstChange').textContent = 'ÂâçÊúà„Éá„Éº„Çø„Å™„Åó';
                document.getElementById('reFirstChange').textContent = 'ÂâçÊúà„Éá„Éº„Çø„Å™„Åó';
                document.getElementById('totalFirstChange').textContent = 'ÂâçÊúà„Éá„Éº„Çø„Å™„Åó';
                document.getElementById('returnChange').textContent = 'ÂâçÊúà„Éá„Éº„Çø„Å™„Åó';
                document.getElementById('totalAllChange').textContent = 'ÂâçÊúà„Éá„Éº„Çø„Å™„Åó';
            }
            
            if (monthlyData[lastYearMonth]) {
                const lastYearData = monthlyData[lastYearMonth];
                const lastYearPure = lastYearData.pureFirst.length;
                const lastYearReFirst = lastYearData.reFirst.length;
                const lastYearReturn = lastYearData.returnVisits.length;
                const lastYearTotalAll = lastYearPure + lastYearReFirst + lastYearReturn;
                
                if (lastYearTotalAll > 0) {
                    const lastYearPureRate = (lastYearPure / lastYearTotalAll * 100).toFixed(1);
                    const lastYearReRate = (lastYearReFirst / lastYearTotalAll * 100).toFixed(1);
                    const lastYearReturnRate = (lastYearReturn / lastYearTotalAll * 100).toFixed(1);
                    
                    const pureRateChange = (parseFloat(pureRateAll) - parseFloat(lastYearPureRate)).toFixed(1);
                    const reRateChange = (parseFloat(reFirstRateAll) - parseFloat(lastYearReRate)).toFixed(1);
                    const returnRateChange = (parseFloat(returnRateAll) - parseFloat(lastYearReturnRate)).toFixed(1);
                    
                    const [lyYear, lyMon] = lastYearMonth.split('-');
                    const pureChangeClass = pureRateChange > 0 ? 'increase' : 'decrease';
                    const reChangeClass = reRateChange > 0 ? 'increase' : 'decrease';
                    const returnChangeClass = returnRateChange > 0 ? 'increase' : 'decrease';
                    
                    document.getElementById('pureRateChange').innerHTML = 
                        `${lyYear}Âπ¥${parseInt(lyMon)}ÊúàÊØî: <span class="${pureChangeClass}">${pureRateChange > 0 ? '+' : ''}${pureRateChange}pt</span>`;
                    document.getElementById('reRateChange').innerHTML = 
                        `${lyYear}Âπ¥${parseInt(lyMon)}ÊúàÊØî: <span class="${reChangeClass}">${reRateChange > 0 ? '+' : ''}${reRateChange}pt</span>`;
                    document.getElementById('returnRateChange').innerHTML = 
                        `${lyYear}Âπ¥${parseInt(lyMon)}ÊúàÊØî: <span class="${returnChangeClass}">${returnRateChange > 0 ? '+' : ''}${returnRateChange}pt</span>`;
                }
            } else {
                document.getElementById('pureRateChange').textContent = 'ÂâçÂπ¥ÂêåÊúà„Éá„Éº„Çø„Å™„Åó';
                document.getElementById('reRateChange').textContent = 'ÂâçÂπ¥ÂêåÊúà„Éá„Éº„Çø„Å™„Åó';
                document.getElementById('returnRateChange').textContent = 'ÂâçÂπ¥ÂêåÊúà„Éá„Éº„Çø„Å™„Åó';
            }
        }
        
        // „Ç∞„É©„Éï„Çø„Ç§„ÉóÂàá„ÇäÊõø„ÅàÁî®Èñ¢Êï∞
        function updateMonthlyChartDisplay() {
            updateDisplay();
        }
        
        // ÊúàÂà•„Ç∞„É©„ÉïÊõ¥Êñ∞
        function updateMonthlyChart(months) {
            const chartType = document.getElementById('monthlyChartType')?.value || 'combined';
            renderMonthlyChart(months, chartType);
        }
        
        function renderMonthlyChart(months, chartType = 'combined') {
            const ctx = document.getElementById('monthlyCanvas').getContext('2d');
            
            const labels = months.map(month => {
                const [year, mon] = month.split('-');
                return `${year}Âπ¥${parseInt(mon)}Êúà`;
            });
            
            const pureData = months.map(month => monthlyData[month].pureFirst.length);
            const reData = months.map(month => monthlyData[month].reFirst.length);
            const returnData = months.map(month => monthlyData[month].returnVisits.length);
            
            // ÂÖ®ÊÇ£ËÄÖ„Å´ÂØæ„Åô„ÇãÁ¥îÂàùË®∫Áéá
            const pureRateData = months.map(month => {
                const pure = monthlyData[month].pureFirst.length;
                const reFirst = monthlyData[month].reFirst.length;
                const returns = monthlyData[month].returnVisits.length;
                const total = pure + reFirst + returns;
                return total > 0 ? (pure / total * 100).toFixed(1) : 0;
            });
            
            // ÂÖ®ÊÇ£ËÄÖ„Å´ÂØæ„Åô„ÇãÂÜçÂàùË®∫Áéá
            const reFirstRateData = months.map(month => {
                const pure = monthlyData[month].pureFirst.length;
                const reFirst = monthlyData[month].reFirst.length;
                const returns = monthlyData[month].returnVisits.length;
                const total = pure + reFirst + returns;
                return total > 0 ? (reFirst / total * 100).toFixed(1) : 0;
            });
            
            // ÂàùË®∫ÂÜÖ„Åß„ÅÆÁ¥îÂàùË®∫Áéá
            const pureRateInFirstData = months.map(month => {
                const pure = monthlyData[month].pureFirst.length;
                const reFirst = monthlyData[month].reFirst.length;
                const totalFirst = pure + reFirst;
                return totalFirst > 0 ? (pure / totalFirst * 100).toFixed(1) : 0;
            });
            
            // ÂàùË®∫ÂÜÖ„Åß„ÅÆÂÜçÂàùË®∫Áéá
            const reRateInFirstData = months.map(month => {
                const pure = monthlyData[month].pureFirst.length;
                const reFirst = monthlyData[month].reFirst.length;
                const totalFirst = pure + reFirst;
                return totalFirst > 0 ? (reFirst / totalFirst * 100).toFixed(1) : 0;
            });
            
            
            if (currentChart) {
                currentChart.destroy();
            }
            
            let datasets = [];
            let yScales = {};
            
            switch (chartType) {
                case 'combined':
                    datasets = [
                        {
                            label: 'Á¥îÂàùË®∫',
                            data: pureData,
                            backgroundColor: '#3498db',
                            yAxisID: 'y'
                        },
                        {
                            label: 'ÂÜçÂàùË®∫',
                            data: reData,
                            backgroundColor: '#2ecc71',
                            yAxisID: 'y'
                        },
                        {
                            label: 'Á¥îÂàùË®∫Áéá',
                            data: pureRateData,
                            type: 'line',
                            borderColor: '#3498db',
                            backgroundColor: 'transparent',
                            yAxisID: 'y1',
                            borderWidth: 3,
                            tension: 0.1,
                        },
                        {
                            label: 'ÂÜçÂàùË®∫Áéá',
                            data: reFirstRateData,
                            type: 'line',
                            borderColor: '#9b59b6',
                            backgroundColor: 'transparent',
                            yAxisID: 'y1',
                            borderWidth: 3,
                            tension: 0.1
                        }
                    ];
                    yScales = {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'ÊÇ£ËÄÖÊï∞Ôºà‰∫∫Ôºâ'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            min: 0,
                            max: 100,
                            title: {
                                display: true,
                                text: 'ÊØîÁéáÔºà%Ôºâ'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    };
                    break;
                    
                case 'counts':
                    datasets = [
                        {
                            label: 'Á¥îÂàùË®∫',
                            data: pureData,
                            backgroundColor: '#3498db'
                        },
                        {
                            label: 'ÂÜçÂàùË®∫',
                            data: reData,
                            backgroundColor: '#2ecc71'
                        },
                        {
                            label: 'ÂÜçË®∫',
                            data: returnData,
                            backgroundColor: '#e67e22'
                        }
                    ];
                    yScales = {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'ÊÇ£ËÄÖÊï∞Ôºà‰∫∫Ôºâ'
                            }
                        }
                    };
                    break;
                    
                case 'rates':
                    datasets = [
                        {
                            label: 'Á¥îÂàùË®∫ÁéáÔºàÂÖ®ÊÇ£ËÄÖ‰∏≠Ôºâ',
                            data: pureRateData,
                            type: 'line',
                            borderColor: '#3498db',
                            backgroundColor: 'transparent',
                            borderWidth: 3,
                            tension: 0.1,
                        },
                        {
                            label: 'ÂÜçÂàùË®∫ÁéáÔºàÂÖ®ÊÇ£ËÄÖ‰∏≠Ôºâ',
                            data: reFirstRateData,
                            type: 'line',
                            borderColor: '#9b59b6',
                            backgroundColor: 'transparent',
                            borderWidth: 3,
                            tension: 0.1
                        },
                        {
                            label: 'Á¥îÂàùË®∫ÁéáÔºàÂàùË®∫ÂÜÖÔºâ',
                            data: pureRateInFirstData,
                            type: 'line',
                            borderColor: '#3498db',
                            borderDash: [5, 5],
                            backgroundColor: 'transparent',
                            borderWidth: 2,
                            tension: 0.1
                        },
                        {
                            label: 'ÂÜçÂàùË®∫ÁéáÔºàÂàùË®∫ÂÜÖÔºâ',
                            data: reRateInFirstData,
                            type: 'line',
                            borderColor: '#2ecc71',
                            borderDash: [5, 5],
                            backgroundColor: 'transparent',
                            borderWidth: 2,
                            tension: 0.1
                        }
                    ];
                    yScales = {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            min: 0,
                            max: 100,
                            title: {
                                display: true,
                                text: 'ÊØîÁéáÔºà%Ôºâ'
                            }
                        }
                    };
                    break;
                    
                case 'pure':
                    datasets = [
                        {
                            label: 'Á¥îÂàùË®∫Êï∞',
                            data: pureData,
                            backgroundColor: '#3498db',
                            yAxisID: 'y'
                        },
                        {
                            label: 'Á¥îÂàùË®∫ÁéáÔºàÂÖ®ÊÇ£ËÄÖ‰∏≠Ôºâ',
                            data: pureRateData,
                            type: 'line',
                            borderColor: '#3498db',
                            backgroundColor: 'transparent',
                            yAxisID: 'y1',
                            borderWidth: 3,
                            tension: 0.1,
                        },
                        {
                            label: 'Á¥îÂàùË®∫ÁéáÔºàÂàùË®∫ÂÜÖÔºâ',
                            data: pureRateInFirstData,
                            type: 'line',
                            borderColor: '#3498db',
                            borderDash: [5, 5],
                            backgroundColor: 'transparent',
                            yAxisID: 'y1',
                            borderWidth: 2,
                            tension: 0.1
                        }
                    ];
                    yScales = {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Á¥îÂàùË®∫Êï∞Ôºà‰∫∫Ôºâ'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            min: 0,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Á¥îÂàùË®∫ÁéáÔºà%Ôºâ'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    };
                    break;
                    
                case 're':
                    datasets = [
                        {
                            label: 'ÂÜçÂàùË®∫Êï∞',
                            data: reData,
                            backgroundColor: '#2ecc71',
                            yAxisID: 'y'
                        },
                        {
                            label: 'ÂÜçÂàùË®∫ÁéáÔºàÂÖ®ÊÇ£ËÄÖ‰∏≠Ôºâ',
                            data: reFirstRateData,
                            type: 'line',
                            borderColor: '#9b59b6',
                            backgroundColor: 'transparent',
                            yAxisID: 'y1',
                            borderWidth: 3,
                            tension: 0.1
                        },
                        {
                            label: 'ÂÜçÂàùË®∫ÁéáÔºàÂàùË®∫ÂÜÖÔºâ',
                            data: reRateInFirstData,
                            type: 'line',
                            borderColor: '#2ecc71',
                            borderDash: [5, 5],
                            backgroundColor: 'transparent',
                            yAxisID: 'y1',
                            borderWidth: 2,
                            tension: 0.1
                        }
                    ];
                    yScales = {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'ÂÜçÂàùË®∫Êï∞Ôºà‰∫∫Ôºâ'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            min: 0,
                            max: 100,
                            title: {
                                display: true,
                                text: 'ÂÜçÂàùË®∫ÁéáÔºà%Ôºâ'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    };
                    break;
            }
            
            currentChart = new Chart(ctx, {
                type: chartType === 'rates' ? 'line' : 'bar',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    aspectRatio: 2,
                    scales: yScales,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (label.includes('Áéá')) {
                                        label += context.parsed.y + '%';
                                    } else {
                                        label += context.parsed.y + '‰∫∫';
                                    }
                                    return label;
                                }
                            }
                        },
                        zoom: {
                            zoom: {
                                wheel: {
                                    enabled: true,
                                },
                                pinch: {
                                    enabled: true
                                },
                                mode: 'x',
                            },
                            pan: {
                                enabled: true,
                                mode: 'x',
                            }
                        },
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            formatter: (value, ctx) => {
                                if (ctx.dataset.type === 'line') {
                                    return value + '%';
                                }
                                return value;
                            },
                            color: '#666',
                            font: {
                                weight: 'bold',
                                size: 10
                            }
                        }
                    }
                }
            });
        }
        
        // Âú∞ÂüüÂà•„ÉÜ„Éº„Éñ„É´Êõ¥Êñ∞
        function updateRegionalTable(months) {
            const lastMonth = months[months.length - 1];
            const prevMonth = months.length > 1 ? months[months.length - 2] : null;
            
            const lastData = monthlyData[lastMonth].regional;
            const tbody = document.getElementById('regionalTableBody');
            tbody.innerHTML = '';
            
            // ÂÖ®Âú∞Âüü„ÇíÈõÜË®à
            const allRegions = new Set();
            Object.keys(lastData.pure).forEach(region => allRegions.add(region));
            Object.keys(lastData.re).forEach(region => allRegions.add(region));
            
            // Âú∞Âüü„Çí„ÇΩ„Éº„ÉàÔºàË•øÂå∫„ÇíÊúÄÂàù„Å´„ÄÅ„Åù„ÅÆ‰ªñ„ÅÆÂå∫„ÄÅÂ∫úÂÜÖÂ∏ÇÁî∫Êùë„ÄÅ‰ªñÂ∫úÁúå„ÅÆÈ†ÜÔºâ
            const sortedRegions = Array.from(allRegions).sort((a, b) => {
                if (a === 'Ë•øÂå∫') return -1;
                if (b === 'Ë•øÂå∫') return 1;
                if (osakaWards.includes(a) && !osakaWards.includes(b)) return -1;
                if (!osakaWards.includes(a) && osakaWards.includes(b)) return 1;
                return a.localeCompare(b);
            });
            
            sortedRegions.forEach(region => {
                const pure = lastData.pure[region] || 0;
                const re = lastData.re[region] || 0;
                const total = pure + re;
                
                if (total === 0) return; // „Éá„Éº„Çø„Åå„Å™„ÅÑÂú∞Âüü„ÅØË°®Á§∫„Åó„Å™„ÅÑ
                
                const rate = total > 0 ? (pure / total * 100).toFixed(1) : 0;
                
                let prevChange = '-';
                if (prevMonth && monthlyData[prevMonth].regional) {
                    const prevPure = monthlyData[prevMonth].regional.pure[region] || 0;
                    const prevRe = monthlyData[prevMonth].regional.re[region] || 0;
                    const prevTotal = prevPure + prevRe;
                    
                    if (prevTotal > 0) {
                        const change = ((total - prevTotal) / prevTotal * 100).toFixed(1);
                        const changeClass = change > 0 ? 'increase' : 'decrease';
                        prevChange = `<span class="${changeClass}">${change > 0 ? '+' : ''}${change}%</span>`;
                    }
                }
                
                const row = `
                    <tr>
                        <td>${region}</td>
                        <td>${pure}</td>
                        <td>${re}</td>
                        <td>${total}</td>
                        <td>${rate}%</td>
                        <td>${prevChange}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }
        
        // „Çø„ÉñÂàá„ÇäÊõø„Åà
        function switchTab(tabName) {
            // „Çø„Éñ„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÁä∂ÊÖã„ÇíÊõ¥Êñ∞
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // „ÉÅ„É£„Éº„Éà„ÅÆË°®Á§∫Âàá„ÇäÊõø„Åà
            document.getElementById('monthlyChart').style.display = 'none';
            document.getElementById('regionalChart').style.display = 'none';
            document.getElementById('comparisonChart').style.display = 'none';
            document.getElementById('wardChart').style.display = 'none';
            document.getElementById('periodComparisonContainer').style.display = 'none';
            
            switch(tabName) {
                case 'monthly':
                    document.getElementById('monthlyChart').style.display = 'block';
                    break;
                case 'regional':
                    document.getElementById('regionalChart').style.display = 'block';
                    updateRegionalChart();
                    break;
                case 'comparison':
                    document.getElementById('comparisonChart').style.display = 'block';
                    updateComparisonChart();
                    break;
                case 'ward':
                    document.getElementById('wardChart').style.display = 'block';
                    updateWardChart();
                    break;
                case 'periodComparison':
                    document.getElementById('periodComparisonContainer').style.display = 'block';
                    break;
            }
        }
        
        // Âú∞ÂüüÂà•„Ç∞„É©„Éï„ÅÆÁèæÂú®„ÅÆ„Çø„Ç§„Éó
        let currentRegionalChartType = 'bar';
        
        // Âú∞ÂüüÂà•„Ç∞„É©„ÉïÊõ¥Êñ∞
        function updateRegionalChart() {
            // Âú∞ÂüüÈÅ∏Êäû„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥„ÇíÊõ¥Êñ∞
            updateRegionSelect();
            // „Ç∞„É©„Éï„ÇíÊõ¥Êñ∞
            updateRegionalTrendChart();
        }
        
        // Âú∞ÂüüÈÅ∏Êäû„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥„ÇíÊõ¥Êñ∞
        function updateRegionSelect() {
            const startMonth = document.getElementById('startMonth').value;
            const endMonth = document.getElementById('endMonth').value;
            
            const filteredMonths = Object.keys(monthlyData)
                .filter(month => month >= startMonth && month <= endMonth)
                .sort();
            
            if (filteredMonths.length === 0) return;
            
            // ÂÖ®ÊúüÈñì„ÅÆÂú∞Âüü„ÇíÈõÜË®à
            const allRegions = new Set();
            filteredMonths.forEach(month => {
                const monthRegional = monthlyData[month].regional;
                Object.keys(monthRegional.pure).forEach(region => allRegions.add(region));
                Object.keys(monthRegional.re).forEach(region => allRegions.add(region));
            });
            
            // Âú∞Âüü„ÇíÈÖçÂàó„Å´Â§âÊèõ„Åó„Å¶„ÇΩ„Éº„Éà
            const sortedRegions = Array.from(allRegions).sort((a, b) => {
                // Ë•øÂå∫„ÇíÊúÄÂàù„Å´
                if (a === 'Ë•øÂå∫') return -1;
                if (b === 'Ë•øÂå∫') return 1;
                // Âå∫„ÇíÂÑ™ÂÖà
                const aIsWard = a.includes('Âå∫');
                const bIsWard = b.includes('Âå∫');
                if (aIsWard && !bIsWard) return -1;
                if (!aIsWard && bIsWard) return 1;
                return a.localeCompare(b);
            });
            
            const regionSelect = document.getElementById('regionSelect');
            const currentValue = regionSelect.value;
            
            // „Ç™„Éó„Ç∑„Éß„É≥„ÇíÊõ¥Êñ∞
            regionSelect.innerHTML = '<option value="all">ÂÖ®Âú∞Âüü</option>';
            sortedRegions.forEach(region => {
                const option = document.createElement('option');
                option.value = region;
                option.textContent = region;
                regionSelect.appendChild(option);
            });
            
            // ‰ª•Ââç„ÅÆÈÅ∏Êäû„ÇíÂæ©ÂÖÉ
            if (currentValue && Array.from(regionSelect.options).some(opt => opt.value === currentValue)) {
                regionSelect.value = currentValue;
            }
        }
        
        // Âú∞ÂüüÂà•ÊúàÂà•Êé®Áßª„Ç∞„É©„Éï„ÇíÊõ¥Êñ∞
        function updateRegionalTrendChart() {
            const selectedRegion = document.getElementById('regionSelect').value;
            const chartType = document.getElementById('regionalChartType').value;
            const startMonth = document.getElementById('startMonth').value;
            const endMonth = document.getElementById('endMonth').value;
            
            const filteredMonths = Object.keys(monthlyData)
                .filter(month => month >= startMonth && month <= endMonth)
                .sort();
            
            if (filteredMonths.length === 0) return;
            
            const ctx = document.getElementById('regionalCanvas').getContext('2d');
            
            if (regionalChartInstance) {
                regionalChartInstance.destroy();
            }
            
            const labels = filteredMonths.map(month => {
                const [year, mon] = month.split('-');
                return `${year}Âπ¥${parseInt(mon)}Êúà`;
            });
            
            let datasets = [];
            
            if (selectedRegion === 'all') {
                // ÂÖ®Âú∞Âüü„ÅÆÂ†¥Âêà„ÄÅ‰∏ä‰Ωç5Âú∞Âüü„ÇíË°®Á§∫
                const regionalTotals = {};
                
                filteredMonths.forEach(month => {
                    const monthRegional = monthlyData[month].regional;
                    Object.keys(monthRegional.pure).forEach(region => {
                        if (!regionalTotals[region]) regionalTotals[region] = 0;
                        regionalTotals[region] += monthRegional.pure[region] + (monthRegional.re[region] || 0);
                    });
                });
                
                // ‰∏ä‰Ωç5Âú∞Âüü„ÇíÂèñÂæó
                const top5Regions = Object.entries(regionalTotals)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5)
                    .map(([region]) => region);
                
                const colors = ['#3498db', '#2ecc71', '#e74c3c', '#f39c12', '#9b59b6'];
                
                if (chartType === 'combined' || chartType === 'pure') {
                    // Á¥îÂàùË®∫„Éá„Éº„Çø
                    top5Regions.forEach((region, index) => {
                        const data = filteredMonths.map(month => {
                            return monthlyData[month].regional.pure[region] || 0;
                        });
                        
                        datasets.push({
                            label: `${region} (Á¥îÂàùË®∫)`,
                            data: data,
                            borderColor: colors[index],
                            backgroundColor: colors[index] + '20',
                            borderWidth: 2,
                            tension: 0.1
                        });
                    });
                }
                
                if (chartType === 'combined' || chartType === 're') {
                    // ÂÜçÂàùË®∫„Éá„Éº„Çø
                    top5Regions.forEach((region, index) => {
                        const data = filteredMonths.map(month => {
                            return monthlyData[month].regional.re[region] || 0;
                        });
                        
                        datasets.push({
                            label: `${region} (ÂÜçÂàùË®∫)`,
                            data: data,
                            borderColor: colors[index],
                            backgroundColor: colors[index] + '40',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            tension: 0.1
                        });
                    });
                }
            } else {
                // ÁâπÂÆöÂú∞Âüü„ÅÆÂ†¥Âêà
                if (chartType === 'combined' || chartType === 'pure') {
                    const pureData = filteredMonths.map(month => {
                        return monthlyData[month].regional.pure[selectedRegion] || 0;
                    });
                    
                    datasets.push({
                        label: `${selectedRegion} (Á¥îÂàùË®∫)`,
                        data: pureData,
                        backgroundColor: 'rgba(52, 152, 219, 0.6)',
                        borderColor: 'rgba(52, 152, 219, 1)',
                        borderWidth: 2,
                        type: 'bar'
                    });
                }
                
                if (chartType === 'combined' || chartType === 're') {
                    const reData = filteredMonths.map(month => {
                        return monthlyData[month].regional.re[selectedRegion] || 0;
                    });
                    
                    datasets.push({
                        label: `${selectedRegion} (ÂÜçÂàùË®∫)`,
                        data: reData,
                        backgroundColor: 'rgba(46, 204, 113, 0.6)',
                        borderColor: 'rgba(46, 204, 113, 1)',
                        borderWidth: 2,
                        type: 'bar'
                    });
                }
            }
            
            regionalChartInstance = new Chart(ctx, {
                type: selectedRegion === 'all' ? 'line' : 'bar',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'ÊÇ£ËÄÖÊï∞Ôºà‰∫∫Ôºâ'
                            }
                        }
                    },
                    plugins: {
                        zoom: {
                            zoom: {
                                wheel: {
                                    enabled: true,
                                },
                                pinch: {
                                    enabled: true
                                },
                                mode: 'x',
                            },
                            pan: {
                                enabled: true,
                                mode: 'x',
                            }
                        }
                    }
                }
            });
        }
        
        // Âú∞ÂüüÂà•„Ç∞„É©„Éï„ÅÆ„Ç∫„Éº„É†„É™„Çª„ÉÉ„Éà
        function resetRegionalZoom() {
            if (regionalChartInstance) {
                regionalChartInstance.resetZoom();
            }
        }
        
        // ÂâçÂπ¥„ÉªÂâçÊúàÊØîËºÉ„Ç∞„É©„Éï
        function updateComparisonChart() {
            const startMonth = document.getElementById('startMonth').value;
            const endMonth = document.getElementById('endMonth').value;
            
            const filteredMonths = Object.keys(monthlyData)
                .filter(month => month >= startMonth && month <= endMonth)
                .sort();
            
            if (filteredMonths.length === 0) return;
            
            const labels = [];
            const monthlyChange = [];
            const yearlyChange = [];
            
            filteredMonths.forEach(month => {
                const [year, mon] = month.split('-');
                labels.push(`${year}Âπ¥${parseInt(mon)}Êúà`);
                
                const currentTotal = monthlyData[month].pureFirst.length + monthlyData[month].reFirst.length;
                
                // ÂâçÊúàÊØî
                const prevMonth = getPreviousMonth(month);
                if (monthlyData[prevMonth]) {
                    const prevTotal = monthlyData[prevMonth].pureFirst.length + monthlyData[prevMonth].reFirst.length;
                    const change = prevTotal > 0 ? ((currentTotal - prevTotal) / prevTotal * 100).toFixed(1) : 0;
                    monthlyChange.push(parseFloat(change));
                } else {
                    monthlyChange.push(null);
                }
                
                // ÂâçÂπ¥ÊØî
                const lastYearMonth = getLastYearMonth(month);
                if (monthlyData[lastYearMonth]) {
                    const lastYearTotal = monthlyData[lastYearMonth].pureFirst.length + monthlyData[lastYearMonth].reFirst.length;
                    const change = lastYearTotal > 0 ? ((currentTotal - lastYearTotal) / lastYearTotal * 100).toFixed(1) : 0;
                    yearlyChange.push(parseFloat(change));
                } else {
                    yearlyChange.push(null);
                }
            });
            
            const ctx = document.getElementById('comparisonCanvas').getContext('2d');
            
            if (comparisonChartInstance) {
                comparisonChartInstance.destroy();
            }
            
            comparisonChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'ÂâçÊúàÊØîÔºà%Ôºâ',
                            data: monthlyChange,
                            borderColor: '#3498db',
                            backgroundColor: 'transparent',
                            borderWidth: 2,
                            tension: 0.1
                        },
                        {
                            label: 'ÂâçÂπ¥ÂêåÊúàÊØîÔºà%Ôºâ',
                            data: yearlyChange,
                            borderColor: '#e74c3c',
                            backgroundColor: 'transparent',
                            borderWidth: 2,
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: 'Â§âÂåñÁéáÔºà%Ôºâ'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y.toFixed(1) + '%';
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Â§ßÈò™Â∏ÇÂå∫Âà•„Ç∞„É©„Éï
        function updateWardChart() {
            const startMonth = document.getElementById('startMonth').value;
            const endMonth = document.getElementById('endMonth').value;
            
            const filteredMonths = Object.keys(monthlyData)
                .filter(month => month >= startMonth && month <= endMonth)
                .sort();
            
            if (filteredMonths.length === 0) return;
            
            // ‰∏ªË¶ÅÂå∫„ÅÆ„ÅøË°®Á§∫Ôºà‰∏ä‰Ωç6Âå∫Ôºâ
            const wardTotals = {};
            
            filteredMonths.forEach(month => {
                const monthRegional = monthlyData[month].regional;
                osakaWards.forEach(ward => {
                    if (!wardTotals[ward]) wardTotals[ward] = 0;
                    wardTotals[ward] += (monthRegional.pure[ward] || 0);
                });
            });
            
            const topWards = Object.entries(wardTotals)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 6)
                .map(([ward]) => ward);
            
            const labels = filteredMonths.map(month => {
                const [year, mon] = month.split('-');
                return `${parseInt(mon)}Êúà`;
            });
            
            const datasets = topWards.map((ward, index) => {
                const data = filteredMonths.map(month => 
                    monthlyData[month].regional.pure[ward] || 0
                );
                
                const colors = [
                    '#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6', '#34495e'
                ];
                
                return {
                    label: ward,
                    data: data,
                    borderColor: colors[index % colors.length],
                    backgroundColor: 'transparent',
                    borderWidth: 2,
                    tension: 0.1
                };
            });
            
            const ctx = document.getElementById('wardCanvas').getContext('2d');
            
            if (wardChartInstance) {
                wardChartInstance.destroy();
            }
            
            wardChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Á¥îÂàùË®∫Êï∞Ôºà‰∫∫Ôºâ'
                            }
                        }
                    }
                }
            });
        }
        
        // „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£Èñ¢Êï∞
        function getPreviousMonth(monthStr) {
            const [year, month] = monthStr.split('-').map(Number);
            const date = new Date(year, month - 2, 1); // month - 1 - 1
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        }
        
        function getLastYearMonth(monthStr) {
            const [year, month] = monthStr.split('-').map(Number);
            return `${year - 1}-${String(month).padStart(2, '0')}`;
        }
        
        function getChangeText(current, previous, label) {
            if (previous === 0) return label + ': -';
            const change = ((current - previous) / previous * 100).toFixed(1);
            const sign = change > 0 ? '+' : '';
            const className = change > 0 ? 'increase' : 'decrease';
            return `${label}: <span class="${className}">${sign}${change}%</span>`;
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }
        
        // „Ç∫„Éº„É†„É™„Çª„ÉÉ„ÉàÈñ¢Êï∞
        function resetZoom() {
            if (currentChart) {
                currentChart.resetZoom();
            }
        }
        
        // „ÇØ„Ç§„ÉÉ„ÇØÈÅ∏ÊäûÈñ¢Êï∞
        function selectLastMonth() {
            const months = Object.keys(monthlyData).sort();
            if (months.length > 0) {
                const lastMonth = months[months.length - 1];
                document.getElementById('startMonth').value = lastMonth;
                document.getElementById('endMonth').value = lastMonth;
                updateAnalysis();
            }
        }
        
        function selectThisYear() {
            const currentYear = new Date().getFullYear();
            const months = Object.keys(monthlyData).filter(m => m.startsWith(currentYear + '-')).sort();
            if (months.length > 0) {
                document.getElementById('startMonth').value = months[0];
                document.getElementById('endMonth').value = months[months.length - 1];
                updateAnalysis();
            }
        }
        
        function selectLastYear() {
            const lastYear = new Date().getFullYear() - 1;
            const months = Object.keys(monthlyData).filter(m => m.startsWith(lastYear + '-')).sort();
            if (months.length > 0) {
                document.getElementById('startMonth').value = months[0];
                document.getElementById('endMonth').value = months[months.length - 1];
                updateAnalysis();
            }
        }
        
        function selectLast3Months() {
            const months = Object.keys(monthlyData).sort();
            if (months.length > 0) {
                const endMonth = months[months.length - 1];
                const startIdx = Math.max(0, months.length - 3);
                document.getElementById('startMonth').value = months[startIdx];
                document.getElementById('endMonth').value = endMonth;
                updateAnalysis();
            }
        }
        
        function selectLast6Months() {
            const months = Object.keys(monthlyData).sort();
            if (months.length > 0) {
                const endMonth = months[months.length - 1];
                const startIdx = Math.max(0, months.length - 6);
                document.getElementById('startMonth').value = months[startIdx];
                document.getElementById('endMonth').value = endMonth;
                updateAnalysis();
            }
        }
        
        function selectAll() {
            const months = Object.keys(monthlyData).sort();
            if (months.length > 0) {
                document.getElementById('startMonth').value = months[0];
                document.getElementById('endMonth').value = months[months.length - 1];
                updateAnalysis();
            }
        }
        
        // „Éá„Éº„Çø„ÇØ„É™„Ç¢Èñ¢Êï∞
        function clearData() {
            if (confirm('„Åô„Åπ„Å¶„ÅÆ„Éá„Éº„Çø„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åô„ÅãÔºü')) {
                // „Éá„Éº„Çø„Çí„ÇØ„É™„Ç¢
                allData = [];
                monthlyData = {};
                
                // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„ÇÇ„ÇØ„É™„Ç¢
                localStorage.removeItem('liberalArtsPatientData');
                
                // „Ç∞„É©„Éï„Ç§„É≥„Çπ„Çø„É≥„Çπ„Çí„ÇØ„É™„Ç¢
                if (currentChart) {
                    currentChart.destroy();
                    currentChart = null;
                }
                if (regionalChartInstance) {
                    regionalChartInstance.destroy();
                    regionalChartInstance = null;
                }
                if (comparisonChartInstance) {
                    comparisonChartInstance.destroy();
                    comparisonChartInstance = null;
                }
                if (wardChartInstance) {
                    wardChartInstance.destroy();
                    wardChartInstance = null;
                }
                
                // UI„ÇíÈùûË°®Á§∫
                document.getElementById('controls').style.display = 'none';
                document.getElementById('summaryCards').style.display = 'none';
                document.getElementById('tabs').style.display = 'none';
                document.getElementById('monthlyChart').style.display = 'none';
                document.getElementById('regionalChart').style.display = 'none';
                document.getElementById('comparisonChart').style.display = 'none';
                document.getElementById('wardChart').style.display = 'none';
                document.getElementById('regionalTable').style.display = 'none';
                document.getElementById('periodComparisonContainer').style.display = 'none';
                document.getElementById('dataInfo').style.display = 'none';
                
                // „Éï„Ç°„Ç§„É´ÂÖ•Âäõ„Çí„É™„Çª„ÉÉ„Éà
                document.getElementById('fileInput').value = '';
            }
        }
        
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }
        
        // ÂàÜÊûêÊõ¥Êñ∞„Éú„Çø„É≥
        function updateAnalysis() {
            updateDisplay();
        }
        
        // ÊúüÈñìÊØîËºÉÊ©üËÉΩ
        function comparePeriods() {
            const period1Start = document.getElementById('period1Start').value;
            const period1End = document.getElementById('period1End').value;
            const period2Start = document.getElementById('period2Start').value;
            const period2End = document.getElementById('period2End').value;
            
            if (!period1Start || !period1End || !period2Start || !period2End) {
                showError('„Åô„Åπ„Å¶„ÅÆÊúüÈñì„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            // ÊúüÈñì1„ÅÆ„Éá„Éº„ÇøÈõÜË®à
            const period1Data = calculatePeriodData(period1Start, period1End);
            // ÊúüÈñì2„ÅÆ„Éá„Éº„ÇøÈõÜË®à
            const period2Data = calculatePeriodData(period2Start, period2End);
            
            // ÁµêÊûúË°®Á§∫
            displayComparisonResults(period1Data, period2Data, period1Start, period1End, period2Start, period2End);
        }
        
        // ÊúüÈñì„Éá„Éº„ÇøÈõÜË®à
        function calculatePeriodData(startMonth, endMonth) {
            let totalPure = 0;
            let totalRe = 0;
            let monthCount = 0;
            const regionalData = {};
            
            Object.keys(monthlyData).forEach(month => {
                if (month >= startMonth && month <= endMonth) {
                    monthCount++;
                    totalPure += monthlyData[month].pureFirst.length;
                    totalRe += monthlyData[month].reFirst.length;
                    
                    // Âú∞ÂüüÂà•ÈõÜË®à
                    const monthRegional = monthlyData[month].regional;
                    Object.keys(monthRegional.pure).forEach(region => {
                        if (!regionalData[region]) {
                            regionalData[region] = { pure: 0, re: 0 };
                        }
                        regionalData[region].pure += monthRegional.pure[region];
                        regionalData[region].re += monthRegional.re[region];
                    });
                    Object.keys(monthRegional.re).forEach(region => {
                        if (!regionalData[region]) {
                            regionalData[region] = { pure: 0, re: 0 };
                        }
                        regionalData[region].re += monthRegional.re[region];
                    });
                }
            });
            
            const total = totalPure + totalRe;
            const pureRate = total > 0 ? (totalPure / total * 100).toFixed(1) : 0;
            const avgPure = monthCount > 0 ? Math.round(totalPure / monthCount) : 0;
            const avgRe = monthCount > 0 ? Math.round(totalRe / monthCount) : 0;
            
            return {
                totalPure,
                totalRe,
                total,
                pureRate,
                avgPure,
                avgRe,
                monthCount,
                regionalData
            };
        }
        
        // ÊØîËºÉÁµêÊûúË°®Á§∫
        function displayComparisonResults(period1, period2, start1, end1, start2, end2) {
            const resultsDiv = document.getElementById('comparisonResults');
            
            // ÊúüÈñì1„ÅÆ„Éï„Ç©„Éº„Éû„ÉÉ„Éà
            const formatPeriod = (start, end) => {
                const [startYear, startMonth] = start.split('-');
                const [endYear, endMonth] = end.split('-');
                return `${startYear}Âπ¥${parseInt(startMonth)}ÊúàÔΩû${endYear}Âπ¥${parseInt(endMonth)}Êúà`;
            };
            
            // Â∑ÆÂàÜË®àÁÆó
            const pureDiff = period2.totalPure - period1.totalPure;
            const reDiff = period2.totalRe - period1.totalRe;
            const totalDiff = period2.total - period1.total;
            const rateDiff = parseFloat(period2.pureRate) - parseFloat(period1.pureRate);
            
            // Â§âÂåñÁéáË®àÁÆó
            const pureChange = period1.totalPure > 0 ? ((pureDiff / period1.totalPure) * 100).toFixed(1) : '-';
            const reChange = period1.totalRe > 0 ? ((reDiff / period1.totalRe) * 100).toFixed(1) : '-';
            const totalChange = period1.total > 0 ? ((totalDiff / period1.total) * 100).toFixed(1) : '-';
            
            // HTMLÁîüÊàê
            resultsDiv.innerHTML = `
                <div class="comparison-card">
                    <h4>ÊúüÈñì1: ${formatPeriod(start1, end1)} (${period1.monthCount}„É∂Êúà)</h4>
                    <div class="comparison-row">
                        <span class="comparison-label">Á¥îÂàùË®∫ÂêàË®à:</span>
                        <span class="comparison-value">${period1.totalPure.toLocaleString()}‰∫∫</span>
                    </div>
                    <div class="comparison-row">
                        <span class="comparison-label">ÂÜçÂàùË®∫ÂêàË®à:</span>
                        <span class="comparison-value">${period1.totalRe.toLocaleString()}‰∫∫</span>
                    </div>
                    <div class="comparison-row">
                        <span class="comparison-label">ÂàùË®∫ÂêàË®à:</span>
                        <span class="comparison-value">${period1.total.toLocaleString()}‰∫∫</span>
                    </div>
                    <div class="comparison-row">
                        <span class="comparison-label">Á¥îÂàùË®∫Áéá:</span>
                        <span class="comparison-value">${period1.pureRate}%</span>
                    </div>
                    <div class="comparison-row">
                        <span class="comparison-label">ÊúàÂπ≥ÂùáÁ¥îÂàùË®∫:</span>
                        <span class="comparison-value">${period1.avgPure.toLocaleString()}‰∫∫</span>
                    </div>
                    <div class="comparison-row">
                        <span class="comparison-label">ÊúàÂπ≥ÂùáÂÜçÂàùË®∫:</span>
                        <span class="comparison-value">${period1.avgRe.toLocaleString()}‰∫∫</span>
                    </div>
                </div>
                
                <div class="comparison-card">
                    <h4>ÊúüÈñì2: ${formatPeriod(start2, end2)} (${period2.monthCount}„É∂Êúà)</h4>
                    <div class="comparison-row">
                        <span class="comparison-label">Á¥îÂàùË®∫ÂêàË®à:</span>
                        <span class="comparison-value">${period2.totalPure.toLocaleString()}‰∫∫</span>
                    </div>
                    <div class="comparison-row">
                        <span class="comparison-label">ÂÜçÂàùË®∫ÂêàË®à:</span>
                        <span class="comparison-value">${period2.totalRe.toLocaleString()}‰∫∫</span>
                    </div>
                    <div class="comparison-row">
                        <span class="comparison-label">ÂàùË®∫ÂêàË®à:</span>
                        <span class="comparison-value">${period2.total.toLocaleString()}‰∫∫</span>
                    </div>
                    <div class="comparison-row">
                        <span class="comparison-label">Á¥îÂàùË®∫Áéá:</span>
                        <span class="comparison-value">${period2.pureRate}%</span>
                    </div>
                    <div class="comparison-row">
                        <span class="comparison-label">ÊúàÂπ≥ÂùáÁ¥îÂàùË®∫:</span>
                        <span class="comparison-value">${period2.avgPure.toLocaleString()}‰∫∫</span>
                    </div>
                    <div class="comparison-row">
                        <span class="comparison-label">ÊúàÂπ≥ÂùáÂÜçÂàùË®∫:</span>
                        <span class="comparison-value">${period2.avgRe.toLocaleString()}‰∫∫</span>
                    </div>
                </div>
                
                <div class="comparison-card" style="background-color: #e8f4f8; border: 2px solid #3498db;">
                    <h4>ÊúüÈñìÊØîËºÉÔºàÊúüÈñì2 - ÊúüÈñì1Ôºâ</h4>
                    <div class="comparison-row">
                        <span class="comparison-label">Á¥îÂàùË®∫Êï∞Â§âÂåñ:</span>
                        <span class="comparison-value ${pureDiff >= 0 ? 'increase' : 'decrease'}">
                            ${pureDiff >= 0 ? '+' : ''}${pureDiff.toLocaleString()}‰∫∫ (${pureChange}%)
                        </span>
                    </div>
                    <div class="comparison-row">
                        <span class="comparison-label">ÂÜçÂàùË®∫Êï∞Â§âÂåñ:</span>
                        <span class="comparison-value ${reDiff >= 0 ? 'increase' : 'decrease'}">
                            ${reDiff >= 0 ? '+' : ''}${reDiff.toLocaleString()}‰∫∫ (${reChange}%)
                        </span>
                    </div>
                    <div class="comparison-row">
                        <span class="comparison-label">ÂàùË®∫ÂêàË®àÂ§âÂåñ:</span>
                        <span class="comparison-value ${totalDiff >= 0 ? 'increase' : 'decrease'}">
                            ${totalDiff >= 0 ? '+' : ''}${totalDiff.toLocaleString()}‰∫∫ (${totalChange}%)
                        </span>
                    </div>
                    <div class="comparison-row">
                        <span class="comparison-label">Á¥îÂàùË®∫ÁéáÂ§âÂåñ:</span>
                        <span class="comparison-value ${rateDiff >= 0 ? 'increase' : 'decrease'}">
                            ${rateDiff >= 0 ? '+' : ''}${rateDiff.toFixed(1)}„Éù„Ç§„É≥„Éà
                        </span>
                    </div>
                </div>
                
                <div class="comparison-card" style="grid-column: 1 / -1;">
                    <h4>Âú∞ÂüüÂà•‰∏ä‰Ωç5Âú∞Âüü„ÅÆÂ§âÂåñ</h4>
                    ${generateRegionalComparison(period1.regionalData, period2.regionalData)}
                </div>
            `;
        }
        
        // Âú∞ÂüüÂà•ÊØîËºÉÁîüÊàê
        function generateRegionalComparison(regional1, regional2) {
            // ÊúüÈñì2„ÅÆÂêàË®à„Åß„ÇΩ„Éº„Éà
            const sortedRegions = Object.keys(regional2)
                .map(region => ({
                    region,
                    total2: (regional2[region].pure || 0) + (regional2[region].re || 0),
                    total1: regional1[region] ? (regional1[region].pure || 0) + (regional1[region].re || 0) : 0
                }))
                .sort((a, b) => b.total2 - a.total2)
                .slice(0, 5);
            
            let html = '<table style="width: 100%; border-collapse: collapse;">';
            html += '<thead><tr style="background-color: #f8f9fa;">';
            html += '<th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">Âú∞Âüü</th>';
            html += '<th style="padding: 10px; text-align: right; border-bottom: 2px solid #ddd;">ÊúüÈñì1</th>';
            html += '<th style="padding: 10px; text-align: right; border-bottom: 2px solid #ddd;">ÊúüÈñì2</th>';
            html += '<th style="padding: 10px; text-align: right; border-bottom: 2px solid #ddd;">Â§âÂåñ</th>';
            html += '</tr></thead><tbody>';
            
            sortedRegions.forEach(item => {
                const change = item.total2 - item.total1;
                const changePercent = item.total1 > 0 ? ((change / item.total1) * 100).toFixed(1) : '-';
                html += '<tr>';
                html += `<td style="padding: 8px; border-bottom: 1px solid #eee;">${item.region}</td>`;
                html += `<td style="padding: 8px; text-align: right; border-bottom: 1px solid #eee;">${item.total1.toLocaleString()}‰∫∫</td>`;
                html += `<td style="padding: 8px; text-align: right; border-bottom: 1px solid #eee;">${item.total2.toLocaleString()}‰∫∫</td>`;
                html += `<td style="padding: 8px; text-align: right; border-bottom: 1px solid #eee;" class="${change >= 0 ? 'increase' : 'decrease'}">`;
                html += `${change >= 0 ? '+' : ''}${change.toLocaleString()}‰∫∫ (${changePercent}%)`;
                html += '</td></tr>';
            });
            
            html += '</tbody></table>';
            return html;
        }
        
        // ÂâäÈô§„Åï„Çå„Åü„Ç®„ÇØ„Çπ„Éù„Éº„ÉàÊ©üËÉΩ
        /*function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'pt', 'a4');
            
            // „Éï„Ç©„É≥„ÉàË®≠ÂÆöÔºàÊó•Êú¨Ë™ûÂØæÂøúÔºâ
            doc.setFont('helvetica');
            
            // „Çø„Ç§„Éà„É´
            doc.setFontSize(18);
            doc.text('„É™„ÉôÂ§ßÁ∑èÂêà„ÇØ„É™„Éã„ÉÉ„ÇØ ÊÇ£ËÄÖÂàÜÊûê„É¨„Éù„Éº„Éà', 40, 40);
            
            // Êó•‰ªòÁØÑÂõ≤
            const startMonth = document.getElementById('startMonth').value;
            const endMonth = document.getElementById('endMonth').value;
            
            if (!startMonth || !endMonth) {
                showError('ÊúüÈñì„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            const [startYear, startMon] = startMonth.split('-');
            const [endYear, endMon] = endMonth.split('-');
            
            doc.setFontSize(12);
            doc.text(`ÂàÜÊûêÊúüÈñì: ${startYear}Âπ¥${parseInt(startMon)}ÊúàÔΩû${endYear}Âπ¥${parseInt(endMon)}Êúà`, 40, 70);
            doc.text(`‰ΩúÊàêÊó•: ${new Date().toLocaleDateString('ja-JP')}`, 40, 90);
            
            // „Çµ„Éû„É™„ÉºÊÉÖÂ†±
            const lastMonth = Object.keys(monthlyData).filter(m => m >= startMonth && m <= endMonth).sort().pop();
            if (lastMonth && monthlyData[lastMonth]) {
                const data = monthlyData[lastMonth];
                const pureCount = data.pureFirst.length;
                const reCount = data.reFirst.length;
                const totalCount = pureCount + reCount;
                const pureRate = totalCount > 0 ? (pureCount / totalCount * 100).toFixed(1) : 0;
                
                doc.setFontSize(14);
                doc.text('ÊúÄÁµÇÊúà„Çµ„Éû„É™„Éº', 40, 120);
                
                const summaryData = [
                    ['È†ÖÁõÆ', 'ÂÄ§'],
                    ['Á¥îÂàùË®∫Êï∞', `${pureCount}‰∫∫`],
                    ['ÂÜçÂàùË®∫Êï∞', `${reCount}‰∫∫`],
                    ['ÂàùË®∫ÂêàË®à', `${totalCount}‰∫∫`],
                    ['Á¥îÂàùË®∫Áéá', `${pureRate}%`]
                ];
                
                doc.autoTable({
                    startY: 140,
                    head: [summaryData[0]],
                    body: summaryData.slice(1),
                    theme: 'grid',
                    styles: { font: 'helvetica' }
                });
            }
            
            // ÊúàÂà•„Éá„Éº„Çø
            const monthlyTableData = [['Êúà', 'Á¥îÂàùË®∫', 'ÂÜçÂàùË®∫', 'ÂêàË®à', 'Á¥îÂàùË®∫Áéá']];
            Object.keys(monthlyData)
                .filter(month => month >= startMonth && month <= endMonth)
                .sort()
                .forEach(month => {
                    const data = monthlyData[month];
                    const pure = data.pureFirst.length;
                    const re = data.reFirst.length;
                    const total = pure + re;
                    const rate = total > 0 ? (pure / total * 100).toFixed(1) : 0;
                    
                    const [year, mon] = month.split('-');
                    monthlyTableData.push([
                        `${year}Âπ¥${parseInt(mon)}Êúà`,
                        pure.toString(),
                        re.toString(),
                        total.toString(),
                        `${rate}%`
                    ]);
                });
            
            if (monthlyTableData.length > 1) {
                doc.addPage();
                doc.setFontSize(14);
                doc.text('ÊúàÂà•Êé®Áßª„Éá„Éº„Çø', 40, 40);
                
                doc.autoTable({
                    startY: 60,
                    head: [monthlyTableData[0]],
                    body: monthlyTableData.slice(1),
                    theme: 'striped',
                    styles: { font: 'helvetica' }
                });
            }
            
            // PDF„Çí‰øùÂ≠ò
            const fileName = `ÊÇ£ËÄÖÂàÜÊûê„É¨„Éù„Éº„Éà_${startMonth}_${endMonth}.pdf`;
            doc.save(fileName);
        }
        
        // ExcelÂá∫ÂäõÊ©üËÉΩ
        function exportToExcel() {
            const wb = XLSX.utils.book_new();
            
            // Êó•‰ªòÁØÑÂõ≤„ÇíÂèñÂæó
            const startMonth = document.getElementById('startMonth').value;
            const endMonth = document.getElementById('endMonth').value;
            
            if (!startMonth || !endMonth) {
                showError('ÊúüÈñì„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            // „Çµ„Éû„É™„Éº„Ç∑„Éº„Éà‰ΩúÊàê
            const summaryData = [];
            summaryData.push(['„É™„ÉôÂ§ßÁ∑èÂêà„ÇØ„É™„Éã„ÉÉ„ÇØ ÊÇ£ËÄÖÂàÜÊûê„É¨„Éù„Éº„Éà']);
            summaryData.push([`ÂàÜÊûêÊúüÈñì: ${startMonth} ÔΩû ${endMonth}`]);
            summaryData.push([`‰ΩúÊàêÊó•: ${new Date().toLocaleDateString('ja-JP')}`]);
            summaryData.push([]);
            
            // ÊúÄÁµÇÊúà„Çµ„Éû„É™„Éº
            const lastMonth = Object.keys(monthlyData).filter(m => m >= startMonth && m <= endMonth).sort().pop();
            if (lastMonth && monthlyData[lastMonth]) {
                const data = monthlyData[lastMonth];
                const pureCount = data.pureFirst.length;
                const reCount = data.reFirst.length;
                const totalCount = pureCount + reCount;
                const pureRate = totalCount > 0 ? (pureCount / totalCount * 100).toFixed(1) : 0;
                
                summaryData.push(['ÊúÄÁµÇÊúà„Çµ„Éû„É™„Éº']);
                summaryData.push(['È†ÖÁõÆ', 'ÂÄ§']);
                summaryData.push(['Á¥îÂàùË®∫Êï∞', `${pureCount}‰∫∫`]);
                summaryData.push(['ÂÜçÂàùË®∫Êï∞', `${reCount}‰∫∫`]);
                summaryData.push(['ÂàùË®∫ÂêàË®à', `${totalCount}‰∫∫`]);
                summaryData.push(['Á¥îÂàùË®∫Áéá', `${pureRate}%`]);
            }
            
            const summarySheet = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, summarySheet, '„Çµ„Éû„É™„Éº');
            
            // ÊúàÂà•Êé®Áßª„Ç∑„Éº„Éà‰ΩúÊàê
            const monthlyData2 = [['Âπ¥Êúà', 'Á¥îÂàùË®∫', 'ÂÜçÂàùË®∫', 'ÂêàË®à', 'Á¥îÂàùË®∫Áéá']];
            Object.keys(monthlyData)
                .filter(month => month >= startMonth && month <= endMonth)
                .sort()
                .forEach(month => {
                    const data = monthlyData[month];
                    const pure = data.pureFirst.length;
                    const re = data.reFirst.length;
                    const total = pure + re;
                    const rate = total > 0 ? (pure / total * 100).toFixed(1) : 0;
                    
                    monthlyData2.push([month, pure, re, total, parseFloat(rate)]);
                });
            
            const monthlySheet = XLSX.utils.aoa_to_sheet(monthlyData2);
            XLSX.utils.book_append_sheet(wb, monthlySheet, 'ÊúàÂà•Êé®Áßª');
            
            // Âú∞ÂüüÂà•ÈõÜË®à„Ç∑„Éº„Éà‰ΩúÊàê
            const regionalData = {};
            Object.keys(monthlyData)
                .filter(month => month >= startMonth && month <= endMonth)
                .forEach(month => {
                    const monthRegional = monthlyData[month].regional;
                    Object.keys(monthRegional.pure).forEach(region => {
                        if (!regionalData[region]) {
                            regionalData[region] = { pure: 0, re: 0 };
                        }
                        regionalData[region].pure += monthRegional.pure[region];
                    });
                    Object.keys(monthRegional.re).forEach(region => {
                        if (!regionalData[region]) {
                            regionalData[region] = { pure: 0, re: 0 };
                        }
                        regionalData[region].re += monthRegional.re[region];
                    });
                });
            
            const regionalArray = [['Âú∞Âüü', 'Á¥îÂàùË®∫', 'ÂÜçÂàùË®∫', 'ÂêàË®à', 'Á¥îÂàùË®∫Áéá']];
            Object.entries(regionalData)
                .sort(([,a], [,b]) => (b.pure + b.re) - (a.pure + a.re))
                .forEach(([region, data]) => {
                    const total = data.pure + data.re;
                    const rate = total > 0 ? (data.pure / total * 100).toFixed(1) : 0;
                    regionalArray.push([region, data.pure, data.re, total, parseFloat(rate)]);
                });
            
            const regionalSheet = XLSX.utils.aoa_to_sheet(regionalArray);
            XLSX.utils.book_append_sheet(wb, regionalSheet, 'Âú∞ÂüüÂà•ÈõÜË®à');
            
            // Excel„Éï„Ç°„Ç§„É´„Çí‰øùÂ≠ò
            const fileName = `ÊÇ£ËÄÖÂàÜÊûê„É¨„Éù„Éº„Éà_${startMonth}_${endMonth}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }
        
        
        // „Çµ„Éû„É™„Éº„É¨„Éù„Éº„ÉàÁîüÊàê
        function generateSummaryReport() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'pt', 'a4');
            
            // Êó•‰ªòÁØÑÂõ≤
            const startMonth = document.getElementById('startMonth').value;
            const endMonth = document.getElementById('endMonth').value;
            
            if (!startMonth || !endMonth) {
                showError('ÊúüÈñì„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            const [startYear, startMon] = startMonth.split('-');
            const [endYear, endMon] = endMonth.split('-');
            
            // „Çø„Ç§„Éà„É´
            doc.setFontSize(20);
            doc.text('ÊÇ£ËÄÖÂàÜÊûê„Çµ„Éû„É™„Éº„É¨„Éù„Éº„Éà', 40, 40);
            
            doc.setFontSize(14);
            doc.text('„É™„ÉôÂ§ßÁ∑èÂêà„ÇØ„É™„Éã„ÉÉ„ÇØ', 40, 65);
            
            doc.setFontSize(12);
            doc.text(`ÂàÜÊûêÊúüÈñì: ${startYear}Âπ¥${parseInt(startMon)}ÊúàÔΩû${endYear}Âπ¥${parseInt(endMon)}Êúà`, 40, 85);
            doc.text(`‰ΩúÊàêÊó•: ${new Date().toLocaleDateString('ja-JP')}`, 40, 105);
            
            // 1. ÊúüÈñìÊ¶ÇË¶Å
            doc.setFontSize(16);
            doc.text('1. ÊúüÈñìÊ¶ÇË¶Å', 40, 140);
            
            const months = Object.keys(monthlyData)
                .filter(month => month >= startMonth && month <= endMonth)
                .sort();
            
            let totalPure = 0;
            let totalRe = 0;
            months.forEach(month => {
                totalPure += monthlyData[month].pureFirst.length;
                totalRe += monthlyData[month].reFirst.length;
            });
            const grandTotal = totalPure + totalRe;
            const avgPureRate = grandTotal > 0 ? (totalPure / grandTotal * 100).toFixed(1) : 0;
            
            doc.setFontSize(12);
            doc.text(`‚Ä¢ ÂàÜÊûêÂØæË±°ÊúàÊï∞: ${months.length}„É∂Êúà`, 60, 165);
            doc.text(`‚Ä¢ Á¥îÂàùË®∫Á∑èÊï∞: ${totalPure.toLocaleString()}‰∫∫`, 60, 185);
            doc.text(`‚Ä¢ ÂÜçÂàùË®∫Á∑èÊï∞: ${totalRe.toLocaleString()}‰∫∫`, 60, 205);
            doc.text(`‚Ä¢ ÂàùË®∫ÂêàË®à: ${grandTotal.toLocaleString()}‰∫∫`, 60, 225);
            doc.text(`‚Ä¢ ÊúüÈñìÂπ≥ÂùáÁ¥îÂàùË®∫Áéá: ${avgPureRate}%`, 60, 245);
            
            // 2. ÊúàÂà•ÂÇæÂêëÂàÜÊûê
            doc.setFontSize(16);
            doc.text('2. ÊúàÂà•ÂÇæÂêëÂàÜÊûê', 40, 280);
            
            // ÊúÄÈ´ò„ÉªÊúÄ‰ΩéÁ¥îÂàùË®∫Áéá
            let maxRate = 0;
            let minRate = 100;
            let maxMonth = '';
            let minMonth = '';
            
            months.forEach(month => {
                const data = monthlyData[month];
                const pure = data.pureFirst.length;
                const re = data.reFirst.length;
                const total = pure + re;
                const rate = total > 0 ? (pure / total * 100) : 0;
                
                if (rate > maxRate) {
                    maxRate = rate;
                    maxMonth = month;
                }
                if (rate < minRate) {
                    minRate = rate;
                    minMonth = month;
                }
            });
            
            doc.setFontSize(12);
            doc.text(`‚Ä¢ ÊúÄÈ´òÁ¥îÂàùË®∫Áéá: ${maxRate.toFixed(1)}% (${maxMonth.replace('-', 'Âπ¥')}Êúà)`, 60, 305);
            doc.text(`‚Ä¢ ÊúÄ‰ΩéÁ¥îÂàùË®∫Áéá: ${minRate.toFixed(1)}% (${minMonth.replace('-', 'Âπ¥')}Êúà)`, 60, 325);
            
            // 3. Âú∞ÂüüÂà•ÂàÜÊûê
            doc.setFontSize(16);
            doc.text('3. Âú∞ÂüüÂà•ÂàÜÊûêÔºà‰∏ä‰Ωç5Âú∞ÂüüÔºâ', 40, 360);
            
            const regionalTotal = {};
            months.forEach(month => {
                const monthRegional = monthlyData[month].regional;
                Object.keys(monthRegional.pure).forEach(region => {
                    if (!regionalTotal[region]) {
                        regionalTotal[region] = { pure: 0, re: 0 };
                    }
                    regionalTotal[region].pure += monthRegional.pure[region];
                    regionalTotal[region].re += monthRegional.re[region];
                });
            });
            
            const topRegions = Object.entries(regionalTotal)
                .map(([region, data]) => ({
                    region,
                    total: data.pure + data.re,
                    pureRate: data.pure + data.re > 0 ? (data.pure / (data.pure + data.re) * 100).toFixed(1) : 0
                }))
                .sort((a, b) => b.total - a.total)
                .slice(0, 5);
            
            doc.setFontSize(12);
            let yPos = 385;
            topRegions.forEach((region, index) => {
                doc.text(`${index + 1}. ${region.region}: ${region.total.toLocaleString()}‰∫∫ (Á¥îÂàùË®∫Áéá: ${region.pureRate}%)`, 60, yPos);
                yPos += 20;
            });
            
            // 4. ÊîπÂñÑÊèêÊ°à
            doc.addPage();
            doc.setFontSize(16);
            doc.text('4. ÊîπÂñÑÊèêÊ°à', 40, 40);
            
            doc.setFontSize(12);
            const suggestions = [];
            
            if (parseFloat(avgPureRate) < 50) {
                suggestions.push('‚Ä¢ Á¥îÂàùË®∫Áéá„Åå50%„Çí‰∏ãÂõû„Å£„Å¶„ÅÑ„Åæ„Åô„ÄÇÊñ∞Ë¶èÊÇ£ËÄÖÁç≤Âæó„ÅÆÊñΩÁ≠ñ„ÇíÊ§úË®é„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            }
            
            if (minRate < 40) {
                suggestions.push('‚Ä¢ ÁâπÂÆöÊúà„ÅÆÁ¥îÂàùË®∫Áéá„Åå40%„Çí‰∏ãÂõû„Å£„Å¶„ÅÑ„Åæ„Åô„ÄÇÂ≠£ÁØÄË¶ÅÂõ†„ÅÆÂàÜÊûê„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ');
            }
            
            const westWardData = regionalTotal['Ë•øÂå∫'];
            if (westWardData) {
                const westTotal = westWardData.pure + westWardData.re;
                const westPercentage = (westTotal / grandTotal * 100).toFixed(1);
                if (parseFloat(westPercentage) < 20) {
                    suggestions.push('‚Ä¢ Âú∞ÂÖÉÔºàË•øÂå∫Ôºâ„Åã„Çâ„ÅÆÊÇ£ËÄÖÊØîÁéá„Åå‰Ωé„ÅÑÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇÂú∞ÂüüÂØÜÁùÄ„ÅÆÊñΩÁ≠ñ„ÇíÊ§úË®é„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                }
            }
            
            if (suggestions.length === 0) {
                suggestions.push('‚Ä¢ ÂÖ®‰ΩìÁöÑ„Å´ËâØÂ•Ω„Å™Êï∞ÂÄ§„ÇíÁ∂≠ÊåÅ„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇÁèæÂú®„ÅÆÊñΩÁ≠ñ„ÇíÁ∂ôÁ∂ö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            }
            
            yPos = 65;
            suggestions.forEach(suggestion => {
                const lines = doc.splitTextToSize(suggestion, 500);
                doc.text(lines, 60, yPos);
                yPos += lines.length * 15 + 10;
            });
            
            // 5. Ê¨°Êúü„Ç¢„ÇØ„Ç∑„Éß„É≥
            doc.setFontSize(16);
            doc.text('5. Êé®Â•®„Ç¢„ÇØ„Ç∑„Éß„É≥', 40, yPos + 30);
            
            doc.setFontSize(12);
            const actions = [
                '1. ÊúàÂà•„ÅÆÁ¥îÂàùË®∫ÁéáÊé®Áßª„ÇíÂÆöÊúüÁöÑ„Å´„É¢„Éã„Çø„É™„É≥„Ç∞',
                '2. ‰ΩéÁ¥îÂàùË®∫ÁéáÊúà„ÅÆË¶ÅÂõ†ÂàÜÊûêÔºàÂ≠£ÁØÄÊÄß„ÄÅ„Ç≠„É£„É≥„Éö„Éº„É≥ÂäπÊûúÁ≠âÔºâ',
                '3. Âú∞ÂüüÂà•„Éû„Éº„Ç±„ÉÜ„Ç£„É≥„Ç∞Êà¶Áï•„ÅÆË¶ãÁõ¥„Åó',
                '4. ÊÇ£ËÄÖÊ∫ÄË∂≥Â∫¶Ë™øÊüª„Å´„Çà„ÇãÂÜçÂàùË®∫Ë¶ÅÂõ†„ÅÆÊääÊè°'
            ];
            
            yPos += 55;
            actions.forEach(action => {
                doc.text(action, 60, yPos);
                yPos += 20;
            });
            
            // PDF„Çí‰øùÂ≠ò
            const fileName = `„Çµ„Éû„É™„Éº„É¨„Éù„Éº„Éà_${startMonth}_${endMonth}.pdf`;
            doc.save(fileName);
        }*/
    </script>
</body>
</html>